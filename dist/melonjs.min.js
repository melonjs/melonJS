/*!
 * melonJS Game Engine - v8.0.1
 * http://www.melonjs.org
 * melonjs is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 * @copyright (C) 2011 - 2020 Olivier Biot
 */
(function(){"use strict";!function(e){var t={};"function"==typeof define&&define.amd?define([],(function(){return{me:t}})):"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),exports.me=t),"undefined"!=typeof window?window.me=t:void 0!==e&&(e.me=t)}(window),"undefined"==typeof console&&(console={log:function(){},info:function(){},error:function(){alert(Array.prototype.slice.call(arguments).join(", "))}}),function(){var e,t=0,i=["ms","moz","webkit","o"],n=window.requestAnimationFrame,r=window.cancelAnimationFrame;for(e=0;e<i.length&&!n;++e)n=window[i[e]+"RequestAnimationFrame"];for(e=0;e<i.length&&!r;++e)r=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];n&&r||(n=function(e){var i=window.performance.now(),n=Math.max(0,1e3/me.timer.maxfps-(i-t)),r=window.setTimeout((function(){e(i+n)}),n);return t=i+n,r},r=function(e){window.clearTimeout(e)},window.requestAnimationFrame=n,window.cancelAnimationFrame=r)}();var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e,t,i){return e(i={path:t,exports:{},require:function(e,t){return commonjsRequire(e,null==t?i.path:t)}},i.exports),i.exports}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var jayExtend=createCommonjsModule((function(e){!function(){function t(e,t,i){Object.keys(i).forEach((function(n){if(t[n]=i[n],"function"!=typeof i[n])throw new TypeError("extend: Method `"+n+"` is not a function");Object.defineProperty(e.prototype,n,{configurable:!0,value:i[n]})}))}function i(e,t,i){return e.prototype[t].apply(this,i)}var n=function(){Object.apply(this,arguments)};(n.prototype=Object.create(Object.prototype)).constructor=n,Object.defineProperty(n,"extend",{value:function e(){for(var n={},r=new Array(arguments.length),s=0;s<arguments.length;s++)r.push(arguments[s]);function o(){return this.init.apply(this,arguments),this}if(o.prototype=Object.create(this.prototype),r.forEach((function(e){t(o,n,e.__methods__||e)})),!("init"in o.prototype))throw new TypeError("extend: Class is missing a constructor named `init`");return Object.defineProperty(o.prototype,"_super",{value:i}),Object.defineProperty(o,"__methods__",{value:n}),o.extend=e,o}}),"undefined"!=typeof window?window.Jay=n:e.exports=n}()})),api,vendors;function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function _createForOfIteratorHelper(e,t){var i;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){i=e[Symbol.iterator]()},n:function(){var e=i.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==i.return||i.return()}finally{if(a)throw s}}}}me.Object=window.Jay,me.agent=(vendors=["ms","MS","moz","webkit","o"],(api={}).prefixed=function(e,t){if(e in(t=t||window))return t[e];var i,n=me.utils.string.capitalize(e);return vendors.some((function(e){var r=e+n;return i=r in t?t[r]:void 0})),i},api.setPrefixed=function(e,t,i){if(e in(i=i||window))i[e]=t;else{var n=me.utils.string.capitalize(e);vendors.some((function(e){var r=e+n;return r in i&&(i[r]=t,!0)}))}},api),me.device=function(){var e={},t=!1,i=!1,n=!0,r=function(e){return e.preventDefault(),"function"==typeof window.scroll&&window.scroll(0,0),!1},s=!1,o=!1,a=[];e._domReady=function(e){if(!o){if(!document.body)return setTimeout(me.device._domReady,13);for(document.removeEventListener&&document.removeEventListener("DOMContentLoaded",me.device._domReady,!1),window.removeEventListener("load",me.device._domReady,!1);a.length;)a.shift().call(window,[]);o=!0}};var h={left:0,top:0,x:0,y:0,width:0,height:0,right:0,bottom:0};e._check=function(){me.device._detectDevice(),me.device.isMobile&&e.enableSwipe(!1),me.device.TouchEvent=!!("ontouchstart"in window),me.device.PointerEvent=!!window.PointerEvent,window.gesture=me.agent.prefixed("gesture"),me.device.touch=me.device.TouchEvent||me.device.PointerEvent,me.device.maxTouchPoints=me.device.touch?me.device.PointerEvent?navigator.maxTouchPoints||1:10:1,me.device.wheel="onwheel"in document.createElement("div"),this.hasPointerLockSupport=me.agent.prefixed("pointerLockElement",document),this.hasPointerLockSupport&&(document.exitPointerLock=me.agent.prefixed("exitPointerLock",document)),me.device.hasDeviceOrientation=!!window.DeviceOrientationEvent,me.device.hasAccelerometer=!!window.DeviceMotionEvent,this.hasFullscreenSupport=me.agent.prefixed("fullscreenEnabled",document)||document.mozFullScreenEnabled,document.exitFullscreen=me.agent.prefixed("cancelFullScreen",document)||me.agent.prefixed("exitFullscreen",document),navigator.vibrate=me.agent.prefixed("vibrate",navigator),this.hasWebAudio=!(!window.AudioContext&&!window.webkitAudioContext);try{e.localStorage=!!window.localStorage}catch(t){e.localStorage=!1}var t,i;window.addEventListener("blur",(function(){me.sys.stopOnBlur&&me.state.stop(!0),me.sys.pauseOnBlur&&me.state.pause(!0)}),!1),window.addEventListener("focus",(function(){me.sys.stopOnBlur&&me.state.restart(!0),me.sys.resumeOnFocus&&me.state.resume(!0),me.sys.autoFocus&&me.device.focus()}),!1),void 0!==document.hidden?(t="hidden",i="visibilitychange"):void 0!==document.mozHidden?(t="mozHidden",i="mozvisibilitychange"):void 0!==document.msHidden?(t="msHidden",i="msvisibilitychange"):void 0!==document.webkitHidden&&(t="webkitHidden",i="webkitvisibilitychange"),"string"==typeof i&&document.addEventListener(i,(function(){document[t]?(me.sys.stopOnBlur&&me.state.stop(!0),me.sys.pauseOnBlur&&me.state.pause(!0)):(me.sys.stopOnBlur&&me.state.restart(!0),me.sys.resumeOnFocus&&me.state.resume(!0))}),!1)},e._detectDevice=function(){me.device.iOS=/iPhone|iPad|iPod/i.test(me.device.ua),me.device.android=/Android/i.test(me.device.ua),me.device.android2=/Android 2/i.test(me.device.ua),me.device.linux=/Linux/i.test(me.device.ua),me.device.chromeOS=/CrOS/.test(me.device.ua),me.device.wp=/Windows Phone/i.test(me.device.ua),me.device.BlackBerry=/BlackBerry/i.test(me.device.ua),me.device.Kindle=/Kindle|Silk.*Mobile Safari/i.test(me.device.ua),me.device.isMobile=/Mobi/i.test(me.device.ua)||me.device.iOS||me.device.android||me.device.wp||me.device.BlackBerry||me.device.Kindle||!1,me.device.ejecta=void 0!==window.ejecta,me.device.isWeixin=/MicroMessenger/i.test(me.device.ua)},e.ua=navigator.userAgent,e.localStorage=!1,e.hasAccelerometer=!1,e.hasDeviceOrientation=!1,e.hasFullscreenSupport=!1,e.hasPointerLockSupport=!1,e.hasWebAudio=!1,e.nativeBase64="function"==typeof window.atob,e.maxTouchPoints=1,e.touch=!1,e.wheel=!1,e.isMobile=!1,e.iOS=!1,e.android=!1,e.android2=!1,e.linux=!1,e.ejecta=!1,e.isWeixin=!1,e.chromeOS=!1,e.wp=!1,e.BlackBerry=!1,e.Kindle=!1,e.accelerationX=0,e.accelerationY=0,e.accelerationZ=0,e.gamma=0,e.beta=0,e.alpha=0,e.language=navigator.language||navigator.browserLanguage||navigator.userLanguage||"en";try{e.OffscreenCanvas=void 0!==window.OffscreenCanvas&&null!==new OffscreenCanvas(0,0).getContext("2d")}catch(t){e.OffscreenCanvas=!1}function l(t){e.accelerationX=t.accelerationIncludingGravity.x,e.accelerationY=t.accelerationIncludingGravity.y,e.accelerationZ=t.accelerationIncludingGravity.z}function u(t){e.gamma=t.gamma,e.beta=t.beta,e.alpha=t.alpha}return e.onReady=function(e){o?e.call(window,[]):(a.push(e),s||("complete"===document.readyState?window.setTimeout(me.device._domReady,0):(document.addEventListener&&document.addEventListener("DOMContentLoaded",me.device._domReady,!1),window.addEventListener("load",me.device._domReady,!1)),s=!0))},e.enableSwipe=function(e){!1!==e?!1===n&&(window.document.removeEventListener("touchmove",r,!1),n=!0):!0===n&&(window.document.addEventListener("touchmove",r,!1),n=!1)},e.requestFullscreen=function(e){this.hasFullscreenSupport&&((e=e||me.video.getParent()).requestFullscreen=me.agent.prefixed("requestFullscreen",e)||e.mozRequestFullScreen,e.requestFullscreen())},e.exitFullscreen=function(){this.hasFullscreenSupport&&document.exitFullscreen()},e.getScreenOrientation=function(){var e=window.screen;if(void 0!==e){var t=me.agent.prefixed("orientation",e);if(void 0!==t&&"string"==typeof t.type)return t.type;if("string"==typeof t)return t}return"number"==typeof window.orientation?90===Math.abs(window.orientation)?"landscape":"portrait":window.outerWidth>window.outerHeight?"landscape":"portrait"},e.lockOrientation=function(e){var t=window.screen;if(void 0!==t){var i=me.agent.prefixed("lockOrientation",t);if(void 0!==i)return i(e)}return!1},e.unlockOrientation=function(e){var t=window.screen;if(void 0!==t){var i=me.agent.prefixed("unlockOrientation",t);if(void 0!==i)return i(e)}return!1},e.isPortrait=function(){return me.device.getScreenOrientation().includes("portrait")},e.isLandscape=function(){return me.device.getScreenOrientation().includes("landscape")},e.getStorage=function(e){switch(e=e||"local"){case"local":return me.save;default:throw new Error("storage type "+e+" not supported")}},e.getParentElement=function(e){var t=me.device.getElement(e);return null!==t.parentNode&&(t=t.parentNode),t},e.getElement=function(e){var t=null;return"undefined"!==e&&("string"==typeof e?t=document.getElementById(e):"object"===_typeof(e)&&e.nodeType===Node.ELEMENT_NODE&&(t=e)),t||(t=document.body),t},e.getElementBounds=function(e){return"object"===_typeof(e)&&e!==document.body&&void 0!==e.getBoundingClientRect?e.getBoundingClientRect():(h.width=h.right=window.innerWidth,h.height=h.bottom=window.innerHeight,h)},e.getParentBounds=function(e){return me.device.getElementBounds(me.device.getParentElement(e))},e.isWebGLSupported=function(e){try{var t=document.createElement("canvas"),i={stencil:!0,failIfMajorPerformanceCaveat:e.failIfMajorPerformanceCaveat};return!(!window.WebGLRenderingContext||!t.getContext("webgl",i)&&!t.getContext("experimental-webgl",i))}catch(e){return!1}},e.getMaxShaderPrecision=function(e){return e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0?"highp":e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"},e.focus=function(){"function"==typeof window.focus&&window.focus()},e.turnOnPointerLock=function(){if(this.hasPointerLockSupport){var e=me.video.getParent();if(me.device.ua.match(/Firefox/i)){var t=function t(){(me.agent.prefixed("fullscreenElement",document)||document.mozFullScreenElement)===e&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),e.requestPointerLock=me.agent.prefixed("requestPointerLock",e),e.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),me.device.requestFullscreen()}else e.requestPointerLock()}},e.turnOffPointerLock=function(){this.hasPointerLockSupport&&document.exitPointerLock()},e.watchAccelerometer=function(){return me.device.hasAccelerometer&&!t&&(DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((function(e){"granted"===e&&(window.addEventListener("devicemotion",l,!1),t=!0)})).catch(console.error):(window.addEventListener("devicemotion",l,!1),t=!0)),t},e.unwatchAccelerometer=function(){t&&(window.removeEventListener("devicemotion",l,!1),t=!1)},e.watchDeviceOrientation=function(){return me.device.hasDeviceOrientation&&!i&&("function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((function(e){"granted"===e&&(window.addEventListener("deviceorientation",u,!1),i=!0)})).catch(console.error):(window.addEventListener("deviceorientation",u,!1),i=!0)),i},e.unwatchDeviceOrientation=function(){i&&(window.removeEventListener("deviceorientation",u,!1),i=!1)},e.vibrate=function(e){navigator.vibrate&&navigator.vibrate(e)},e}(),Object.defineProperty(me.device,"devicePixelRatio",{get:function(){return window.devicePixelRatio||1}}),Object.defineProperty(me.device,"isFullscreen",{get:function(){return!(!me.device.hasFullscreenSupport||!me.agent.prefixed("fullscreenElement",document)&&!document.mozFullScreenElement)}}),Object.defineProperty(me.device,"sound",{get:function(){return me.audio.hasAudio()}});var minpubsub_src=createCommonjsModule((function(e,t){
/*!
    * MinPubSub
    * Copyright(c) 2011 Daniel Lamb <daniellmb.com>
    * MIT Licensed
    */
var i,n,r;i=commonjsGlobal.window,n={},r=i.c_||{},n.publish=function(e,t){for(var n=r[e],s=n?n.length:0;s--;)n[s].apply(i,t||[])},n.subscribe=function(e,t){return r[e]||(r[e]=[]),r[e].push(t),[e,t]},n.unsubscribe=function(e,t){for(var i=r[t?e:e[0]],n=(t=t||e[1],i?i.length:0);n--;)i[n]===t&&i.splice(n,1)},e.exports?e.exports=n:"object"==typeof i&&(i.publish=n.publish,i.subscribe=n.subscribe,i.unsubscribe=n.unsubscribe)}));me.event=function(){var e={STATE_PAUSE:"me.state.onPause",STATE_RESUME:"me.state.onResume",STATE_STOP:"me.state.onStop",STATE_RESTART:"me.state.onRestart",VIDEO_INIT:"me.video.onInit",GAME_INIT:"me.game.onInit",GAME_RESET:"me.game.onReset",GAME_UPDATE:"me.game.onUpdate",LEVEL_LOADED:"me.game.onLevelLoaded",LOADER_COMPLETE:"me.loader.onload",LOADER_PROGRESS:"me.loader.onProgress",KEYDOWN:"me.input.keydown",KEYUP:"me.input.keyup",GAMEPAD_CONNECTED:"gamepad.connected",GAMEPAD_DISCONNECTED:"gamepad.disconnected",GAMEPAD_UPDATE:"gamepad.update",POINTERMOVE:"me.event.pointermove",DRAGSTART:"me.game.dragstart",DRAGEND:"me.game.dragend",WINDOW_ONRESIZE:"window.onresize",CANVAS_ONRESIZE:"canvas.onresize",VIEWPORT_ONRESIZE:"viewport.onresize",WINDOW_ONORIENTATION_CHANGE:"window.orientationchange",WINDOW_ONSCROLL:"window.onscroll",VIEWPORT_ONCHANGE:"viewport.onchange",WEBGL_ONCONTEXT_LOST:"renderer.webglcontextlost",WEBGL_ONCONTEXT_RESTORED:"renderer.webglcontextrestored"};return e.publish=minpubsub_src.publish,e.subscribe=minpubsub_src.subscribe,e.unsubscribe=minpubsub_src.unsubscribe,e}(),me.game=function(){var e={},t=!0,i=!1,n=0,r=1,s=0,o=0,a=0,h=1e3/60,l=0,u=null,c=0;return e.viewport=void 0,e.world=null,e.mergeGroup=!0,e.sortOn="z",e.onLevelLoaded=function(){},e.init=function(){e.world=new me.World,me.event.publish(me.event.GAME_INIT),t=!0},e.reset=function(){void 0!==me.state.current()&&(e.viewport=me.state.current().cameras.get("default")),me.event.publish(me.event.GAME_RESET),e.updateFrameRate()},e.updateFrameRate=function(){n=0,r=~~(.5+60/me.timer.maxfps),h=1e3/e.world.fps,s=0,o=10*h,i=me.timer.maxfps>e.world.fps},e.getParentContainer=function(e){return e.ancestor},e.repaint=function(){t=!0},e.update=function(e,i){if(++n%r==0)for(n=0,me.event.publish(me.event.GAME_UPDATE,[e]),s+=me.timer.getDelta(),s=Math.min(s,o),l=me.timer.interpolation?me.timer.getDelta():h,a=me.timer.interpolation?l:Math.max(l,c);s>=a||me.timer.interpolation;)if(u=window.performance.now(),t=i.update(l)||t,me.timer.lastUpdate=window.performance.now(),c=me.timer.lastUpdate-u,s-=a,me.timer.interpolation){s=0;break}},e.draw=function(e){var n=me.video.renderer;!0===n.isContextValid&&(t||i)&&(n.clear(),e.draw(n),t=!1,n.flush())},e}(),me.version="8.0.1",me.sys={stopOnAudioError:!0,pauseOnBlur:!0,resumeOnFocus:!0,autoFocus:!0,stopOnBlur:!1,preRender:!1},me.initialized=!1,me.skipAutoInit=!1,me.boot=function(){!0!==me.initialized&&(me.device._check(),me.pool.init(),me.save.init(),me.timer.init(),me.loader.setNocache(me.utils.getUriFragment().nocache||!1),me.state.init(),me.input.initKeyboardEvent(),me.levelDirector.init(),me.game.init(),me.initialized=!0,!0===me.skipAutoInit&&me.device._domReady())},me.device.onReady((function(){!1===me.skipAutoInit&&me.boot()})),me.timer=function(){var e={},t=0,i=0,n=0,r=0,s=0,o=0,a=0,h=[],l=0,u=function(e){for(var t=0,i=h.length;t<i;t++)if(h[t].timerId===e){h.splice(t,1);break}},c=function(t){n=r,(s=(r=t)-n)<0&&(s=0),e.tick=s>a&&me.timer.interpolation?s/o:1;for(var i=0,l=h.length;i<l;i++){var u=h[i];u.pauseable&&me.state.isPaused()||(u.elapsed+=s),u.elapsed>=u.delay&&(u.fn.apply(null,u.args),!0===u.repeat?u.elapsed-=u.delay:me.timer.clearTimeout(u.timerId))}};return e.tick=1,e.fps=0,e.maxfps=60,e.interpolation=!1,e.lastUpdate=window.performance.now(),e.init=function(){e.reset(),r=n=0,me.event.subscribe(me.event.GAME_UPDATE,c)},e.reset=function(){n=r=window.performance.now(),s=0,i=0,t=0,o=Math.ceil(1e3/e.maxfps),a=1e3/e.maxfps*1.25},e.setTimeout=function(e,t,i){return h.push({fn:e,delay:t,elapsed:0,repeat:!1,timerId:++l,pauseable:!0===i||!0,args:arguments.length>3?Array.prototype.slice.call(arguments,3):void 0}),l},e.setInterval=function(e,t,i){return h.push({fn:e,delay:t,elapsed:0,repeat:!0,timerId:++l,pauseable:!0===i||!0,args:arguments.length>3?Array.prototype.slice.call(arguments,3):void 0}),l},e.clearTimeout=function(e){me.utils.function.defer(u,this,e)},e.clearInterval=function(e){me.utils.function.defer(u,this,e)},e.getTime=function(){return r},e.getDelta=function(){return s},e.countFPS=function(){t++,i+=s,t%10==0&&(e.fps=me.Math.clamp(Math.round(1e3*t/i),0,e.maxfps),i=0,t=0)},e}(),me.pool=function(){var e={},t={},i=0;return e.init=function(){e.register("me.Entity",me.Entity),e.register("me.CollectableEntity",me.CollectableEntity),e.register("me.LevelEntity",me.LevelEntity),e.register("me.Tween",me.Tween,!0),e.register("me.Color",me.Color,!0),e.register("me.Particle",me.Particle,!0),e.register("me.Sprite",me.Sprite),e.register("me.Text",me.Text,!0),e.register("me.BitmapText",me.BitmapText,!0),e.register("me.BitmapTextData",me.BitmapTextData,!0),e.register("me.ImageLayer",me.ImageLayer,!0),e.register("me.ColorLayer",me.ColorLayer,!0),e.register("me.Vector2d",me.Vector2d,!0),e.register("me.Vector3d",me.Vector3d,!0),e.register("me.ObservableVector2d",me.ObservableVector2d,!0),e.register("me.ObservableVector3d",me.ObservableVector3d,!0),e.register("me.Matrix2d",me.Matrix2d,!0),e.register("me.Matrix3d",me.Matrix3d,!0),e.register("me.Rect",me.Rect,!0),e.register("me.Polygon",me.Polygon,!0),e.register("me.Line",me.Line,!0),e.register("me.Ellipse",me.Ellipse,!0)},e.register=function(e,i,n){if(void 0===i)throw new Error("Cannot register object '"+e+"', invalid class");t[e]={class:i,pool:n?[]:void 0}},e.pull=function(e){for(var n=new Array(arguments.length),r=0;r<arguments.length;r++)n[r]=arguments[r];var s=t[e];if(s){var o,a=s.class,h=s.pool;return h&&(o=h.pop())?(n.shift(),"function"==typeof o.onResetEvent?o.onResetEvent.apply(o,n):o.init.apply(o,n),i--):(n[0]=a,o=new(a.bind.apply(a,n)),h&&(o.className=e)),o}throw new Error("Cannot instantiate object of type '"+e+"'")},e.purge=function(){for(var e in t)t[e]&&(t[e].pool=[]);i=0},e.push=function(e){var n=e.className;void 0!==n&&t[n]&&(t[n].pool.push(e),i++)},e.exists=function(e){return e in t},e.getInstanceCount=function(e){return i},e}(),me.Math=function(){var e={};return e.DEG_TO_RAD=Math.PI/180,e.RAD_TO_DEG=180/Math.PI,e.TAU=2*Math.PI,e.ETA=.5*Math.PI,e.EPSILON=1e-6,e.isPowerOfTwo=function(e){return 0==(e&e-1)},e.nextPowerOfTwo=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},e.degToRad=function(t){return t*e.DEG_TO_RAD},e.radToDeg=function(t){return t*e.RAD_TO_DEG},e.clamp=function(e,t,i){return e<t?t:e>i?i:+e},e.random=function(e,t){return~~(Math.random()*(t-e))+e},e.randomFloat=function(e,t){return Math.random()*(t-e)+e},e.weightedRandom=function(e,t){return~~(Math.pow(Math.random(),2)*(t-e))+e},e.round=function(e,t){var i=Math.pow(10,t||0);return~~(.5+e*i)/i},e.toBeCloseTo=function(e,t,i){return"number"!=typeof i&&(i=2),Math.abs(e-t)<Math.pow(10,-i)/2},e}(),me.Vector2d=me.Object.extend({init:function(e,t){return this.set(e||0,t||0)},_set:function(e,t){return this.x=e,this.y=t,this},set:function(e,t){if(e!==+e||t!==+t)throw new Error("invalid x,y parameters (not a number)");return this._set(e,t)},setZero:function(){return this.set(0,0)},setV:function(e){return this._set(e.x,e.y)},add:function(e){return this._set(this.x+e.x,this.y+e.y)},sub:function(e){return this._set(this.x-e.x,this.y-e.y)},scale:function(e,t){return this._set(this.x*e,this.y*(void 0!==t?t:e))},toIso:function(){return this._set(this.x-this.y,.5*(this.x+this.y))},to2d:function(){return this._set(this.y+this.x/2,this.y-this.x/2)},scaleV:function(e){return this._set(this.x*e.x,this.y*e.y)},div:function(e){return this._set(this.x/e,this.y/e)},abs:function(){return this._set(this.x<0?-this.x:this.x,this.y<0?-this.y:this.y)},clamp:function(e,t){return new me.Vector2d(me.Math.clamp(this.x,e,t),me.Math.clamp(this.y,e,t))},clampSelf:function(e,t){return this._set(me.Math.clamp(this.x,e,t),me.Math.clamp(this.y,e,t))},minV:function(e){return this._set(this.x<e.x?this.x:e.x,this.y<e.y?this.y:e.y)},maxV:function(e){return this._set(this.x>e.x?this.x:e.x,this.y>e.y?this.y:e.y)},floor:function(){return new me.Vector2d(Math.floor(this.x),Math.floor(this.y))},floorSelf:function(){return this._set(Math.floor(this.x),Math.floor(this.y))},ceil:function(){return new me.Vector2d(Math.ceil(this.x),Math.ceil(this.y))},ceilSelf:function(){return this._set(Math.ceil(this.x),Math.ceil(this.y))},negate:function(){return new me.Vector2d(-this.x,-this.y)},negateSelf:function(){return this._set(-this.x,-this.y)},copy:function(e){return this._set(e.x,e.y)},equals:function(e){return this.x===e.x&&this.y===e.y},normalize:function(){return this.div(this.length()||1)},perp:function(){return this._set(this.y,-this.x)},rotate:function(e,t){var i=0,n=0;"object"===_typeof(t)&&(i=t.x,n=t.y);var r=this.x-i,s=this.y-n,o=Math.cos(e),a=Math.sin(e);return this._set(r*o-s*a+i,r*a+s*o+n)},dotProduct:function(e){return this.x*e.x+this.y*e.y},length2:function(){return this.dotProduct(this)},length:function(){return Math.sqrt(this.length2())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},distance:function(e){var t=this.x-e.x,i=this.y-e.y;return Math.sqrt(t*t+i*i)},angle:function(e){return Math.acos(me.Math.clamp(this.dotProduct(e)/(this.length()*e.length()),-1,1))},project:function(e){return this.scale(this.dotProduct(e)/e.length2())},projectN:function(e){return this.scale(this.dotProduct(e))},clone:function(){return me.pool.pull("me.Vector2d",this.x,this.y)},toString:function(){return"x:"+this.x+",y:"+this.y}}),me.Vector3d=me.Object.extend({init:function(e,t,i){return this.set(e||0,t||0,i||0)},_set:function(e,t,i){return this.x=e,this.y=t,this.z=i||0,this},set:function(e,t,i){if(e!==+e||t!==+t||void 0!==i&&i!==+i)throw new Error("invalid x, y, z parameters (not a number)");return this._set(e,t,i)},setZero:function(){return this.set(0,0,0)},setV:function(e){return this._set(e.x,e.y,e.z)},add:function(e){return this._set(this.x+e.x,this.y+e.y,this.z+(e.z||0))},sub:function(e){return this._set(this.x-e.x,this.y-e.y,this.z-(e.z||0))},scale:function(e,t,i){return t=void 0!==t?t:e,this._set(this.x*e,this.y*t,this.z*(i||1))},scaleV:function(e){return this.scale(e.x,e.y,e.z)},toIso:function(){return this._set(this.x-this.y,.5*(this.x+this.y),this.z)},to2d:function(){return this._set(this.y+this.x/2,this.y-this.x/2,this.z)},div:function(e){return this._set(this.x/e,this.y/e,this.z/e)},abs:function(){return this._set(this.x<0?-this.x:this.x,this.y<0?-this.y:this.y,this.z<0?-this.z:this.z)},clamp:function(e,t){return new me.Vector3d(me.Math.clamp(this.x,e,t),me.Math.clamp(this.y,e,t),me.Math.clamp(this.z,e,t))},clampSelf:function(e,t){return this._set(me.Math.clamp(this.x,e,t),me.Math.clamp(this.y,e,t),me.Math.clamp(this.z,e,t))},minV:function(e){var t=e.z||0;return this._set(this.x<e.x?this.x:e.x,this.y<e.y?this.y:e.y,this.z<t?this.z:t)},maxV:function(e){var t=e.z||0;return this._set(this.x>e.x?this.x:e.x,this.y>e.y?this.y:e.y,this.z>t?this.z:t)},floor:function(){return new me.Vector3d(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))},floorSelf:function(){return this._set(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))},ceil:function(){return new me.Vector3d(Math.ceil(this.x),Math.ceil(this.y),Math.ceil(this.z))},ceilSelf:function(){return this._set(Math.ceil(this.x),Math.ceil(this.y),Math.ceil(this.z))},negate:function(){return new me.Vector3d(-this.x,-this.y,-this.z)},negateSelf:function(){return this._set(-this.x,-this.y,-this.z)},copy:function(e){return this._set(e.x,e.y,e.z||0)},equals:function(e){return this.x===e.x&&this.y===e.y&&this.z===(e.z||this.z)},normalize:function(){return this.div(this.length()||1)},perp:function(){return this._set(this.y,-this.x,this.z)},rotate:function(e,t){var i=0,n=0;"object"===_typeof(t)&&(i=t.x,n=t.y);var r=this.x-i,s=this.y-n,o=Math.cos(e),a=Math.sin(e);return this._set(r*o-s*a+i,r*a+s*o+n,this.z)},dotProduct:function(e){return this.x*e.x+this.y*e.y+this.z*(void 0!==e.z?e.z:this.z)},length2:function(){return this.dotProduct(this)},length:function(){return Math.sqrt(this.length2())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},distance:function(e){var t=this.x-e.x,i=this.y-e.y,n=this.z-(e.z||0);return Math.sqrt(t*t+i*i+n*n)},angle:function(e){return Math.acos(me.Math.clamp(this.dotProduct(e)/(this.length()*e.length()),-1,1))},project:function(e){var t=this.dotProduct(e)/e.length2();return this.scale(t,t,t)},projectN:function(e){var t=this.dotProduct(e)/e.length2();return this.scale(t,t,t)},clone:function(){return me.pool.pull("me.Vector3d",this.x,this.y,this.z)},toString:function(){return"x:"+this.x+",y:"+this.y+",z:"+this.z}}),me.ObservableVector2d=me.Vector2d.extend({init:function(e,t,i){if(Object.defineProperty(this,"x",{get:function(){return this._x},set:function(e){var t=this.onUpdate(e,this._y,this._x,this._y);this._x=t&&"x"in t?t.x:e},configurable:!0}),Object.defineProperty(this,"y",{get:function(){return this._y},set:function(e){var t=this.onUpdate(this._x,e,this._x,this._y);this._y=t&&"y"in t?t.y:e},configurable:!0}),void 0===i)throw new Error("undefined `onUpdate` callback");this.setCallback(i.onUpdate),this._x=e||0,this._y=t||0},_set:function(e,t){var i=this.onUpdate(e,t,this._x,this._y);return i&&"x"in i&&"y"in i?(this._x=i.x,this._y=i.y):(this._x=e,this._y=t),this},setMuted:function(e,t){return this._x=e,this._y=t,this},setCallback:function(e){if("function"!=typeof e)throw new Error("invalid `onUpdate` callback");return this.onUpdate=e,this},add:function(e){return this._set(this._x+e.x,this._y+e.y)},sub:function(e){return this._set(this._x-e.x,this._y-e.y)},scale:function(e,t){return this._set(this._x*e,this._y*(void 0!==t?t:e))},scaleV:function(e){return this._set(this._x*e.x,this._y*e.y)},div:function(e){return this._set(this._x/e,this._y/e)},abs:function(){return this._set(this._x<0?-this._x:this._x,this._y<0?-this._y:this._y)},clamp:function(e,t){return new me.ObservableVector2d(me.Math.clamp(this.x,e,t),me.Math.clamp(this.y,e,t),{onUpdate:this.onUpdate})},clampSelf:function(e,t){return this._set(me.Math.clamp(this._x,e,t),me.Math.clamp(this._y,e,t))},minV:function(e){return this._set(this._x<e.x?this._x:e.x,this._y<e.y?this._y:e.y)},maxV:function(e){return this._set(this._x>e.x?this._x:e.x,this._y>e.y?this._y:e.y)},floor:function(){return new me.ObservableVector2d(Math.floor(this._x),Math.floor(this._y),{onUpdate:this.onUpdate})},floorSelf:function(){return this._set(Math.floor(this._x),Math.floor(this._y))},ceil:function(){return new me.ObservableVector2d(Math.ceil(this._x),Math.ceil(this._y),{onUpdate:this.onUpdate})},ceilSelf:function(){return this._set(Math.ceil(this._x),Math.ceil(this._y))},negate:function(){return new me.ObservableVector2d(-this._x,-this._y,{onUpdate:this.onUpdate})},negateSelf:function(){return this._set(-this._x,-this._y)},copy:function(e){return this._set(e.x,e.y)},equals:function(e){return this._x===e.x&&this._y===e.y},perp:function(){return this._set(this._y,-this._x)},rotate:function(e,t){var i=0,n=0;"object"===_typeof(t)&&(i=t.x,n=t.y);var r=this._x-i,s=this._y-n,o=Math.cos(e),a=Math.sin(e);return this._set(r*o-s*a+i,r*a+s*o+n)},dotProduct:function(e){return this._x*e.x+this._y*e.y},lerp:function(e,t){return this._x+=(e.x-this._x)*t,this._y+=(e.y-this._y)*t,this},distance:function(e){return Math.sqrt((this._x-e.x)*(this._x-e.x)+(this._y-e.y)*(this._y-e.y))},clone:function(){return me.pool.pull("me.ObservableVector2d",this._x,this._y,{onUpdate:this.onUpdate})},toVector2d:function(){return me.pool.pull("me.Vector2d",this._x,this._y)},toString:function(){return"x:"+this._x+",y:"+this._y}}),me.ObservableVector3d=me.Vector3d.extend({init:function(e,t,i,n){if(Object.defineProperty(this,"x",{get:function(){return this._x},set:function(e){var t=this.onUpdate(e,this._y,this._z,this._x,this._y,this._z);this._x=t&&"x"in t?t.x:e},configurable:!0}),Object.defineProperty(this,"y",{get:function(){return this._y},set:function(e){var t=this.onUpdate(this._x,e,this._z,this._x,this._y,this._z);this._y=t&&"y"in t?t.y:e},configurable:!0}),Object.defineProperty(this,"z",{get:function(){return this._z},set:function(e){var t=this.onUpdate(this._x,this._y,e,this._x,this._y,this._z);this._z=t&&"z"in t?t.z:e},configurable:!0}),void 0===n)throw new Error("undefined `onUpdate` callback");this.setCallback(n.onUpdate),this._x=e||0,this._y=t||0,this._z=i||0},_set:function(e,t,i){var n=this.onUpdate(e,t,i,this._x,this._y,this._z);return n&&"x"in n&&"y"in n&&"z"in n?(this._x=n.x,this._y=n.y,this._z=n.z):(this._x=e,this._y=t,this._z=i||0),this},setMuted:function(e,t,i){return this._x=e,this._y=t,this._z=i||0,this},setCallback:function(e){if("function"!=typeof e)throw new Error("invalid `onUpdate` callback");return this.onUpdate=e,this},add:function(e){return this._set(this._x+e.x,this._y+e.y,this._z+(e.z||0))},sub:function(e){return this._set(this._x-e.x,this._y-e.y,this._z-(e.z||0))},scale:function(e,t,i){return t=void 0!==t?t:e,this._set(this._x*e,this._y*t,this._z*(i||1))},scaleV:function(e){return this._set(this._x*e.x,this._y*e.y,this._z*(e.z||1))},div:function(e){return this._set(this._x/e,this._y/e,this._z/e)},abs:function(){return this._set(this._x<0?-this._x:this._x,this._y<0?-this._y:this._y,this._Z<0?-this._z:this._z)},clamp:function(e,t){return new me.ObservableVector3d(me.Math.clamp(this._x,e,t),me.Math.clamp(this._y,e,t),me.Math.clamp(this._z,e,t),{onUpdate:this.onUpdate})},clampSelf:function(e,t){return this._set(me.Math.clamp(this._x,e,t),me.Math.clamp(this._y,e,t),me.Math.clamp(this._z,e,t))},minV:function(e){var t=e.z||0;return this._set(this._x<e.x?this._x:e.x,this._y<e.y?this._y:e.y,this._z<t?this._z:t)},maxV:function(e){var t=e.z||0;return this._set(this._x>e.x?this._x:e.x,this._y>e.y?this._y:e.y,this._z>t?this._z:t)},floor:function(){return new me.ObservableVector3d(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z),{onUpdate:this.onUpdate})},floorSelf:function(){return this._set(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))},ceil:function(){return new me.ObservableVector3d(Math.ceil(this._x),Math.ceil(this._y),Math.ceil(this._z),{onUpdate:this.onUpdate})},ceilSelf:function(){return this._set(Math.ceil(this._x),Math.ceil(this._y),Math.ceil(this._z))},negate:function(){return new me.ObservableVector3d(-this._x,-this._y,-this._z,{onUpdate:this.onUpdate})},negateSelf:function(){return this._set(-this._x,-this._y,-this._z)},copy:function(e){return this._set(e.x,e.y,e.z||0)},equals:function(e){return this._x===e.x&&this._y===e.y&&this._z===(e.z||this._z)},perp:function(){return this._set(this._y,-this._x,this._z)},rotate:function(e,t){var i=0,n=0;"object"===_typeof(t)&&(i=t.x,n=t.y);var r=this.x-i,s=this.y-n,o=Math.cos(e),a=Math.sin(e);return this._set(r*o-s*a+i,r*a+s*o+n,this.z)},dotProduct:function(e){return this._x*e.x+this._y*e.y+this._z*(e.z||1)},lerp:function(e,t){return this._x+=(e.x-this._x)*t,this._y+=(e.y-this._y)*t,this._z+=(e.z-this._z)*t,this},distance:function(e){var t=this._x-e.x,i=this._y-e.y,n=this._z-(e.z||0);return Math.sqrt(t*t+i*i+n*n)},clone:function(){return me.pool.pull("me.ObservableVector3d",this._x,this._y,this._z,{onUpdate:this.onUpdate})},toVector3d:function(){return me.pool.pull("me.Vector3d",this._x,this._y,this._z)},toString:function(){return"x:"+this._x+",y:"+this._y+",z:"+this._z}}),me.Matrix2d=me.Object.extend({init:function(){void 0===this.val&&(this.val=new Float32Array(9)),arguments.length&&arguments[0]instanceof me.Matrix2d?this.copy(arguments[0]):arguments.length&&arguments[0]instanceof me.Matrix3d?this.fromMat3d(arguments[0]):arguments.length>=6?this.setTransform.apply(this,arguments):this.identity()},identity:function(){return this.setTransform(1,0,0,0,1,0,0,0,1),this},setTransform:function(){var e=this.val;return 9===arguments.length?(e[0]=arguments[0],e[1]=arguments[1],e[2]=arguments[2],e[3]=arguments[3],e[4]=arguments[4],e[5]=arguments[5],e[6]=arguments[6],e[7]=arguments[7],e[8]=arguments[8]):6===arguments.length&&(e[0]=arguments[0],e[1]=arguments[2],e[2]=arguments[4],e[3]=arguments[1],e[4]=arguments[3],e[5]=arguments[5],e[6]=0,e[7]=0,e[8]=1),this},copy:function(e){return this.val.set(e.val),this},fromMat3d:function(e){e=e.val;var t=this.val;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],this},multiply:function(e){e=e.val;var t=this.val,i=t[0],n=t[1],r=t[3],s=t[4],o=e[0],a=e[1],h=e[3],l=e[4],u=e[6],c=e[7];return t[0]=i*o+r*a,t[1]=n*o+s*a,t[3]=i*h+r*l,t[4]=n*h+s*l,t[6]+=i*u+r*c,t[7]+=n*u+s*c,this},transpose:function(){var e=this.val,t=e[1],i=e[2],n=e[5];return e[1]=e[3],e[2]=e[6],e[3]=t,e[5]=e[7],e[6]=i,e[7]=n,this},invert:function(){var e=this.val,t=e[0],i=e[1],n=e[2],r=e[3],s=e[4],o=e[5],a=e[6],h=e[7],l=e[8],u=l*s-o*h,c=o*a-l*r,d=h*r-s*a,f=t*u+i*c+n*d;return e[0]=u/f,e[1]=(n*h-l*i)/f,e[2]=(o*i-n*s)/f,e[3]=c/f,e[4]=(l*t-n*a)/f,e[5]=(n*r-o*t)/f,e[6]=d/f,e[7]=(i*a-h*t)/f,e[8]=(s*t-i*r)/f,this},apply:function(e){var t=this.val,i=e.x,n=e.y;return e.x=i*t[0]+n*t[3]+t[6],e.y=i*t[1]+n*t[4]+t[7],e},applyInverse:function(e){var t=this.val,i=e.x,n=e.y,r=1/(t[0]*t[4]+t[3]*-t[1]);return e.x=t[4]*r*i+-t[3]*r*n+(t[7]*t[3]-t[6]*t[4])*r,e.y=t[0]*r*n+-t[1]*r*i+(-t[7]*t[0]+t[6]*t[1])*r,e},scale:function(e,t){var i=this.val,n=e,r=void 0===t?n:t;return i[0]*=n,i[1]*=n,i[3]*=r,i[4]*=r,this},scaleV:function(e){return this.scale(e.x,e.y)},scaleX:function(e){return this.scale(e,1)},scaleY:function(e){return this.scale(1,e)},rotate:function(e){if(0!==e){var t=this.val,i=t[0],n=t[1],r=t[2],s=t[3],o=t[4],a=t[5],h=Math.sin(e),l=Math.cos(e);t[0]=l*i+h*s,t[1]=l*n+h*o,t[2]=l*r+h*a,t[3]=l*s-h*i,t[4]=l*o-h*n,t[5]=l*a-h*r}return this},translate:function(e,t){var i=this.val;return i[6]+=i[0]*e+i[3]*t,i[7]+=i[1]*e+i[4]*t,this},translateV:function(e){return this.translate(e.x,e.y)},isIdentity:function(){var e=this.val;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]},equals:function(e){e=e.val;var t=this.val;return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},clone:function(){return me.pool.pull("me.Matrix2d",this)},toArray:function(){return this.val},toString:function(){var e=this.val;return"me.Matrix2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}}),Object.defineProperty(me.Matrix2d.prototype,"tx",{get:function(){return this.val[6]},configurable:!0}),Object.defineProperty(me.Matrix2d.prototype,"ty",{get:function(){return this.val[7]},configurable:!0}),me.Matrix3d=me.Object.extend({init:function(){void 0===this.val&&(this.val=new Float32Array(16)),arguments.length&&arguments[0]instanceof me.Matrix3d?this.copy(arguments[0]):16===arguments.length?this.setTransform.apply(this,arguments):this.identity()},identity:function(){return this.setTransform(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},setTransform:function(e,t,i,n,r,s,o,a,h,l,u,c,d,f,p,m){var g=this.val;return g[0]=e,g[1]=t,g[2]=i,g[3]=n,g[4]=r,g[5]=s,g[6]=o,g[7]=a,g[8]=h,g[9]=l,g[10]=u,g[11]=c,g[12]=d,g[13]=f,g[14]=p,g[15]=m,this},copy:function(e){return this.val.set(e.val),this},multiply:function(e){var t=this.val,i=t[0],n=t[1],r=t[2],s=t[3],o=t[4],a=t[5],h=t[6],l=t[7],u=t[8],c=t[9],d=t[10],f=t[11],p=t[12],m=t[13],g=t[14],v=t[15],y=(e=e.val)[0],_=e[1],x=e[2],w=e[3];return t[0]=y*i+_*o+x*u+w*p,t[1]=y*n+_*a+x*c+w*m,t[2]=y*r+_*h+x*d+w*g,t[3]=y*s+_*l+x*f+w*v,y=e[4],_=e[5],x=e[6],w=e[7],t[4]=y*i+_*o+x*u+w*p,t[5]=y*n+_*a+x*c+w*m,t[6]=y*r+_*h+x*d+w*g,t[7]=y*s+_*l+x*f+w*v,y=e[8],_=e[9],x=e[10],w=e[11],t[8]=y*i+_*o+x*u+w*p,t[9]=y*n+_*a+x*c+w*m,t[10]=y*r+_*h+x*d+w*g,t[11]=y*s+_*l+x*f+w*v,y=e[12],_=e[13],x=e[14],w=e[15],t[12]=y*i+_*o+x*u+w*p,t[13]=y*n+_*a+x*c+w*m,t[14]=y*r+_*h+x*d+w*g,t[15]=y*s+_*l+x*f+w*v,this},transpose:function(){var e=this.val,t=e[1],i=e[2],n=e[3],r=e[6],s=e[7],o=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=t,e[6]=e[9],e[7]=e[13],e[8]=i,e[9]=r,e[11]=e[14],e[12]=n,e[13]=s,e[14]=o,this},invert:function(){var e=this.val,t=e[0],i=e[1],n=e[2],r=e[3],s=e[4],o=e[5],a=e[6],h=e[7],l=e[8],u=e[9],c=e[10],d=e[11],f=e[12],p=e[13],m=e[14],g=e[15],v=t*o-i*s,y=t*a-n*s,_=t*h-r*s,x=i*a-n*o,w=i*h-r*o,b=n*h-r*a,T=l*p-u*f,A=l*m-c*f,E=l*g-d*f,S=u*m-c*p,C=u*g-d*p,P=c*g-d*m,M=v*P-y*C+_*S+x*E-w*A+b*T;return M?(M=1/M,e[0]=(o*P-a*C+h*S)*M,e[1]=(n*C-i*P-r*S)*M,e[2]=(p*b-m*w+g*x)*M,e[3]=(c*w-u*b-d*x)*M,e[4]=(a*E-s*P-h*A)*M,e[5]=(t*P-n*E+r*A)*M,e[6]=(m*_-f*b-g*y)*M,e[7]=(l*b-c*_+d*y)*M,e[8]=(s*C-o*E+h*T)*M,e[9]=(i*E-t*C-r*T)*M,e[10]=(f*w-p*_+g*v)*M,e[11]=(u*_-l*w-d*v)*M,e[12]=(o*A-s*S-a*T)*M,e[13]=(t*S-i*A+n*T)*M,e[14]=(p*y-f*x-m*v)*M,e[15]=(l*x-u*y+c*v)*M,this):null},apply:function(e){var t=this.val,i=e.x,n=e.y,r=e.z,s=t[3]*i+t[7]*n+t[11]*r+t[15]||1;return e.x=(t[0]*i+t[4]*n+t[8]*r+t[12])/s,e.y=(t[1]*i+t[5]*n+t[9]*r+t[13])/s,e.z=(t[2]*i+t[6]*n+t[10]*r+t[14])/s,e},applyInverse:function(e){return e},ortho:function(e,t,i,n,r,s){var o=this.val,a=1/(e-t),h=1/(i-n),l=1/(r-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*h,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*l,o[11]=0,o[12]=(e+t)*a,o[13]=(n+i)*h,o[14]=(s+r)*l,o[15]=1,this},scale:function(e,t,i){var n=this.val,r=e,s=void 0===t?r:t,o=void 0===i?0:i;return n[0]=n[0]*r,n[1]=n[1]*r,n[2]=n[2]*r,n[3]=n[3]*r,n[4]=n[4]*s,n[5]=n[5]*s,n[6]=n[6]*s,n[7]=n[7]*s,n[8]=n[8]*o,n[9]=n[9]*o,n[10]=n[10]*o,n[11]=n[11]*o,this},scaleV:function(e){return this.scale(e.x,e.y,e.z)},scaleX:function(e){return this.scale(e,1)},scaleY:function(e){return this.scale(1,e)},rotate:function(e,t){var i,n,r,s,o,a,h,l,u,c,d,f,p,m,g,v,y,_,x,w,b,T,A,E,S=this.val,C=t.x,P=t.y,M=t.z,R=Math.sqrt(C*C+P*P+M*M);return R<me.Math.EPSILON?null:(C*=R=1/R,P*=R,M*=R,i=Math.sin(e),r=1-(n=Math.cos(e)),s=S[0],o=S[1],a=S[2],h=S[3],l=S[4],u=S[5],c=S[6],d=S[7],f=S[8],p=S[9],m=S[10],g=S[11],v=C*C*r+n,y=P*C*r+M*i,_=M*C*r-P*i,x=C*P*r-M*i,w=P*P*r+n,b=M*P*r+C*i,T=C*M*r+P*i,A=P*M*r-C*i,E=M*M*r+n,S[0]=s*v+l*y+f*_,S[1]=o*v+u*y+p*_,S[2]=a*v+c*y+m*_,S[3]=h*v+d*y+g*_,S[4]=s*x+l*w+f*b,S[5]=o*x+u*w+p*b,S[6]=a*x+c*w+m*b,S[7]=h*x+d*w+g*b,S[8]=s*T+l*A+f*E,S[9]=o*T+u*A+p*E,S[10]=a*T+c*A+m*E,S[11]=h*T+d*A+g*E,this)},translate:function(e,t,i){var n=this.val,r=e,s=void 0===t?r:t,o=void 0===i?0:i;return n[12]=n[0]*r+n[4]*s+n[8]*o+n[12],n[13]=n[1]*r+n[5]*s+n[9]*o+n[13],n[14]=n[2]*r+n[6]*s+n[10]*o+n[14],n[15]=n[3]*r+n[7]*s+n[11]*o+n[15],this},translateV:function(e){return this.translate(e.x,e.y,e.z)},isIdentity:function(){var e=this.val;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]},equals:function(e){e=e.val;var t=this.val;return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},clone:function(){return me.pool.pull("me.Matrix3d",this)},toArray:function(){return this.val},toString:function(){var e=this.val;return"me.Matrix3d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"}}),Object.defineProperty(me.Matrix3d.prototype,"tx",{get:function(){return this.val[12]},configurable:!0}),Object.defineProperty(me.Matrix3d.prototype,"ty",{get:function(){return this.val[13]},configurable:!0}),Object.defineProperty(me.Matrix3d.prototype,"tz",{get:function(){return this.val[14]},configurable:!0}),me.Ellipse=me.Object.extend({init:function(e,t,i,n){this.pos=new me.Vector2d,this._bounds=void 0,this.radius=NaN,this.radiusV=new me.Vector2d,this.radiusSq=new me.Vector2d,this.ratio=new me.Vector2d,this.shapeType="Ellipse",this.setShape(e,t,i,n)},onResetEvent:function(e,t,i,n){this.setShape(e,t,i,n)},setShape:function(e,t,i,n){var r=i/2,s=n/2;this.pos.set(e,t),this.radius=Math.max(r,s),this.ratio.set(r/this.radius,s/this.radius),this.radiusV.set(this.radius,this.radius).scaleV(this.ratio);var o=this.radius*this.radius;return this.radiusSq.set(o,o).scaleV(this.ratio),this.updateBounds(),this},rotate:function(e,t){return this.pos.rotate(e,t),this.updateBounds(),this},scale:function(e,t){return t=void 0!==t?t:e,this.setShape(this.pos.x,this.pos.y,2*this.radiusV.x*e,2*this.radiusV.y*t)},scaleV:function(e){return this.scale(e.x,e.y)},transform:function(){return this},translate:function(e,t){return this.pos.x+=e,this.pos.y+=t,this._bounds.translate(e,t),this},translateV:function(e){return this.pos.add(e),this._bounds.translateV(e),this},containsPointV:function(e){return this.containsPoint(e.x,e.y)},containsPoint:function(e,t){return e-=this.pos.x,t-=this.pos.y,e*e/this.radiusSq.x+t*t/this.radiusSq.y<=1},getBounds:function(){return this._bounds},updateBounds:function(){var e=this.radiusV.x,t=this.radiusV.y,i=this.pos.x-e,n=this.pos.y-t,r=2*e,s=2*t;return this._bounds?this._bounds.setShape(i,n,r,s):this._bounds=new me.Rect(i,n,r,s),this._bounds},clone:function(){return new me.Ellipse(this.pos.x,this.pos.y,2*this.radiusV.x,2*this.radiusV.y)}});var earcut_1=earcut,_default=earcut,deferredRemove,globalFloatingCounter,MIN,MAX,targetV,default_camera,default_settings,ProgressBar,IconLogo,TextLogo,runits,toPX,setContextStyle,measureTextWidth,measureTextHeight,capChars,Glyph;function earcut(e,t,i){i=i||2;var n,r,s,o,a,h,l,u=t&&t.length,c=u?t[0]*i:e.length,d=linkedList(e,0,c,i,!0),f=[];if(!d||d.next===d.prev)return f;if(u&&(d=eliminateHoles(e,t,d,i)),e.length>80*i){n=s=e[0],r=o=e[1];for(var p=i;p<c;p+=i)(a=e[p])<n&&(n=a),(h=e[p+1])<r&&(r=h),a>s&&(s=a),h>o&&(o=h);l=0!==(l=Math.max(s-n,o-r))?1/l:0}return earcutLinked(d,f,i,n,r,l),f}function linkedList(e,t,i,n,r){var s,o;if(r===signedArea(e,t,i,n)>0)for(s=t;s<i;s+=n)o=insertNode(s,e[s],e[s+1],o);else for(s=i-n;s>=t;s-=n)o=insertNode(s,e[s],e[s+1],o);return o&&equals(o,o.next)&&(removeNode(o),o=o.next),o}function filterPoints(e,t){if(!e)return e;t||(t=e);var i,n=e;do{if(i=!1,n.steiner||!equals(n,n.next)&&0!==area(n.prev,n,n.next))n=n.next;else{if(removeNode(n),(n=t=n.prev)===n.next)break;i=!0}}while(i||n!==t);return t}function earcutLinked(e,t,i,n,r,s,o){if(e){!o&&s&&indexCurve(e,n,r,s);for(var a,h,l=e;e.prev!==e.next;)if(a=e.prev,h=e.next,s?isEarHashed(e,n,r,s):isEar(e))t.push(a.i/i),t.push(e.i/i),t.push(h.i/i),removeNode(e),e=h.next,l=h.next;else if((e=h)===l){o?1===o?earcutLinked(e=cureLocalIntersections(filterPoints(e),t,i),t,i,n,r,s,2):2===o&&splitEarcut(e,t,i,n,r,s):earcutLinked(filterPoints(e),t,i,n,r,s,1);break}}}function isEar(e){var t=e.prev,i=e,n=e.next;if(area(t,i,n)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(pointInTriangle(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&area(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function isEarHashed(e,t,i,n){var r=e.prev,s=e,o=e.next;if(area(r,s,o)>=0)return!1;for(var a=r.x<s.x?r.x<o.x?r.x:o.x:s.x<o.x?s.x:o.x,h=r.y<s.y?r.y<o.y?r.y:o.y:s.y<o.y?s.y:o.y,l=r.x>s.x?r.x>o.x?r.x:o.x:s.x>o.x?s.x:o.x,u=r.y>s.y?r.y>o.y?r.y:o.y:s.y>o.y?s.y:o.y,c=zOrder(a,h,t,i,n),d=zOrder(l,u,t,i,n),f=e.prevZ,p=e.nextZ;f&&f.z>=c&&p&&p.z<=d;){if(f!==e.prev&&f!==e.next&&pointInTriangle(r.x,r.y,s.x,s.y,o.x,o.y,f.x,f.y)&&area(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,p!==e.prev&&p!==e.next&&pointInTriangle(r.x,r.y,s.x,s.y,o.x,o.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(;f&&f.z>=c;){if(f!==e.prev&&f!==e.next&&pointInTriangle(r.x,r.y,s.x,s.y,o.x,o.y,f.x,f.y)&&area(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;p&&p.z<=d;){if(p!==e.prev&&p!==e.next&&pointInTriangle(r.x,r.y,s.x,s.y,o.x,o.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.nextZ}return!0}function cureLocalIntersections(e,t,i){var n=e;do{var r=n.prev,s=n.next.next;!equals(r,s)&&intersects(r,n,n.next,s)&&locallyInside(r,s)&&locallyInside(s,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(s.i/i),removeNode(n),removeNode(n.next),n=e=s),n=n.next}while(n!==e);return filterPoints(n)}function splitEarcut(e,t,i,n,r,s){var o=e;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&isValidDiagonal(o,a)){var h=splitPolygon(o,a);return o=filterPoints(o,o.next),h=filterPoints(h,h.next),earcutLinked(o,t,i,n,r,s),void earcutLinked(h,t,i,n,r,s)}a=a.next}o=o.next}while(o!==e)}function eliminateHoles(e,t,i,n){var r,s,o,a=[];for(r=0,s=t.length;r<s;r++)(o=linkedList(e,t[r]*n,r<s-1?t[r+1]*n:e.length,n,!1))===o.next&&(o.steiner=!0),a.push(getLeftmost(o));for(a.sort(compareX),r=0;r<a.length;r++)eliminateHole(a[r],i),i=filterPoints(i,i.next);return i}function compareX(e,t){return e.x-t.x}function eliminateHole(e,t){if(t=findHoleBridge(e,t)){var i=splitPolygon(t,e);filterPoints(t,t.next),filterPoints(i,i.next)}}function findHoleBridge(e,t){var i,n=t,r=e.x,s=e.y,o=-1/0;do{if(s<=n.y&&s>=n.next.y&&n.next.y!==n.y){var a=n.x+(s-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(a<=r&&a>o){if(o=a,a===r){if(s===n.y)return n;if(s===n.next.y)return n.next}i=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!i)return null;if(r===o)return i;var h,l=i,u=i.x,c=i.y,d=1/0;n=i;do{r>=n.x&&n.x>=u&&r!==n.x&&pointInTriangle(s<c?r:o,s,u,c,s<c?o:r,s,n.x,n.y)&&(h=Math.abs(s-n.y)/(r-n.x),locallyInside(n,e)&&(h<d||h===d&&(n.x>i.x||n.x===i.x&&sectorContainsSector(i,n)))&&(i=n,d=h)),n=n.next}while(n!==l);return i}function sectorContainsSector(e,t){return area(e.prev,e,t.prev)<0&&area(t.next,e,e.next)<0}function indexCurve(e,t,i,n){var r=e;do{null===r.z&&(r.z=zOrder(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,sortLinked(r)}function sortLinked(e){var t,i,n,r,s,o,a,h,l=1;do{for(i=e,e=null,s=null,o=0;i;){for(o++,n=i,a=0,t=0;t<l&&(a++,n=n.nextZ);t++);for(h=l;a>0||h>0&&n;)0!==a&&(0===h||!n||i.z<=n.z)?(r=i,i=i.nextZ,a--):(r=n,n=n.nextZ,h--),s?s.nextZ=r:e=r,r.prevZ=s,s=r;i=n}s.nextZ=null,l*=2}while(o>1);return e}function zOrder(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function getLeftmost(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function pointInTriangle(e,t,i,n,r,s,o,a){return(r-o)*(t-a)-(e-o)*(s-a)>=0&&(e-o)*(n-a)-(i-o)*(t-a)>=0&&(i-o)*(s-a)-(r-o)*(n-a)>=0}function isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!intersectsPolygon(e,t)&&(locallyInside(e,t)&&locallyInside(t,e)&&middleInside(e,t)&&(area(e.prev,e,t.prev)||area(e,t.prev,t))||equals(e,t)&&area(e.prev,e,e.next)>0&&area(t.prev,t,t.next)>0)}function area(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function equals(e,t){return e.x===t.x&&e.y===t.y}function intersects(e,t,i,n){var r=sign(area(e,t,i)),s=sign(area(e,t,n)),o=sign(area(i,n,e)),a=sign(area(i,n,t));return r!==s&&o!==a||(!(0!==r||!onSegment(e,i,t))||(!(0!==s||!onSegment(e,n,t))||(!(0!==o||!onSegment(i,e,n))||!(0!==a||!onSegment(i,t,n)))))}function onSegment(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function sign(e){return e>0?1:e<0?-1:0}function intersectsPolygon(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&intersects(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}function locallyInside(e,t){return area(e.prev,e,e.next)<0?area(e,t,e.next)>=0&&area(e,e.prev,t)>=0:area(e,t,e.prev)<0||area(e,e.next,t)<0}function middleInside(e,t){var i=e,n=!1,r=(e.x+t.x)/2,s=(e.y+t.y)/2;do{i.y>s!=i.next.y>s&&i.next.y!==i.y&&r<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}function splitPolygon(e,t){var i=new Node$1(e.i,e.x,e.y),n=new Node$1(t.i,t.x,t.y),r=e.next,s=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,n.next=i,i.prev=n,s.next=n,n.prev=s,n}function insertNode(e,t,i,n){var r=new Node$1(e,t,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Node$1(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function signedArea(e,t,i,n){for(var r=0,s=t,o=i-n;s<i;s+=n)r+=(e[o]-e[s])*(e[s+1]+e[o+1]),o=s;return r}earcut.deviation=function(e,t,i,n){var r=t&&t.length,s=r?t[0]*i:e.length,o=Math.abs(signedArea(e,0,s,i));if(r)for(var a=0,h=t.length;a<h;a++){var l=t[a]*i,u=a<h-1?t[a+1]*i:e.length;o-=Math.abs(signedArea(e,l,u,i))}var c=0;for(a=0;a<n.length;a+=3){var d=n[a]*i,f=n[a+1]*i,p=n[a+2]*i;c+=Math.abs((e[d]-e[p])*(e[f+1]-e[d+1])-(e[d]-e[f])*(e[p+1]-e[d+1]))}return 0===o&&0===c?0:Math.abs((c-o)/o)},earcut.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},n=0,r=0;r<e.length;r++){for(var s=0;s<e[r].length;s++)for(var o=0;o<t;o++)i.vertices.push(e[r][s][o]);r>0&&(n+=e[r-1].length,i.holes.push(n))}return i},earcut_1.default=_default,me.Polygon=me.Object.extend({init:function(e,t,i){this.pos=new me.Vector2d,this._bounds=void 0,this.points=null,this.edges=[],this.indices=[],this.normals=[],this.shapeType="Polygon",this.setShape(e,t,i)},onResetEvent:function(e,t,i){this.setShape(e,t,i)},setShape:function(e,t,i){if(this.pos.set(e,t),!Array.isArray(i))return this;if(i[0]instanceof me.Vector2d)this.points=i;else{var n=this.points=[];if("object"===_typeof(i[0]))i.forEach((function(e){n.push(new me.Vector2d(e.x,e.y))}));else for(var r=0;r<i.length;r+=2)n.push(new me.Vector2d(i[r],i[r+1]))}return this.recalc(),this.updateBounds(),this},transform:function(e){for(var t=this.points,i=t.length,n=0;n<i;n++)e.apply(t[n]);return this.recalc(),this.updateBounds(),this},toIso:function(){return this.rotate(Math.PI/4).scale(Math.SQRT2,Math.SQRT1_2)},to2d:function(){return this.scale(Math.SQRT1_2,Math.SQRT2).rotate(-Math.PI/4)},rotate:function(e,t){if(0!==e){for(var i=this.points,n=i.length,r=0;r<n;r++)i[r].rotate(e,t);this.recalc(),this.updateBounds()}return this},scale:function(e,t){t=void 0!==t?t:e;for(var i=this.points,n=i.length,r=0;r<n;r++)i[r].scale(e,t);return this.recalc(),this.updateBounds(),this},scaleV:function(e){return this.scale(e.x,e.y)},recalc:function(){var e,t=this.edges,i=this.normals,n=this.indices,r=this.points,s=r.length;if(s<3)throw new Error("Requires at least 3 points");for(e=0;e<s;e++)void 0===t[e]&&(t[e]=new me.Vector2d),t[e].copy(r[(e+1)%s]).sub(r[e]),void 0===i[e]&&(i[e]=new me.Vector2d),i[e].copy(t[e]).perp().normalize();return t.length=s,i.length=s,n.length=0,this},getIndices:function(e,t){return 0===this.indices.length&&(this.indices=earcut_1(this.points.flatMap((function(e){return[e.x,e.y]})))),this.indices},translate:function(e,t){return this.pos.x+=e,this.pos.y+=t,this._bounds.translate(e,t),this},translateV:function(e){return this.pos.add(e),this._bounds.translateV(e),this},containsPointV:function(e){return this.containsPoint(e.x,e.y)},containsPoint:function(e,t){for(var i=!1,n=this.pos.x,r=this.pos.y,s=this.points,o=s.length,a=0,h=o-1;a<o;h=a++){var l=s[a].y+r,u=s[a].x+n,c=s[h].y+r,d=s[h].x+n;l>t!=c>t&&e<(d-u)*(t-l)/(c-l)+u&&(i=!i)}return i},getBounds:function(){return this._bounds},updateBounds:function(){return this._bounds||(this._bounds=new me.Rect(0,0,0,0)),this._bounds.setPoints(this.points),this._bounds.translateV(this.pos),this._bounds},clone:function(){var e=[];return this.points.forEach((function(t){e.push(t.clone())})),new me.Polygon(this.pos.x,this.pos.y,e)}}),me.Rect=me.Polygon.extend({init:function(e,t,i,n){void 0===this.center&&(this.center=new me.Vector2d),this.center.set(0,0),this._super(me.Polygon,"init",[e,t,[new me.Vector2d(0,0),new me.Vector2d(i,0),new me.Vector2d(i,n),new me.Vector2d(0,n)]]),this.shapeType="Rectangle"},onResetEvent:function(e,t,i,n){this.setShape(e,t,i,n)},setShape:function(e,t,i,n){var r=i;return 4===arguments.length&&((r=this.points)[0].set(0,0),r[1].set(i,0),r[2].set(i,n),r[3].set(0,n)),this._super(me.Polygon,"setShape",[e,t,r]),this},resize:function(e,t){return this.width=e,this.height=t,this},getBounds:function(){return this},setPoints:function(e){var t=1/0,i=1/0,n=-1/0,r=-1/0;return e.forEach((function(e){t=Math.min(t,e.x),i=Math.min(i,e.y),n=Math.max(n,e.x),r=Math.max(r,e.y)})),this.setShape(t,i,n-t,r-i),this},recalc:function(){return this._super(me.Polygon,"recalc"),this._width=this.points[2].x,this._height=this.points[2].y,this.center.set(this.centerX,this.centerY),this},updateBounds:function(){return this.center.set(this.centerX,this.centerY),this},clone:function(){return new me.Rect(this.pos.x,this.pos.y,this._width,this._height)},copy:function(e){return this.setShape(e.pos.x,e.pos.y,e._width,e._height)},translate:function(e,t){return this.pos.x+=e,this.pos.y+=t,this},translateV:function(e){return this.translate(e.x,e.y)},union:function(e){var t=Math.min(this.left,e.left),i=Math.min(this.top,e.top);return this.resize(Math.max(this.right,e.right)-t,Math.max(this.bottom,e.bottom)-i),this.pos.set(t,i),this},overlaps:function(e){return this.left<e.right&&e.left<this.right&&this.top<e.bottom&&e.top<this.bottom},contains:function(e){return e.left>=this.left&&e.right<=this.right&&e.top>=this.top&&e.bottom<=this.bottom},containsPoint:function(e,t){return e>=this.left&&e<=this.right&&t>=this.top&&t<=this.bottom},equals:function(e){return e.left===this.left&&e.right===this.right&&e.top===this.top&&e.bottom===this.bottom},isFinite:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(){return isFinite(this.pos.x)&&isFinite(this.pos.y)&&isFinite(this._width)&&isFinite(this._height)})),toPolygon:function(){return new me.Polygon(this.pos.x,this.pos.y,this.points)}}),Object.defineProperty(me.Rect.prototype,"left",{get:function(){return this.pos.x},configurable:!0}),Object.defineProperty(me.Rect.prototype,"right",{get:function(){var e=this._width;return this.pos.x+e||e},configurable:!0}),Object.defineProperty(me.Rect.prototype,"top",{get:function(){return this.pos.y},configurable:!0}),Object.defineProperty(me.Rect.prototype,"bottom",{get:function(){var e=this._height;return this.pos.y+e||e},configurable:!0}),Object.defineProperty(me.Rect.prototype,"width",{get:function(){return this._width},set:function(e){this._width!==e&&(this.points[1].x=this.points[2].x=e,this.recalc())},configurable:!0}),Object.defineProperty(me.Rect.prototype,"height",{get:function(){return this._height},set:function(e){this._height!==e&&(this.points[2].y=this.points[3].y=e,this.recalc())},configurable:!0}),Object.defineProperty(me.Rect.prototype,"centerX",{get:function(){return isFinite(this._width)?this.pos.x+this._width/2:this._width},set:function(e){this.pos.x=e-this._width/2,this.center.x=e},configurable:!0}),Object.defineProperty(me.Rect.prototype,"centerY",{get:function(){return isFinite(this._height)?this.pos.y+this._height/2:this._height},set:function(e){this.pos.y=e-this._height/2,this.center.y=e},configurable:!0}),me.Line=me.Polygon.extend({containsPointV:function(e){return this.containsPoint(e.x,e.y)},containsPoint:function(e,t){e-=this.pos.x,t-=this.pos.y;var i=this.points[0],n=this.points[1];return(t-i.y)*(n.x-i.x)==(n.y-i.y)*(e-i.x)},recalc:function(){var e=this.edges,t=this.normals,i=this.indices,n=this.points;if(2!==n.length)throw new Error("Requires exactly 2 points");return void 0===e[0]&&(e[0]=new me.Vector2d),e[0].copy(n[1]).sub(n[0]),void 0===t[0]&&(t[0]=new me.Vector2d),t[0].copy(e[0]).perp().normalize(),i.length=0,this},clone:function(){var e=[];return this.points.forEach((function(t){e.push(t.clone())})),new me.Line(this.pos.x,this.pos.y,e)}}),me.Renderable=me.Rect.extend({init:function(e,t,i,n){this.isRenderable=!0,this.isKinematic=!0,this.body=void 0,void 0===this.currentTransform&&(this.currentTransform=me.pool.pull("me.Matrix2d")),this.currentTransform.identity(),this.GUID=void 0,this.onVisibilityChange=void 0,this.alwaysUpdate=!1,this.updateWhenPaused=!1,this.isPersistent=!1,this.floating=!1,this.anchorPoint instanceof me.ObservableVector2d?this.anchorPoint.setMuted(.5,.5).setCallback(this.onAnchorUpdate.bind(this)):this.anchorPoint=me.pool.pull("me.ObservableVector2d",.5,.5,{onUpdate:this.onAnchorUpdate.bind(this)}),this.autoTransform=!0,this.alpha=1,this.ancestor=void 0,this._bounds instanceof me.Rect?this._bounds.setShape(e,t,i,n):this._bounds=me.pool.pull("me.Rect",e,t,i,n),this.mask=void 0,this.tint=me.pool.pull("me.Color",255,255,255,1),this.name="",this._absPos instanceof me.Vector2d?this._absPos.set(e,t):this._absPos=me.pool.pull("me.Vector2d",e,t),this.pos instanceof me.ObservableVector3d?this.pos.setMuted(e,t,0).setCallback(this.updateBoundsPos.bind(this)):this.pos=me.pool.pull("me.ObservableVector3d",e,t,0,{onUpdate:this.updateBoundsPos.bind(this)}),this.isDirty=!1,this._width=i,this._height=n,this._flip={x:!1,y:!1},this._inViewport=!1,this.shapeType="Rectangle",this.setOpacity(1)},onResetEvent:function(){this.init.apply(this,arguments)},getBounds:function(){return this._bounds},getOpacity:function(){return this.alpha},setOpacity:function(e){"number"==typeof e&&(this.alpha=me.Math.clamp(e,0,1),isNaN(this.alpha)&&(this.alpha=1))},flipX:function(e){return this._flip.x=!!e,this.isDirty=!0,this},flipY:function(e){return this._flip.y=!!e,this.isDirty=!0,this},transform:function(e){var t=this.getBounds();return this.currentTransform.multiply(e),t.setPoints(t.transform(e).points),t.pos.setV(this.pos),this.isDirty=!0,this},angleTo:function(e){var t,i,n=this.getBounds();if(e instanceof me.Renderable){var r=e.getBounds();t=r.centerX-n.centerX,i=r.centerY-n.centerY}else t=e.x-n.centerX,i=e.y-n.centerY;return Math.atan2(i,t)},distanceTo:function(e){var t,i,n=this.getBounds();if(e instanceof me.Renderable){var r=e.getBounds();t=n.centerX-r.centerX,i=n.centerY-r.centerY}else t=n.centerX-e.x,i=n.centerY-e.y;return Math.sqrt(t*t+i*i)},lookAt:function(e){var t;t=e instanceof me.Renderable?e.pos:e;var i=this.angleTo(t);return this.rotate(i),this},rotate:function(e){return isNaN(e)||(this.currentTransform.rotate(e),this.isDirty=!0),this},scale:function(e,t){var i=e,n=void 0===t?i:t;return this.currentTransform.scale(i,n),this.width=this.width*i,this.height=this.height*n,this.isDirty=!0,this},scaleV:function(e){return this.scale(e.x,e.y),this},update:function(){return this.isDirty},updateBoundsPos:function(e,t){var i=this.getBounds();return i.pos.set(e,t,i.pos.z),this.ancestor instanceof me.Container&&!this.floating&&i.pos.add(this.ancestor._absPos),i},onAnchorUpdate:function(){},updateBounds:function(){return console.warn("Deprecated: me.Renderable.updateBounds"),this._super(me.Rect,"updateBounds")},preDraw:function(e){var t=this.getBounds(),i=t.width*this.anchorPoint.x,n=t.height*this.anchorPoint.y;if(e.save(),e.setGlobalAlpha(e.globalAlpha()*this.getOpacity()),this._flip.x||this._flip.y){var r=this._flip.x?this.centerX-i:0,s=this._flip.y?this.centerY-n:0;e.translate(r,s),e.scale(this._flip.x?-1:1,this._flip.y?-1:1),e.translate(-r,-s)}!0!==this.autoTransform||this.currentTransform.isIdentity()||(e.translate(this.pos.x,this.pos.y),e.transform(this.currentTransform),e.translate(-this.pos.x,-this.pos.y)),e.translate(-i,-n),void 0!==this.mask&&e.setMask(this.mask),e.setTint(this.tint)},draw:function(){},postDraw:function(e){void 0!==this.mask&&e.clearMask(),e.clearTint(),this.isDirty=!1,e.restore()},destroy:function(){me.pool.push(this.currentTransform),this.currentTransform=void 0,me.pool.push(this.anchorPoint),this.anchorPoint=void 0,me.pool.push(this.pos),this.pos=void 0,me.pool.push(this._absPos),this._absPos=void 0,me.pool.push(this._bounds),this._bounds=void 0,this.onVisibilityChange=void 0,void 0!==this.mask&&(me.pool.push(this.mask),this.mask=void 0),void 0!==this.tint&&(me.pool.push(this.tint),this.tint=void 0),this.ancestor=void 0,void 0!==this.body&&(this.body.destroy.apply(this.body,arguments),this.body=void 0),me.input.releaseAllPointerEvents(this),this.onDestroyEvent.apply(this,arguments)},onDestroyEvent:function(){}}),Object.defineProperty(me.Renderable.prototype,"inViewport",{get:function(){return this._inViewport},set:function(e){this._inViewport!==e&&(this._inViewport=e,"function"==typeof this.onVisibilityChange&&this.onVisibilityChange.call(this,e))},configurable:!0}),Object.defineProperty(me.Renderable.prototype,"isFlippedX",{get:function(){return!0===this._flip.x},configurable:!0}),Object.defineProperty(me.Renderable.prototype,"isFlippedY",{get:function(){return!0===this._flip.y},configurable:!0}),Object.defineProperty(me.Renderable.prototype,"width",{get:function(){return this._width},set:function(e){this._width!==e&&(this.getBounds().width=e,this._width=e)},configurable:!0}),Object.defineProperty(me.Renderable.prototype,"height",{get:function(){return this._height},set:function(e){this._height!==e&&(this.getBounds().height=e,this._height=e)},configurable:!0}),me.ColorLayer=me.Renderable.extend({init:function(e,t,i){this._super(me.Renderable,"init",[0,0,1/0,1/0]),this.name=e,this.pos.z=i,this.floating=!0,t instanceof me.Color?this.color=t:this.color=me.pool.pull("me.Color").parseCSS(t),this.anchorPoint.set(0,0)},draw:function(e,t){var i=e.getColor(),n=me.game.viewport.pos;e.setColor(this.color),e.fillRect(t.left-n.x,t.top-n.y,t.width,t.height),e.setColor(i)},destroy:function(){me.pool.push(this.color),this.color=void 0,this._super(me.Renderable,"destroy")}}),me.ImageLayer=me.Renderable.extend({init:function(e,t,i){if(this._super(me.Renderable,"init",[e,t,1/0,1/0]),this.image="object"===_typeof(i.image)?i.image:me.loader.getImage(i.image),!this.image)throw new Error(("string"==typeof i.image?"'"+i.image+"'":"Image")+" file for Image Layer '"+this.name+"' not found!");this.imagewidth=this.image.width,this.imageheight=this.image.height,"string"==typeof i.name&&(this.name=i.name),this.floating=!0,this.pos.z=i.z||0,this.offset=me.pool.pull("me.Vector2d",e,t),this.ratio=me.pool.pull("me.Vector2d",1,1),void 0!==i.ratio&&("number"==typeof i.ratio?this.ratio.set(i.ratio,i.ratio):this.ratio.setV(i.ratio)),void 0===i.anchorPoint?this.anchorPoint.set(0,0):"number"==typeof i.anchorPoint?this.anchorPoint.set(i.anchorPoint,i.anchorPoint):this.anchorPoint.setV(i.anchorPoint),Object.defineProperty(this,"repeat",{get:function(){return this._repeat},set:function(e){switch(this._repeat=e,this._repeat){case"no-repeat":this.repeatX=!1,this.repeatY=!1;break;case"repeat-x":this.repeatX=!0,this.repeatY=!1;break;case"repeat-y":this.repeatX=!1,this.repeatY=!0;break;default:this.repeatX=!0,this.repeatY=!0}this.resize(me.game.viewport.width,me.game.viewport.height),this.createPattern()},configurable:!0}),this.repeat=i.repeat||"repeat",me.event.subscribe(me.event.WEBGL_ONCONTEXT_RESTORED,this.createPattern.bind(this))},onActivateEvent:function(){var e=this.updateLayer.bind(this);this.vpChangeHdlr=me.event.subscribe(me.event.VIEWPORT_ONCHANGE,e),this.vpResizeHdlr=me.event.subscribe(me.event.VIEWPORT_ONRESIZE,this.resize.bind(this)),this.vpLoadedHdlr=me.event.subscribe(me.event.LEVEL_LOADED,(function(){e(me.game.viewport.pos)})),!0!==this.ancestor.root&&this.updateLayer(me.game.viewport.pos)},resize:function(e,t){this._super(me.Renderable,"resize",[this.repeatX?1/0:e,this.repeatY?1/0:t])},createPattern:function(){this._pattern=me.video.renderer.createPattern(this.image,this._repeat)},updateLayer:function(e){var t=this.ratio.x,i=this.ratio.y;if(0!==t||0!==i){var n=me.game.viewport,r=this.imagewidth,s=this.imageheight,o=n.bounds.width,a=n.bounds.height,h=this.anchorPoint.x,l=this.anchorPoint.y,u=h*(t-1)*(o-n.width)+this.offset.x-t*e.x,c=l*(i-1)*(a-n.height)+this.offset.y-i*e.y;this.repeatX?this.pos.x=u%r:this.pos.x=u,this.repeatY?this.pos.y=c%s:this.pos.y=c}},preDraw:function(e){e.save(),e.setGlobalAlpha(e.globalAlpha()*this.getOpacity())},draw:function(e){var t=me.game.viewport,i=this.imagewidth,n=this.imageheight,r=t.bounds.width,s=t.bounds.height,o=this.anchorPoint.x,a=this.anchorPoint.y,h=this.pos.x,l=this.pos.y;0===this.ratio.x&&0===this.ratio.y&&(h+=o*(r-i),l+=a*(s-n)),e.translate(h,l),e.drawPattern(this._pattern,0,0,2*t.width,2*t.height)},onDeactivateEvent:function(){me.event.unsubscribe(this.vpChangeHdlr),me.event.unsubscribe(this.vpResizeHdlr),me.event.unsubscribe(this.vpLoadedHdlr)},destroy:function(){me.pool.push(this.offset),this.offset=void 0,me.pool.push(this.ratio),this.ratio=void 0,this._super(me.Renderable,"destroy")}}),me.Sprite=me.Renderable.extend({init:function(e,t,i){if(this.animationpause=!1,this.animationspeed=100,this.offset=me.pool.pull("me.Vector2d",0,0),this.source=null,this.anim={},this.resetAnim=void 0,this.current={name:"default",length:0,offset:new me.Vector2d,width:0,height:0,angle:0,idx:0},this.dt=0,this._flicker={isFlickering:!1,duration:0,callback:null,state:!1},this._super(me.Renderable,"init",[e,t,0,0]),i.image instanceof me.Renderer.prototype.Texture){if(this.source=i.image,this.image=this.source.getTexture(),this.textureAtlas=i.image,void 0!==i.region){var n=this.source.getRegion(i.region);if(!n)throw new Error("Texture - region for "+i.region+" not found");this.setRegion(n),this.current.width=i.framewidth||n.width,this.current.height=i.frameheight||n.height}}else this.image="object"===_typeof(i.image)?i.image:me.loader.getImage(i.image),this.current.width=i.framewidth=i.framewidth||this.image.width,this.current.height=i.frameheight=i.frameheight||this.image.height,this.source=me.video.renderer.cache.get(this.image,i),this.textureAtlas=this.source.getAtlas();void 0!==i.atlas?(this.textureAtlas=i.atlas,this.atlasIndices=i.atlasIndices):this.atlasIndices=null,this.width=this.current.width,this.height=this.current.height,void 0!==i.flipX&&this.flipX(!!i.flipX),void 0!==i.flipY&&this.flipY(!!i.flipY),void 0!==i.rotation&&this.currentTransform.rotate(i.rotation),i.anchorPoint&&this.anchorPoint.set(i.anchorPoint.x,i.anchorPoint.y),"string"==typeof i.name&&(this.name=i.name),0!==this.addAnimation("default",null)&&this.setCurrentAnimation("default"),this.autoTransform=!0},isFlickering:function(){return this._flicker.isFlickering},flicker:function(e,t){return this._flicker.duration=e,this._flicker.duration<=0?(this._flicker.isFlickering=!1,this._flicker.callback=null):this._flicker.isFlickering||(this._flicker.callback=t,this._flicker.isFlickering=!0),this},addAnimation:function(e,t,i){this.anim[e]={name:e,frames:[],idx:0,length:0};var n=0;if("object"!==_typeof(this.textureAtlas))return 0;null==t&&(t=[],Object.keys(this.textureAtlas).forEach((function(e,i){t[i]=i})));for(var r=0,s=t.length;r<s;r++){var o,a=t[r],h=(o="number"==typeof a||"string"==typeof a?{name:a,delay:i||this.animationspeed}:a).name;if("number"==typeof h)void 0!==this.textureAtlas[h]&&(this.anim[e].frames[r]=Object.assign({},this.textureAtlas[h],o),n++);else{if(null===this.atlasIndices)throw new Error("string parameters for addAnimation are not allowed for standard spritesheet based Texture");this.anim[e].frames[r]=Object.assign({},this.textureAtlas[this.atlasIndices[h]],o),n++}}return this.anim[e].length=n,n},setCurrentAnimation:function(e,t,i){if(!this.anim[e])throw new Error("animation id '"+e+"' not defined");return this.current.name=e,this.current.length=this.anim[this.current.name].length,this.resetAnim="string"==typeof t?this.setCurrentAnimation.bind(this,t,null,!0):"function"==typeof t?t:void 0,this.setAnimationFrame(this.current.idx),i||(this.dt=0),this.isDirty=!0,this},reverseAnimation:function(e){return void 0!==e&&void 0!==this.anim[e]?this.anim[e].frames.reverse():this.anim[this.current.name].frames.reverse(),this.isDirty=!0,this},isCurrentAnimation:function(e){return this.current.name===e},setRegion:function(e){return null!==this.source&&(this.image=this.source.getTexture(e)),this.current.offset.setV(e.offset),this.current.angle=e.angle,this.width=this.current.width=e.width,this.height=this.current.height=e.height,e.anchorPoint&&this.anchorPoint.set(this._flip.x&&!0===e.trimmed?1-e.anchorPoint.x:e.anchorPoint.x,this._flip.y&&!0===e.trimmed?1-e.anchorPoint.y:e.anchorPoint.y),this.isDirty=!0,this},setAnimationFrame:function(e){return this.current.idx=(e||0)%this.current.length,this.setRegion(this.getAnimationFrameObjectByIndex(this.current.idx))},getCurrentAnimationFrame:function(){return this.current.idx},getAnimationFrameObjectByIndex:function(e){return this.anim[this.current.name].frames[e]},update:function(e){if(!this.animationpause&&this.current&&this.current.length>0){var t=this.getAnimationFrameObjectByIndex(this.current.idx).delay;for(this.dt+=e;this.dt>=t;){this.isDirty=!0,this.dt-=t;var i=this.current.length>1?this.current.idx+1:this.current.idx;if(this.setAnimationFrame(i),0===this.current.idx&&"function"==typeof this.resetAnim&&!1===this.resetAnim()){this.setAnimationFrame(this.current.length-1),this.dt%=t;break}t=this.getAnimationFrameObjectByIndex(this.current.idx).delay}}return this._flicker.isFlickering&&(this._flicker.duration-=e,this._flicker.duration<0&&("function"==typeof this._flicker.callback&&this._flicker.callback(),this.flicker(-1)),this.isDirty=!0),this.isDirty},updateBoundsPos:function(e,t){var i=this.getBounds();return i.pos.set(e-this.anchorPoint.x*i.width,t-this.anchorPoint.y*i.height),this.ancestor instanceof me.Container&&!this.floating&&i.pos.add(this.ancestor._absPos),i},onAnchorUpdate:function(e,t){this.anchorPoint.setMuted(e,t),this.updateBoundsPos(this.pos.x,this.pos.y)},destroy:function(){me.pool.push(this.offset),this.offset=void 0,this._super(me.Renderable,"destroy")},draw:function(e){if(!this._flicker.isFlickering||(this._flicker.state=!this._flicker.state,this._flicker.state)){var t=this.current,i=this.pos.x,n=this.pos.y,r=t.width,s=t.height,o=t.offset,a=this.offset;0!==t.angle&&(e.translate(-i,-n),e.rotate(t.angle),i-=s,r=t.height,s=t.width),e.drawImage(this.image,a.x+o.x,a.y+o.y,r,s,i,n,r,s)}}}),me.GUI_Object=me.Sprite.extend({init:function(e,t,i){this.isClickable=!0,this.holdThreshold=250,this.isHoldable=!1,this.hover=!1,this.holdTimeout=null,this.updated=!1,this.released=!0,this._super(me.Sprite,"init",[e,t,i]),this.floating=!0,this.isKinematic=!1},update:function(e){var t=this._super(me.Sprite,"update",[e]);return this.updated?(this.released||(this.updated=!1),!0):t},clicked:function(e){if(0===e.button&&this.isClickable)return this.updated=!0,this.released=!1,this.isHoldable&&(null!==this.holdTimeout&&me.timer.clearTimeout(this.holdTimeout),this.holdTimeout=me.timer.setTimeout(this.hold.bind(this),this.holdThreshold,!1),this.released=!1),this.onClick.call(this,e)},onClick:function(){return!1},enter:function(e){return this.hover=!0,this.onOver.call(this,e)},onOver:function(){},leave:function(e){return this.hover=!1,this.release.call(this,e),this.onOut.call(this,e)},onOut:function(){},release:function(e){if(!1===this.released)return this.released=!0,me.timer.clearTimeout(this.holdTimeout),this.onRelease.call(this,e)},onRelease:function(){return!1},hold:function(){me.timer.clearTimeout(this.holdTimeout),this.released||this.onHold.call(this)},onHold:function(){},onActivateEvent:function(){me.input.registerPointerEvent("pointerdown",this,this.clicked.bind(this)),me.input.registerPointerEvent("pointerup",this,this.release.bind(this)),me.input.registerPointerEvent("pointercancel",this,this.release.bind(this)),me.input.registerPointerEvent("pointerenter",this,this.enter.bind(this)),me.input.registerPointerEvent("pointerleave",this,this.leave.bind(this))},onDeactivateEvent:function(){me.input.releasePointerEvent("pointerdown",this),me.input.releasePointerEvent("pointerup",this),me.input.releasePointerEvent("pointercancel",this),me.input.releasePointerEvent("pointerenter",this),me.input.releasePointerEvent("pointerleave",this),me.timer.clearTimeout(this.holdTimeout)}}),deferredRemove=function(e,t){this.removeChildNow(e,t)},globalFloatingCounter=0,me.Container=me.Renderable.extend({init:function(e,t,i,n,r){this.pendingSort=null,this._super(me.Renderable,"init",[e||0,t||0,i||1/0,n||1/0]),this.root=r||!1,this.children=[],this.sortOn=me.game.sortOn,this.autoSort=!0,this.autoDepth=!0,this.clipping=!1,this.onChildChange=function(){},this.drawCount=0,this.childBounds=this.getBounds().clone(),this.autoTransform=!0,this.isKinematic=!1,!0===this.root&&me.event.subscribe(me.event.CANVAS_ONRESIZE,this.updateChildBounds.bind(this))},reset:function(){this.pendingSort&&(clearTimeout(this.pendingSort),this.pendingSort=null);for(var e,t=this.children.length;t>=0;e=this.children[--t])e&&!e.isPersistent&&this.removeChildNow(e);void 0!==this.currentTransform&&this.currentTransform.identity()},addChild:function(e,t){return e.ancestor instanceof me.Container?e.ancestor.removeChildNow(e):e.isRenderable&&(e.GUID=me.utils.createGUID(e.id)),e.ancestor=this,this.children.push(e),void 0!==e.pos&&("number"==typeof t?e.pos.z=t:!0===this.autoDepth&&(e.pos.z=this.children.length)),!0===this.autoSort&&this.sort(),"function"==typeof e.onActivateEvent&&this.isAttachedToRoot()&&e.onActivateEvent(),!0===this.isAttachedToRoot()&&me.game.repaint(),this.onChildChange.call(this,this.children.length-1),e},addChildAt:function(e,t){if(t>=0&&t<this.children.length)return e.ancestor instanceof me.Container?e.ancestor.removeChildNow(e):e.isRenderable&&(e.GUID=me.utils.createGUID()),e.ancestor=this,this.children.splice(t,0,e),"function"==typeof e.onActivateEvent&&this.isAttachedToRoot()&&e.onActivateEvent(),!0===this.isAttachedToRoot()&&me.game.repaint(),this.onChildChange.call(this,t),e;throw new Error("Index ("+t+") Out Of Bounds for addChildAt()")},forEach:function(e,t){var i=this,n=0,r=this.children.length;if("function"!=typeof e)throw new Error(e+" is not a function");for(arguments.length>1&&(i=t);n<r;)e.call(i,this.children[n],n,this.children),n++},swapChildren:function(e,t){var i=this.getChildIndex(e),n=this.getChildIndex(t);if(-1===i||-1===n)throw new Error(e+" Both the supplied childs must be a child of the caller "+this);var r=e.pos.z;e.pos.z=t.pos.z,t.pos.z=r,this.children[i]=t,this.children[n]=e},getChildAt:function(e){if(e>=0&&e<this.children.length)return this.children[e];throw new Error("Index ("+e+") Out Of Bounds for getChildAt()")},getChildIndex:function(e){return this.children.indexOf(e)},getNextChild:function(e){var t=this.children.indexOf(e)-1;if(t>=0&&t<this.children.length)return this.getChildAt(t)},hasChild:function(e){return this===e.ancestor},getChildByProp:function(e,t){var i=[];function n(e,n){var r=e[n];t instanceof RegExp&&"string"==typeof r?t.test(r)&&i.push(e):r===t&&i.push(e)}for(var r=this.children.length-1;r>=0;r--){var s=this.children[r];n(s,e),s instanceof me.Container&&(i=i.concat(s.getChildByProp(e,t)))}return i},getChildByType:function(e){for(var t=[],i=this.children.length-1;i>=0;i--){var n=this.children[i];n instanceof e&&t.push(n),n instanceof me.Container&&(t=t.concat(n.getChildByType(e)))}return t},getChildByName:function(e){return this.getChildByProp("name",e)},getChildByGUID:function(e){var t=this.getChildByProp("GUID",e);return t.length>0?t[0]:null},updateChildBounds:function(){var e;this.childBounds.pos.set(1/0,1/0),this.childBounds.resize(-1/0,-1/0);for(var t,i=this.children.length;i--,t=this.children[i];)t.isRenderable&&null!==(e=t instanceof me.Container?t.childBounds:t.getBounds())&&this.childBounds.union(e);return this.childBounds},isAttachedToRoot:function(){if(!0===this.root)return!0;for(var e=this.ancestor;e;){if(!0===e.root)return!0;e=e.ancestor}return!1},updateBoundsPos:function(e,t){this._super(me.Renderable,"updateBoundsPos",[e,t]),this._absPos.set(e,t),this.ancestor instanceof me.Container&&!this.floating&&this._absPos.add(this.ancestor._absPos);for(var i,n=this.children.length;n--,i=this.children[n];)i.isRenderable&&i.updateBoundsPos(i.pos.x,i.pos.y);return this.getBounds()},onActivateEvent:function(){for(var e,t=this.children.length;t--,e=this.children[t];)"function"==typeof e.onActivateEvent&&e.onActivateEvent()},removeChild:function(e,t){if(!this.hasChild(e))throw new Error("Child is not mine.");me.utils.function.defer(deferredRemove,this,e,t)},removeChildNow:function(e,t){if(this.hasChild(e)&&this.getChildIndex(e)>=0){"function"==typeof e.onDeactivateEvent&&e.onDeactivateEvent(),t||("function"==typeof e.destroy&&e.destroy(),me.pool.push(e));var i=this.getChildIndex(e);i>=0&&(this.children.splice(i,1),e.ancestor=void 0),!0===this.isAttachedToRoot()&&me.game.repaint(),this.onChildChange.call(this,i)}},setChildsProperty:function(e,t,i){for(var n=this.children.length;n>=0;n--){var r=this.children[n];!0===i&&r instanceof me.Container&&r.setChildsProperty(e,t,i),r[e]=t}},moveUp:function(e){var t=this.getChildIndex(e);t-1>=0&&this.swapChildren(e,this.getChildAt(t-1))},moveDown:function(e){var t=this.getChildIndex(e);t>=0&&t+1<this.children.length&&this.swapChildren(e,this.getChildAt(t+1))},moveToTop:function(e){var t=this.getChildIndex(e);t>0&&(this.children.splice(0,0,this.children.splice(t,1)[0]),e.pos.z=this.children[1].pos.z+1)},moveToBottom:function(e){var t=this.getChildIndex(e);t>=0&&t<this.children.length-1&&(this.children.splice(this.children.length-1,0,this.children.splice(t,1)[0]),e.pos.z=this.children[this.children.length-2].pos.z-1)},sort:function(e){if(!this.pendingSort){if(!0===e)for(var t,i=this.children.length;i--,t=this.children[i];)t instanceof me.Container&&t.sort(e);this.pendingSort=me.utils.function.defer((function(e){e.children.sort(e["_sort"+e.sortOn.toUpperCase()]),e.pendingSort=null,me.game.repaint()}),this,this)}},onDeactivateEvent:function(){for(var e,t=this.children.length;t--,e=this.children[t];)"function"==typeof e.onDeactivateEvent&&e.onDeactivateEvent()},_sortZ:function(e,t){return t.pos&&e.pos?t.pos.z-e.pos.z:e.pos?-1/0:1/0},_sortReverseZ:function(e,t){return e.pos&&t.pos?e.pos.z-t.pos.z:e.pos?1/0:-1/0},_sortX:function(e,t){if(!t.pos||!e.pos)return e.pos?-1/0:1/0;var i=t.pos.z-e.pos.z;return i||t.pos.x-e.pos.x},_sortY:function(e,t){if(!t.pos||!e.pos)return e.pos?-1/0:1/0;var i=t.pos.z-e.pos.z;return i||t.pos.y-e.pos.y},destroy:function(){this.reset(),this._super(me.Renderable,"destroy",arguments)},update:function(e){this._super(me.Renderable,"update",[e]);var t=!1,i=!1,n=me.state.isPaused();this._absPos.setV(this.pos),this.ancestor&&this._absPos.add(this.ancestor._absPos);for(var r,s=this.children.length;s--,r=this.children[s];)n&&!r.updateWhenPaused||(r.isRenderable?((i=globalFloatingCounter>0||r.floating)&&globalFloatingCounter++,r.inViewport=!1,me.state.current().cameras.forEach((function(e){e.isVisible(r,i)&&(r.inViewport=!0)})),t=(r.inViewport||r.alwaysUpdate)&&r.update(e)||t,r._absPos.setV(this._absPos).add(r.pos),globalFloatingCounter>0&&globalFloatingCounter--):t=r.update(e)||t);return t},draw:function(e,t){var i=!1;this.drawCount=0,!1===this.root&&!0===this.clipping&&!0===this.childBounds.isFinite()&&e.clipRect(this.childBounds.pos.x,this.childBounds.pos.y,this.childBounds.width,this.childBounds.height),e.translate(this.pos.x,this.pos.y);for(var n,r=this.children.length;r--,n=this.children[r];)n.isRenderable&&(i=!0===n.floating,(n.inViewport||i)&&(i&&(e.save(),e.resetTransform()),n.preDraw(e),n.draw(e,t),n.postDraw(e),i&&e.restore(),this.drawCount++))}}),me.Body=me.Rect.extend({init:function(e,t,i){if(this.ancestor=e,void 0===this.shapes&&(this.shapes=[]),this.collisionMask=me.collision.types.ALL_OBJECT,this.collisionType=me.collision.types.ENEMY_OBJECT,void 0===this.vel&&(this.vel=new me.Vector2d),this.vel.set(0,0),void 0===this.accel&&(this.accel=new me.Vector2d),this.accel.set(0,0),void 0===this.force&&(this.force=new me.Vector2d),this.force.set(0,0),void 0===this.friction&&(this.friction=new me.Vector2d),this.friction.set(0,0),this.bounce=0,this.mass=1,void 0===this.maxVel&&(this.maxVel=new me.Vector2d),this.maxVel.set(490,490),void 0===this.gravity){var n=this;this.gravity=new me.ObservableVector2d(0,0,{onUpdate:function(e,t){"number"==typeof t&&(n.gravityScale=t/me.game.world.gravity.y),console.log("me.Body.gravity is deprecated, please see me.Body.gravityScale to modify gravity for a specific body")}})}if(this.gravityScale=1,this.ignoreGravity=!1,this.falling=!1,this.jumping=!1,this._super(me.Rect,"init",[0,0,this.ancestor.width,this.ancestor.height]),"function"==typeof i&&(this.onBodyUpdate=i),void 0!==t)if(Array.isArray(t)){for(var r=0;r<t.length;r++)this.addShape(t[r],!0);this.updateBounds()}else this.addShape(t);this.ancestor.isKinematic=!1},addShape:function(e,t){return e instanceof me.Rect?this.shapes.push(e.toPolygon()):e instanceof me.Polygon||e instanceof me.Ellipse?this.shapes.push(e):this.fromJSON(e),!0!==t&&this.updateBounds(),this.shapes.length},setVertices:function(e,t,i){var n=this.getShape(t);n instanceof me.Polygon?n.setShape(0,0,e):this.shapes[t||0]=new me.Polygon(0,0,e),!0!==i&&this.updateBounds()},fromJSON:function(e,t){var i=e;if(void 0!==t&&e[t],void 0===i)throw new Error("Identifier ("+t+") undefined for the given JSON object)");if(i.length){for(var n=0;n<i.length;n++)this.setVertices(i[n].shape,n);this.mass=i[0].density||0,this.friction.set(i[0].friction||0,i[0].friction||0),this.bounce=i[0].bounce||0}return i.length},getShape:function(e){return this.shapes[e||0]},removeShape:function(e){return me.utils.array.remove(this.shapes,e),this.updateBounds(),this.shapes.length},removeShapeAt:function(e){return this.removeShape(this.getShape(e))},setCollisionMask:function(e){this.collisionMask=e},respondToCollision:function(e){var t=e.overlapV;if(this.ancestor.pos.sub(t),0!==t.x&&(this.vel.x=~~(.5+this.vel.x-t.x)||0,this.bounce>0&&(this.vel.x*=-this.bounce)),0!==t.y){this.vel.y=~~(.5+this.vel.y-t.y)||0,this.bounce>0&&(this.vel.y*=-this.bounce);var i=Math.sign(me.game.world.gravity.y*this.gravityScale)||1;this.falling=t.y>=i,this.jumping=t.y<=-i}},updateBounds:function(){if(this.shapes.length>0){var e=this.shapes[0].getBounds();this.pos.setV(e.pos),this.resize(e.width,e.height);for(var t=1;t<this.shapes.length;t++)this.union(this.shapes[t].getBounds())}return this._super(me.Rect,"updateBounds"),"function"==typeof this.onBodyUpdate&&this.onBodyUpdate(this),this},rotate:function(e,t){t=t||this.center;for(var i=0;i<this.shapes.length;i++)this.shapes[i].rotate(e,t);return this.updateBounds(),this},setVelocity:function(e,t){this.accel.x=0!==e?e:this.accel.x,this.accel.y=0!==t?t:this.accel.y,this.setMaxVelocity(e,t)},setMaxVelocity:function(e,t){this.maxVel.x=e,this.maxVel.y=t},setFriction:function(e,t){this.friction.x=e||0,this.friction.y=t||0},applyFriction:function(e){var t=this.friction.x*me.timer.tick,i=e.x+t,n=e.x-t,r=this.friction.y*me.timer.tick,s=e.y+r,o=e.y-r;e.x=i<0?i:n>0?n:0,e.y=s<0?s:o>0?o:0},computeVelocity:function(e){if(this.force.x&&(e.x+=this.force.x*me.timer.tick),this.force.y&&(e.y+=this.force.y*me.timer.tick),(this.friction.x||this.friction.y)&&this.applyFriction(e),!this.ignoreGravity){var t=me.game.world.gravity;e.x+=t.x*this.gravityScale*this.mass*me.timer.tick,e.y+=t.y*this.gravityScale*this.mass*me.timer.tick,this.falling=e.y*Math.sign(t.y*this.gravityScale)>0,this.jumping=!this.falling&&this.jumping}0!==e.y&&(e.y=me.Math.clamp(e.y,-this.maxVel.y,this.maxVel.y)),0!==e.x&&(e.x=me.Math.clamp(e.x,-this.maxVel.x,this.maxVel.x))},update:function(){return this.computeVelocity(this.vel),this.ancestor.pos.add(this.vel),0!==this.vel.x||0!==this.vel.y},destroy:function(){this.onBodyUpdate=void 0,this.ancestor=void 0,this.shapes.length=0}}),function(){var e=[],t=function(t,i,n,r){if(e.length>0){var s=e.pop();return s.bounds=t,s.max_objects=i||4,s.max_levels=n||4,s.level=r||0,s}return new me.QuadTree(t,i,n,r)},i=new me.Vector2d;function n(e,t,i,n){this.max_objects=t||4,this.max_levels=i||4,this.level=n||0,this.bounds=e,this.objects=[],this.nodes=[]}n.prototype.split=function(){var e=this.level+1,i=~~(.5+this.bounds.width/2),n=~~(.5+this.bounds.height/2),r=~~(.5+this.bounds.pos.x),s=~~(.5+this.bounds.pos.y);this.nodes[0]=t({pos:{x:r+i,y:s},width:i,height:n},this.max_objects,this.max_levels,e),this.nodes[1]=t({pos:{x:r,y:s},width:i,height:n},this.max_objects,this.max_levels,e),this.nodes[2]=t({pos:{x:r,y:s+n},width:i,height:n},this.max_objects,this.max_levels,e),this.nodes[3]=t({pos:{x:r+i,y:s+n},width:i,height:n},this.max_objects,this.max_levels,e)},n.prototype.getIndex=function(e){var t=e.getBounds(),n=t.pos;(e.floating||e.ancestor&&e.ancestor.floating)&&(n=me.game.viewport.localToWorld(n.x,n.y,i));var r=-1,s=n.x,o=n.y,a=t.width,h=t.height,l=this.bounds.pos.x+this.bounds.width/2,u=this.bounds.pos.y+this.bounds.height/2,c=o<u&&o+h<u,d=o>u;return s<l&&s+a<l?c?r=1:d&&(r=2):s>l&&(c?r=0:d&&(r=3)),r},n.prototype.insertContainer=function(e){for(var t,i=e.children.length;i--,t=e.children[i];)!0!==t.isKinematic&&(t instanceof me.Container?("rootContainer"!==t.name&&this.insert(t),this.insertContainer(t)):"function"==typeof t.getBounds&&this.insert(t))},n.prototype.insert=function(e){var t=-1;if(this.nodes.length>0&&-1!==(t=this.getIndex(e)))this.nodes[t].insert(e);else if(this.objects.push(e),this.objects.length>this.max_objects&&this.level<this.max_levels){0===this.nodes.length&&this.split();for(var i=0;i<this.objects.length;)-1!==(t=this.getIndex(this.objects[i]))?this.nodes[t].insert(this.objects.splice(i,1)[0]):i+=1}},n.prototype.retrieve=function(e,t){var i=this.objects;if(this.nodes.length>0){var n=this.getIndex(e);if(-1!==n)i=i.concat(this.nodes[n].retrieve(e));else for(var r=0;r<this.nodes.length;r+=1)i=i.concat(this.nodes[r].retrieve(e))}return"function"==typeof t&&i.sort(t),i},n.prototype.remove=function(e){var t=!1;if(void 0===e.getBounds)return!1;if(this.nodes.length>0){var i=this.getIndex(e);-1!==i&&(t=me.utils.array.remove(this.nodes[i],e))&&this.nodes[i].isPrunable()&&this.nodes.splice(i,1)}return!1===t&&-1!==this.objects.indexOf(e)&&(me.utils.array.remove(this.objects,e),t=!0),t},n.prototype.isPrunable=function(){return!(this.hasChildren()||this.objects.length>0)},n.prototype.hasChildren=function(){for(var e=0;e<this.nodes.length;e+=1){var t=this.nodes[e];if(t.length>0||t.objects.length>0)return!0}return!1},n.prototype.clear=function(t){this.objects.length=0;for(var i=0;i<this.nodes.length;i+=1)this.nodes[i].clear(),n=this.nodes[i],e.push(n);var n;this.nodes.length=0,void 0!==t&&this.bounds.setShape(t.pos.x,t.pos.y,t.width,t.height)},me.QuadTree=n}(),function(){for(var e=[],t=0;t<10;t++)e.push(new me.Vector2d);for(var i=[],n=0;n<5;n++)i.push([]);var r={pos:new me.Vector2d(0,0),ancestor:{_absPos:new me.Vector2d(0,0)}};function s(e,t,i){for(var n=Number.MAX_VALUE,r=-Number.MAX_VALUE,s=e.length,o=0;o<s;o++){var a=e[o].dotProduct(t);a<n&&(n=a),a>r&&(r=a)}i[0]=n,i[1]=r}function o(t,n,r,o,a,h){var l=i.pop(),u=i.pop(),c=e.pop().copy(n).sub(t),d=c.dotProduct(a);if(s(r,a,l),s(o,a,u),u[0]+=d,u[1]+=d,l[0]>u[1]||u[0]>l[1])return e.push(c),i.push(l),i.push(u),!0;if(h){var f=0;if(l[0]<u[0])if(h.aInB=!1,l[1]<u[1])f=l[1]-u[0],h.bInA=!1;else{var p=l[1]-u[0],m=u[1]-l[0];f=p<m?p:-m}else if(h.bInA=!1,l[1]>u[1])f=l[0]-u[1],h.aInB=!1;else{var g=l[1]-u[0],v=u[1]-l[0];f=g<v?g:-v}var y=Math.abs(f);y<h.overlap&&(h.overlap=y,h.overlapN.copy(a),f<0&&h.overlapN.negateSelf())}return e.push(c),i.push(l),i.push(u),!1}function a(e,t){var i=e.length2(),n=t.dotProduct(e);return n<0?-1:n>i?1:0}me.collision=function(){var t={maxChildren:8,maxDepth:4,types:{NO_OBJECT:0,PLAYER_OBJECT:1,NPC_OBJECT:2,ENEMY_OBJECT:4,COLLECTABLE_OBJECT:8,ACTION_OBJECT:16,PROJECTILE_OBJECT:32,WORLD_SHAPE:64,USER:128,ALL_OBJECT:4294967295},ResponseObject:function(){this.a=null,this.b=null,this.overlapN=new me.Vector2d,this.overlapV=new me.Vector2d,this.aInB=!0,this.bInA=!0,this.indexShapeA=-1,this.indexShapeB=-1,this.overlap=Number.MAX_VALUE}};return t.ResponseObject.prototype.clear=function(){return this.aInB=!0,this.bInA=!0,this.overlap=Number.MAX_VALUE,this.indexShapeA=-1,this.indexShapeB=-1,this},t.response=new t.ResponseObject,t.shouldCollide=function(e,t){return!0!==e.isKinematic&&!0!==t.isKinematic&&e.body&&t.body&&0!=(e.body.collisionMask&t.body.collisionType)&&0!=(e.body.collisionType&t.body.collisionMask)},t.check=function(e,i){for(var n,r=0,s=i||t.response,o=me.game.world.broadphase.retrieve(e),a=o.length;n=o[--a];)if(n!==e&&t.shouldCollide(e,n)&&e.getBounds().overlaps(n.getBounds())){var h=e.body.shapes.length,l=n.body.shapes.length;if(0===h||0===l)continue;var u=0;do{var c=e.body.getShape(u),d=0;do{var f=n.body.getShape(d);!0===t["test"+c.shapeType+f.shapeType].call(this,e,c,n,f,s.clear())&&(r++,s.indexShapeA=u,s.indexShapeB=d,e.onCollision&&!1!==e.onCollision(s,n)&&e.body.respondToCollision.call(e.body,s),n.onCollision&&!1!==n.onCollision(s,e)&&n.body.respondToCollision.call(n.body,s)),d++}while(d<l);u++}while(u<h)}return r>0},t.rayCast=function(e,i){for(var n,s=0,o=i||[],a=me.game.world.broadphase.retrieve(e.getBounds()),h=a.length;n=a[--h];)if(n.body&&e.getBounds().overlaps(n.getBounds())){var l=n.body.shapes.length;if(0===n.body.shapes.length)continue;var u=e,c=0;do{var d=n.body.getShape(c);t["test"+u.shapeType+d.shapeType].call(this,r,u,n,d)&&(o[s]=n,s++),c++}while(c<l)}return o.length=s,o},t.testPolygonPolygon=function(t,i,n,r,s){var a,h=i.points,l=i.normals,u=l.length,c=r.points,d=r.normals,f=d.length,p=e.pop().copy(t.pos).add(t.ancestor._absPos).add(i.pos),m=e.pop().copy(n.pos).add(n.ancestor._absPos).add(r.pos);for(a=0;a<u;a++)if(o(p,m,h,c,l[a],s))return e.push(p),e.push(m),!1;for(a=0;a<f;a++)if(o(p,m,h,c,d[a],s))return e.push(p),e.push(m),!1;return s&&(s.a=t,s.b=n,s.overlapV.copy(s.overlapN).scale(s.overlap)),e.push(p),e.push(m),!0},t.testEllipseEllipse=function(t,i,n,r,s){var o=e.pop().copy(n.pos).add(n.ancestor._absPos).add(r.pos).sub(t.pos).add(t.ancestor._absPos).sub(i.pos),a=i.radius,h=r.radius,l=a+h,u=l*l,c=o.length2();if(c>u)return e.push(o),!1;if(s){var d=Math.sqrt(c);s.a=t,s.b=n,s.overlap=l-d,s.overlapN.copy(o.normalize()),s.overlapV.copy(o).scale(s.overlap),s.aInB=a<=h&&d<=h-a,s.bInA=h<=a&&d<=a-h}return e.push(o),!0},t.testPolygonEllipse=function(t,i,n,r,s){for(var o=e.pop().copy(n.pos).add(n.ancestor._absPos).add(r.pos).sub(t.pos).add(t.ancestor._absPos).sub(i.pos),h=r.radius,l=h*h,u=i.points,c=i.edges,d=c.length,f=e.pop(),p=e.pop(),m=e.pop(),g=0,v=0;v<d;v++){var y=v===d-1?0:v+1,_=0===v?d-1:v-1,x=0,w=null;f.copy(c[v]),m.copy(o).sub(u[v]),s&&m.length2()>l&&(s.aInB=!1);var b=a(f,m),T=!0;if(-1===b){var A=null;if(d>1&&(f.copy(c[_]),1!==(b=a(f,A=e.pop().copy(o).sub(u[_])))&&(T=!1)),T){if((g=m.length())>h)return e.push(o),e.push(f),e.push(p),e.push(m),A&&e.push(A),!1;s&&(s.bInA=!1,w=m.normalize(),x=h-g)}A&&e.push(A)}else if(1===b){if(d>1&&(f.copy(c[y]),m.copy(o).sub(u[y]),-1!==(b=a(f,m))&&(T=!1)),T){if((g=m.length())>h)return e.push(o),e.push(f),e.push(p),e.push(m),!1;s&&(s.bInA=!1,w=m.normalize(),x=h-g)}}else{p.copy(i.normals[v]),g=m.dotProduct(p);var E=Math.abs(g);if((1===d||g>0)&&E>h)return e.push(o),e.push(f),e.push(p),e.push(m),!1;s&&(w=p,x=h-g,(g>=0||x<2*h)&&(s.bInA=!1))}w&&s&&Math.abs(x)<Math.abs(s.overlap)&&(s.overlap=x,s.overlapN.copy(w))}return s&&(s.a=t,s.b=n,s.overlapV.copy(s.overlapN).scale(s.overlap)),e.push(o),e.push(f),e.push(p),e.push(m),!0},t.testEllipsePolygon=function(e,i,n,r,s){var o=t.testPolygonEllipse(n,r,e,i,s);if(o&&s){var a=s.a,h=s.aInB;s.overlapN.negateSelf(),s.overlapV.negateSelf(),s.a=s.b,s.b=a,s.aInB=s.bInA,s.bInA=h}return o},t}()}(),me.World=me.Container.extend({init:function(e,t,i,n){this._super(me.Container,"init",[e||0,t||0,i||1/0,n||1/0,!0]),this.name="rootContainer",this.anchorPoint.set(0,0),this.fps=60,this.gravity=new me.Vector2d(0,.98),this.broadphase=new me.QuadTree(this.getBounds().clone(),me.collision.maxChildren,me.collision.maxDepth),me.event.subscribe(me.event.GAME_RESET,this.reset.bind(this)),me.event.subscribe(me.event.LEVEL_LOADED,(function(){me.game.world.broadphase.clear(me.game.world.getBounds())}))},reset:function(){this.broadphase.clear(),this.anchorPoint.set(0,0),this._super(me.Container,"reset")},update:function(e){return this.broadphase.clear(),this.broadphase.insertContainer(this),this._super(me.Container,"update",[e])}}),MIN=Math.min,MAX=Math.max,targetV=new me.Vector2d,me.Camera2d=me.Renderable.extend({init:function(e,t,i,n){this._super(me.Renderable,"init",[e,t,i-e,n-t]),this.AXIS={NONE:0,HORIZONTAL:1,VERTICAL:2,BOTH:3},this.bounds=new me.Rect(-1/0,-1/0,1/0,1/0),this.smoothFollow=!0,this.damping=1,this.near=-1e3,this.far=1e3,this.projectionMatrix=new me.Matrix3d,this.invCurrentTransform=new me.Matrix2d,this.offset=new me.Vector2d,this.target=null,this.follow_axis=this.AXIS.NONE,this._shake={intensity:0,duration:0,axis:this.AXIS.BOTH,onComplete:null},this._fadeOut={color:null,tween:null},this._fadeIn={color:null,tween:null},this.name="default",this.setDeadzone(this.width/6,this.height/6),this.anchorPoint.set(0,0),this.isKinematic=!1,this._updateProjectionMatrix(),me.event.subscribe(me.event.GAME_RESET,this.reset.bind(this)),me.event.subscribe(me.event.CANVAS_ONRESIZE,this.resize.bind(this))},_updateProjectionMatrix:function(){this.projectionMatrix.ortho(0,this.width,this.height,0,this.near,this.far)},_followH:function(e){var t=this.pos.x;return e.x-this.pos.x>this.deadzone.right?t=MIN(e.x-this.deadzone.right,this.bounds.width-this.width):e.x-this.pos.x<this.deadzone.pos.x&&(t=MAX(e.x-this.deadzone.pos.x,this.bounds.pos.x)),t},_followV:function(e){var t=this.pos.y;return e.y-this.pos.y>this.deadzone.bottom?t=MIN(e.y-this.deadzone.bottom,this.bounds.height-this.height):e.y-this.pos.y<this.deadzone.pos.y&&(t=MAX(e.y-this.deadzone.pos.y,this.bounds.pos.y)),t},reset:function(e,t){this.pos.x=e||0,this.pos.y=t||0,this.unfollow(),this.smoothFollow=!0,this.damping=1,this.currentTransform.identity(),this.invCurrentTransform.identity().invert(),this._updateProjectionMatrix()},setDeadzone:function(e,t){void 0===this.deadzone&&(this.deadzone=new me.Rect(0,0,0,0)),this.deadzone.pos.set(~~((this.width-e)/2),~~((this.height-t)/2-.25*t)),this.deadzone.resize(e,t),this.smoothFollow=!1,this.updateTarget(),this.smoothFollow=!0},resize:function(e,t){return this._super(me.Renderable,"resize",[e,t]),this.smoothFollow=!1,this.setBounds(0,0,e,t),this.setDeadzone(e/6,t/6),this.update(),this.smoothFollow=!0,this._updateProjectionMatrix(),me.event.publish(me.event.VIEWPORT_ONRESIZE,[this.width,this.height]),this},setBounds:function(e,t,i,n){this.smoothFollow=!1,this.bounds.pos.set(e,t),this.bounds.resize(i,n),this.moveTo(this.pos.x,this.pos.y),this.update(),this.smoothFollow=!0},follow:function(e,t,i){if(e instanceof me.Renderable)this.target=e.pos;else{if(!(e instanceof me.Vector2d||e instanceof me.Vector3d))throw new Error("invalid target for me.Camera2d.follow");this.target=e}this.follow_axis=void 0===t?this.AXIS.BOTH:t,this.smoothFollow=!1,this.damping="number"!=typeof i?1:me.Math.clamp(i,0,1),this.updateTarget(),this.smoothFollow=!0},unfollow:function(){this.target=null,this.follow_axis=this.AXIS.NONE},move:function(e,t){this.moveTo(this.pos.x+e,this.pos.y+t)},moveTo:function(e,t){var i=this.pos.x,n=this.pos.y;this.pos.x=me.Math.clamp(e,this.bounds.pos.x,this.bounds.width-this.width),this.pos.y=me.Math.clamp(t,this.bounds.pos.y,this.bounds.height-this.height),i===this.pos.x&&n===this.pos.y||me.event.publish(me.event.VIEWPORT_ONCHANGE,[this.pos])},updateTarget:function(){if(this.target){switch(targetV.setV(this.pos),this.follow_axis){case this.AXIS.NONE:break;case this.AXIS.HORIZONTAL:targetV.x=this._followH(this.target);break;case this.AXIS.VERTICAL:targetV.y=this._followV(this.target);break;case this.AXIS.BOTH:targetV.x=this._followH(this.target),targetV.y=this._followV(this.target)}if(!this.pos.equals(targetV)){if(!0===this.smoothFollow&&this.damping<1){if(me.Math.toBeCloseTo(targetV.x,this.pos.x,2)&&me.Math.toBeCloseTo(targetV.y,this.pos.y,2))return this.pos.setV(targetV),!1;this.pos.lerp(targetV,this.damping)}else this.pos.setV(targetV);return!0}}return!1},update:function(e){var t=this.updateTarget(e);return this._shake.duration>0&&(this._shake.duration-=e,this._shake.duration<=0?(this._shake.duration=0,this.offset.setZero(),"function"==typeof this._shake.onComplete&&this._shake.onComplete()):(this._shake.axis!==this.AXIS.BOTH&&this._shake.axis!==this.AXIS.HORIZONTAL||(this.offset.x=(Math.random()-.5)*this._shake.intensity),this._shake.axis!==this.AXIS.BOTH&&this._shake.axis!==this.AXIS.VERTICAL||(this.offset.y=(Math.random()-.5)*this._shake.intensity)),t=!0),!0===t&&me.event.publish(me.event.VIEWPORT_ONCHANGE,[this.pos]),null==this._fadeIn.tween&&null==this._fadeOut.tween||(t=!0),this.currentTransform.isIdentity()?this.invCurrentTransform.identity():this.invCurrentTransform.copy(this.currentTransform).invert(),t},shake:function(e,t,i,n,r){0!==this._shake.duration&&!0!==r||(this._shake.intensity=e,this._shake.duration=t,this._shake.axis=i||this.AXIS.BOTH,this._shake.onComplete="function"==typeof n?n:void 0)},fadeOut:function(e,t,i){this._fadeOut.color=me.pool.pull("me.Color").copy(e),this._fadeOut.tween=me.pool.pull("me.Tween",this._fadeOut.color).to({alpha:0},t||1e3).onComplete(i||null),this._fadeOut.tween.isPersistent=!0,this._fadeOut.tween.start()},fadeIn:function(e,t,i){this._fadeIn.color=me.pool.pull("me.Color").copy(e);var n=this._fadeIn.color.alpha;this._fadeIn.color.alpha=0,this._fadeIn.tween=me.pool.pull("me.Tween",this._fadeIn.color).to({alpha:n},t||1e3).onComplete(i||null),this._fadeIn.tween.isPersistent=!0,this._fadeIn.tween.start()},getWidth:function(){return this.width},getHeight:function(){return this.height},focusOn:function(e){var t=e.getBounds();this.moveTo(e.pos.x+t.pos.x+t.width/2,e.pos.y+t.pos.y+t.height/2)},isVisible:function(e,t){return!0===t||!0===e.floating?me.video.renderer.overlaps(e.getBounds()):e.getBounds().overlaps(this)},localToWorld:function(e,t,i){return(i=i||new me.Vector2d).set(e,t).add(this.pos).sub(me.game.world.pos),this.currentTransform.isIdentity()||this.invCurrentTransform.apply(i),i},worldToLocal:function(e,t,i){return(i=i||new me.Vector2d).set(e,t),this.currentTransform.isIdentity()||this.currentTransform.apply(i),i.sub(this.pos).add(me.game.world.pos)},drawFX:function(e){this._fadeIn.tween&&(e.save(),e.resetTransform(),e.setColor(this._fadeIn.color),e.fillRect(0,0,this.width,this.height),e.restore(),1===this._fadeIn.color.alpha&&(this._fadeIn.tween=null,me.pool.push(this._fadeIn.color),this._fadeIn.color=null)),this._fadeOut.tween&&(e.save(),e.resetTransform(),e.setColor(this._fadeOut.color),e.fillRect(0,0,this.width,this.height),e.restore(),0===this._fadeOut.color.alpha&&(this._fadeOut.tween=null,me.pool.push(this._fadeOut.color),this._fadeOut.color=null))},draw:function(e,t){var i=this.pos.x+this.offset.x,n=this.pos.y+this.offset.y;t.currentTransform.translate(-i,-n),e.setProjection(this.projectionMatrix),e.clipRect(0,0,this.width,this.height),this.preDraw(e),t.preDraw(e),t.draw(e,this),this.drawFX(e),t.postDraw(e),this.postDraw(e),t.currentTransform.translate(i,n)}}),me.Entity=me.Renderable.extend({init:function(e,t,i){if(this.children=[],"number"!=typeof i.width||"number"!=typeof i.height)throw new Error("height and width properties are mandatory when passing settings parameters to an object entity");if(this._super(me.Renderable,"init",[e,t,i.width,i.height]),i.image&&(i.framewidth=i.framewidth||i.width,i.frameheight=i.frameheight||i.height,this.renderable=new me.Sprite(0,0,i)),i.anchorPoint&&this.anchorPoint.set(i.anchorPoint.x,i.anchorPoint.y),"string"==typeof i.name&&(this.name=i.name),this.type=i.type||"",this.id=i.id||"",this.alive=!0,void 0===i.shapes&&(i.shapes=new me.Polygon(0,0,[new me.Vector2d(0,0),new me.Vector2d(this.width,0),new me.Vector2d(this.width,this.height),new me.Vector2d(0,this.height)])),void 0!==this.body?this.body.init(this,i.shapes,this.onBodyUpdate.bind(this)):this.body=new me.Body(this,i.shapes,this.onBodyUpdate.bind(this)),0===this.width&&0===this.height&&this.resize(this.body.width,this.body.height),void 0!==i.collisionMask&&this.body.setCollisionMask(i.collisionMask),void 0!==i.collisionType){if(void 0===me.collision.types[i.collisionType])throw new Error("Invalid value for the collisionType property");this.body.collisionType=me.collision.types[i.collisionType]}this.autoTransform=!1},update:function(e){return this.renderable?this.renderable.update(e):this._super(me.Renderable,"update",[e])},updateBoundsPos:function(e,t){if(void 0!==this.body){var i=this.body.pos;this._super(me.Renderable,"updateBoundsPos",[e+i.x,t+i.y])}else this._super(me.Renderable,"updateBoundsPos",[e,t]);return this.getBounds()},onBodyUpdate:function(e){this.getBounds().resize(e.width,e.height),this.updateBoundsPos(this.pos.x,this.pos.y)},preDraw:function(e){e.save(),e.translate(this.pos.x+this.body.pos.x,this.pos.y+this.body.pos.y),this.renderable instanceof me.Renderable&&e.translate(this.anchorPoint.x*this.body.width,this.anchorPoint.y*this.body.height)},draw:function(e,t){var i=this.renderable;i instanceof me.Renderable&&(i.preDraw(e),i.draw(e,t),i.postDraw(e))},destroy:function(){this.renderable&&(this.renderable.destroy.apply(this.renderable,arguments),this.children.splice(0,1)),this._super(me.Renderable,"destroy",arguments)},onDeactivateEvent:function(){this.renderable&&this.renderable.onDeactivateEvent&&this.renderable.onDeactivateEvent()},onCollision:function(){return!1}}),Object.defineProperty(me.Entity.prototype,"renderable",{get:function(){return this.children[0]},set:function(e){if(!(e instanceof me.Renderable))throw new Error(e+"should extend me.Renderable");this.children[0]=e,this.children[0].ancestor=this},configurable:!0}),default_settings={cameras:[]},me.Stage=me.Object.extend({init:function(e){this.cameras=new Map,this.settings=Object.assign(default_settings,e||{})},reset:function(){var e=this;if(this.settings.cameras.forEach((function(t){e.cameras.set(t.name,t)})),!1===this.cameras.has("default")){if(void 0===default_camera){var t=me.video.renderer.getWidth(),i=me.video.renderer.getHeight();default_camera=new me.Camera2d(0,0,t,i)}this.cameras.set("default",default_camera)}me.game.reset(),this.onResetEvent.apply(this,arguments)},update:function(e){var t=me.game.world.update(e);return this.cameras.forEach((function(i){i.update(e)&&(t=!0)})),t},draw:function(e){this.cameras.forEach((function(t){t.draw(e,me.game.world)}))},destroy:function(){this.cameras.clear(),this.onDestroyEvent.apply(this,arguments)},onResetEvent:function(){},onDestroyEvent:function(){}}),me.state=function(){var e={},t=-1,i=-1,n=!1,r={},s={color:"",duration:0},o=null,a=null,h=0;function l(){-1===i&&-1!==t&&(me.timer.reset(),i=window.requestAnimationFrame(u))}function u(e){var n=r[t].stage;me.game.update(e,n),me.game.draw(n),-1!==i&&(i=window.requestAnimationFrame(u))}function c(){window.cancelAnimationFrame(i),i=-1}function d(e){c(),r[t]&&r[t].stage.destroy(),r[e]&&(r[t=e].stage.reset.apply(r[t].stage,a),l(),o&&o(),me.game.repaint())}return e.LOADING=0,e.MENU=1,e.READY=2,e.PLAY=3,e.GAMEOVER=4,e.GAME_END=5,e.SCORE=6,e.CREDITS=7,e.SETTINGS=8,e.DEFAULT=9,e.USER=100,e.onPause=null,e.onResume=null,e.onStop=null,e.onRestart=null,e.init=function(){e.set(e.LOADING,new me.DefaultLoadingScreen),e.set(me.state.DEFAULT,new me.Stage),me.event.subscribe(me.event.VIDEO_INIT,(function(){me.state.change(me.state.DEFAULT,!0)}))},e.stop=function(i){t!==e.LOADING&&e.isRunning()&&(c(),!0===i&&me.audio.pauseTrack(),h=window.performance.now(),me.event.publish(me.event.STATE_STOP),"function"==typeof e.onStop&&e.onStop())},e.pause=function(i){t===e.LOADING||e.isPaused()||(n=!0,!0===i&&me.audio.pauseTrack(),h=window.performance.now(),me.event.publish(me.event.STATE_PAUSE),"function"==typeof e.onPause&&e.onPause())},e.restart=function(t){e.isRunning()||(l(),!0===t&&me.audio.resumeTrack(),h=window.performance.now()-h,me.game.repaint(),me.event.publish(me.event.STATE_RESTART,[h]),"function"==typeof e.onRestart&&e.onRestart())},e.resume=function(i){e.isPaused()&&(n&&-1!==t&&(me.timer.reset(),n=!1),!0===i&&me.audio.resumeTrack(),h=window.performance.now()-h,me.event.publish(me.event.STATE_RESUME,[h]),"function"==typeof e.onResume&&e.onResume())},e.isRunning=function(){return-1!==i},e.isPaused=function(){return n},e.set=function(t,i,n){if(!(i instanceof me.Stage))throw new Error(i+" is not an instance of me.Stage");r[t]={},r[t].stage=i,r[t].transition=!0,!0===n&&e.change(t)},e.current=function(){if(void 0!==r[t])return r[t].stage},e.transition=function(e,t,i){"fade"===e&&(s.color=t,s.duration=i)},e.setTransition=function(e,t){r[e].transition=t},e.change=function(t,i){if(void 0===r[t])throw new Error("Undefined Stage for state '"+t+"'");e.isCurrent(t)||(a=null,arguments.length>1&&(a=Array.prototype.slice.call(arguments,1)),s.duration&&r[t].transition?(o=function(){me.game.viewport.fadeOut(s.color,s.duration)},me.game.viewport.fadeIn(s.color,s.duration,(function(){me.utils.function.defer(d,this,t)}))):!0===i?d(t):me.utils.function.defer(d,this,t))},e.isCurrent=function(e){return t===e},e}(),ProgressBar=me.Renderable.extend({init:function(e,t,i,n){this.barHeight=n,this._super(me.Renderable,"init",[e,t,i,n]),this.anchorPoint.set(0,0),this.loaderHdlr=me.event.subscribe(me.event.LOADER_PROGRESS,this.onProgressUpdate.bind(this)),this.resizeHdlr=me.event.subscribe(me.event.VIEWPORT_ONRESIZE,this.resize.bind(this)),this.progress=0},onProgressUpdate:function(e){this.progress=~~(e*this.width),this.isDirty=!0},draw:function(e){e.clearColor("#202020"),e.setColor("black"),e.fillRect(this.pos.x,me.game.viewport.centerY,e.getWidth(),this.barHeight/2),e.setColor("#55aa00"),e.fillRect(this.pos.x,me.game.viewport.centerY,this.progress,this.barHeight/2)},onDestroyEvent:function(){me.event.unsubscribe(this.loaderHdlr),me.event.unsubscribe(this.resizeHdlr),this.loaderHdlr=this.resizeHdlr=null}}),IconLogo=me.Renderable.extend({init:function(e,t){this._super(me.Renderable,"init",[e,t,100,85]),this.iconCanvas=me.video.createCanvas(me.Math.nextPowerOfTwo(this.width),me.Math.nextPowerOfTwo(this.height),!1);var i=me.video.renderer.getContext2d(this.iconCanvas);i.beginPath(),i.moveTo(.7,48.9),i.bezierCurveTo(10.8,68.9,38.4,75.8,62.2,64.5),i.bezierCurveTo(86.1,53.1,97.2,27.7,87,7.7),i.lineTo(87,7.7),i.bezierCurveTo(89.9,15.4,73.9,30.2,50.5,41.4),i.bezierCurveTo(27.1,52.5,5.2,55.8,.7,48.9),i.lineTo(.7,48.9),i.closePath(),i.fillStyle="rgb(255, 255, 255)",i.fill(),i.beginPath(),i.moveTo(84,7),i.bezierCurveTo(87.6,14.7,72.5,30.2,50.2,41.6),i.bezierCurveTo(27.9,53,6.9,55.9,3.2,48.2),i.bezierCurveTo(-.5,40.4,14.6,24.9,36.9,13.5),i.bezierCurveTo(59.2,2.2,80.3,-.8,84,7),i.lineTo(84,7),i.closePath(),i.lineWidth=5.3,i.strokeStyle="rgb(255, 255, 255)",i.lineJoin="miter",i.miterLimit=4,i.stroke(),this.anchorPoint.set(.5,.5)},draw:function(e){e.drawImage(this.iconCanvas,e.getWidth()/2,this.pos.y)}}),TextLogo=me.Renderable.extend({init:function(e,t){this._super(me.Renderable,"init",[0,0,e,t]),this.textWidth=0,this.fontCanvas=me.video.createCanvas(256,64,!0),this.drawFont(me.video.renderer.getContext2d(this.fontCanvas)),this.anchorPoint.set(0,0)},drawFont:function(e){var t=me.pool.pull("me.Text",0,0,{font:"century gothic",size:32,fillStyle:"white",textAlign:"middle",textBaseline:"top",text:"melon"}),i=me.pool.pull("me.Text",0,0,{font:"century gothic",size:32,fillStyle:"#55aa00",textAlign:"middle",textBaseline:"top",bold:!0,text:"JS"}),n=t.measureText(e).width,r=i.measureText(e).width;this.textWidth=n+r,this.pos.x=Math.round((this.width-this.textWidth)/2),this.pos.y=Math.round(this.height/2+16),t._drawFont(e,["melon"],0,0),i._drawFont(e,["JS"],n,0),me.pool.push(t),me.pool.push(i)},draw:function(e){e.drawImage(this.fontCanvas,Math.round((e.getWidth()-this.textWidth)/2),this.pos.y)}}),me.DefaultLoadingScreen=me.Stage.extend({onResetEvent:function(){me.game.world.addChild(new ProgressBar(0,me.video.renderer.getHeight()/2,me.video.renderer.getWidth(),8),1),me.game.world.addChild(new IconLogo(me.video.renderer.getWidth()/2,me.video.renderer.getHeight()/2-16-35),2),me.game.world.addChild(new TextLogo(me.video.renderer.getWidth(),me.video.renderer.getHeight()),2)}}),me.loader=function(){var e={},t={},i={},n={},r={},s={},o=0,a=0,h=0;function l(i,n,r){t[i.name]=new Image,t[i.name].onload=n,t[i.name].onerror=r,"string"==typeof e.crossOrigin&&(t[i.name].crossOrigin=e.crossOrigin),t[i.name].src=i.src+e.nocache}function u(e,t,i){var n=new FontFace(e.name,e.src);n.load().then((function(){document.fonts.add(n),document.body.style.fontFamily=e.name,t()}),(function(t){i(e.name)}))}function c(t,n,r){function s(e){i[t.name]=e,"tmx"===t.type&&me.levelDirector.addTMXLevel(t.name)}if(t.data)return s(t.data),void n();var o=new XMLHttpRequest,a=me.utils.file.getExtension(t.src);o.overrideMimeType&&("json"===a?o.overrideMimeType("application/json"):o.overrideMimeType("text/xml")),o.open("GET",t.src+e.nocache,!0),o.withCredentials=me.loader.withCredentials,o.ontimeout=r,o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status&&o.responseText){var e=null;switch(a){case"xml":case"tmx":case"tsx":if(me.device.ua.match(/msie/i)||!o.responseXML){if(!window.DOMParser)throw new Error("XML file format loading not supported, use the JSON file format instead");e=(new DOMParser).parseFromString(o.responseText,"text/xml")}else e=o.responseXML;var i=me.TMXUtils.parse(e);switch(a){case"tmx":e=i.map;break;case"tsx":e=i.tilesets[0]}break;case"json":e=JSON.parse(o.responseText);break;default:throw new Error("TMX file format "+a+"not supported !")}s(e),n()}else r(t.name)},o.send()}function d(t,i,n){var s=new XMLHttpRequest;s.overrideMimeType&&s.overrideMimeType("application/json"),s.open("GET",t.src+e.nocache,!0),s.withCredentials=me.loader.withCredentials,s.ontimeout=n,s.onreadystatechange=function(){4===s.readyState&&(200===s.status||0===s.status&&s.responseText?(r[t.name]=JSON.parse(s.responseText),i()):n(t.name))},s.send()}function f(t,i,r){var s=new XMLHttpRequest;s.open("GET",t.src+e.nocache,!0),s.withCredentials=me.loader.withCredentials,s.responseType="arraybuffer",s.onerror=r,s.onload=function(){var e=s.response;if(e){for(var r=new Uint8Array(e),o=[],a=0;a<r.byteLength;a++)o[a]=String.fromCharCode(r[a]);n[t.name]=o.join(""),i()}},s.send()}function p(t,i,n){var r=document.createElement("script");r.src=t.src,r.type="text/javascript","string"==typeof e.crossOrigin&&(r.crossOrigin=e.crossOrigin),r.defer=!0,r.onload=function(){i()},r.onerror=function(){n(t.name)},document.getElementsByTagName("body")[0].appendChild(r)}return e.nocache="",e.onload=void 0,e.onProgress=void 0,e.crossOrigin=void 0,e.withCredentials=!1,e.onResourceLoaded=function(t){var i=++a/o;e.onProgress&&e.onProgress(i,t),me.event.publish(me.event.LOADER_PROGRESS,[i,t])},e.onLoadingError=function(e){throw new Error("Failed loading resource "+e.src)},e.setNocache=function(t){e.nocache=t?"?"+~~(1e7*Math.random()):""},e.setBaseURL=function(e,t){"*"!==e?s[e]=t:(s.audio=t,s.binary=t,s.image=t,s.json=t,s.js=t,s.tmx=t,s.tsx=t)},e.preload=function(t,i,n){for(var r=0;r<t.length;r++)o+=e.load(t[r],e.onResourceLoaded.bind(e,t[r]),e.onLoadingError.bind(e,t[r]));void 0!==i&&(e.onload=i),!1!==n&&me.state.change(me.state.LOADING),function t(i){if(a===o){if(!i&&!e.onload)throw new Error("no load callback defined");clearTimeout(h);var n=i||e.onload;setTimeout((function(){n(),me.event.publish(me.event.LOADER_COMPLETE)}),300)}else h=setTimeout((function(){t(i)}),100)}(i)},e.load=function(e,t,i){switch(void 0!==s[e.type]&&(e.src=s[e.type]+e.src),e.type){case"binary":return f.call(this,e,t,i),1;case"image":return l.call(this,e,t,i),1;case"json":return d.call(this,e,t,i),1;case"js":return p.call(this,e,t,i),1;case"tmx":case"tsx":return c.call(this,e,t,i),1;case"audio":return me.audio.load(e,!!e.stream,t,i),1;case"fontface":return u.call(this,e,t,i),1;default:throw new Error("load : unknown or invalid resource type : "+e.type)}},e.unload=function(e){switch(e.type){case"binary":return e.name in n&&(delete n[e.name],!0);case"image":return e.name in t&&(delete t[e.name],!0);case"json":return e.name in r&&(delete r[e.name],!0);case"js":case"fontface":return!0;case"tmx":case"tsx":return e.name in i&&(delete i[e.name],!0);case"audio":return me.audio.unload(e.name);default:throw new Error("unload : unknown or invalid resource type : "+e.type)}},e.unloadAll=function(){var s;for(s in n)n.hasOwnProperty(s)&&e.unload({name:s,type:"binary"});for(s in t)t.hasOwnProperty(s)&&e.unload({name:s,type:"image"});for(s in i)i.hasOwnProperty(s)&&e.unload({name:s,type:"tmx"});for(s in r)r.hasOwnProperty(s)&&e.unload({name:s,type:"json"});me.audio.unloadAll()},e.getTMX=function(e){return(e=""+e)in i?i[e]:null},e.getBinary=function(e){return(e=""+e)in n?n[e]:null},e.getImage=function(e){return(e=me.utils.file.getBasename(""+e))in t?t[e]:null},e.getJSON=function(e){return(e=""+e)in r?r[e]:null},e.getLoadProgress=function(){return a/o},e}(),runits=["ex","em","pt","px"],toPX=[12,24,.75,1],setContextStyle=function(e,t,i){e.font=t.font,e.fillStyle=t.fillStyle.toRGBA(),!0===i&&(e.strokeStyle=t.strokeStyle.toRGBA(),e.lineWidth=t.lineWidth),e.textAlign=t.textAlign,e.textBaseline=t.textBaseline},me.Text=me.Renderable.extend({init:function(e,t,i){this._super(me.Renderable,"init",[e,t,i.width||0,i.height||0]),void 0!==i.fillStyle?i.fillStyle instanceof me.Color?this.fillStyle=i.fillStyle:this.fillStyle=me.pool.pull("me.Color").parseCSS(i.fillStyle):this.fillStyle=me.pool.pull("me.Color",0,0,0),void 0!==i.strokeStyle?i.strokeStyle instanceof me.Color?this.strokeStyle=i.strokeStyle:this.strokeStyle=me.pool.pull("me.Color").parseCSS(i.strokeStyle):this.strokeStyle=me.pool.pull("me.Color",0,0,0),this.lineWidth=i.lineWidth||1,this.textAlign=i.textAlign||"left",this.textBaseline=i.textBaseline||"top",this.lineHeight=i.lineHeight||1,this._text=[],this.fontSize=10,void 0!==i.anchorPoint?this.anchorPoint.setV(i.anchorPoint):this.anchorPoint.set(0,0),void 0!==i.floating&&(this.floating=!!i.floating),this.setFont(i.font,i.size),!0===i.bold&&this.bold(),!0===i.italic&&this.italic(),this.setText(i.text)},bold:function(){return this.font="bold "+this.font,this.isDirty=!0,this},italic:function(){return this.font="italic "+this.font,this.isDirty=!0,this},setFont:function(e,t){var i=e.split(",").map((function(e){return e=e.trim(),/(^".*"$)|(^'.*'$)/.test(e)?e:'"'+e+'"'}));if("number"==typeof t)this.fontSize=t,t+="px";else{var n=t.match(/([-+]?[\d.]*)(.*)/);this.fontSize=parseFloat(n[1]),n[2]?this.fontSize*=toPX[runits.indexOf(n[2])]:t+="px"}return this.height=this.fontSize,this.font=t+" "+i.join(","),this.isDirty=!0,this},setText:function(e){return void 0===e&&(e=""),this._text.toString()!==e.toString()&&(Array.isArray(e)?this._text=e:this._text=(""+e).split("\n"),this.isDirty=!0),this},measureText:function(e,t,i){var n;n=void 0===e?me.video.renderer.getFontContext():e instanceof me.Renderer?e.getFontContext():e;var r=i||this.getBounds(),s=this.fontSize*this.lineHeight,o=void 0!==t?(""+t).split("\n"):this._text;n.save(),setContextStyle(n,this),this.height=this.width=0;for(var a=0;a<o.length;a++)this.width=Math.max(n.measureText(me.utils.string.trimRight(""+o[a])).width,this.width),this.height+=s;return r.width=Math.ceil(this.width),r.height=Math.ceil(this.height),r.pos.x=Math.floor("right"===this.textAlign?this.pos.x-this.width:"center"===this.textAlign?this.pos.x-this.width/2:this.pos.x),r.pos.y=Math.floor(0===this.textBaseline.search(/^(top|hanging)$/)?this.pos.y:"middle"===this.textBaseline?this.pos.y-r.height/2:this.pos.y-r.height),n.restore(),r},update:function(){return!0===this.isDirty&&this.measureText(),this.isDirty},draw:function(e,t,i,n,r){void 0===this.ancestor?(this.setText(t),this.pos.x===i&&this.pos.y===n||(this.pos.x=i,this.pos.y=n,this.isDirty=!0),this.update(0),e.save(),e.setGlobalAlpha(e.globalAlpha()*this.getOpacity())):(i=this.pos.x,n=this.pos.y),!1===e.settings.subPixel&&(i=~~i,n=~~n),e.drawFont(this._drawFont(e.getFontContext(),this._text,i,n,r||!1)),void 0===this.ancestor&&e.restore(),this.isDirty=!1},drawStroke:function(e,t,i,n){this.draw.call(this,e,t,i,n,!0)},_drawFont:function(e,t,i,n,r){setContextStyle(e,this,r);for(var s=this.fontSize*this.lineHeight,o=0;o<t.length;o++){var a=me.utils.string.trimRight(""+t[o]);e[r?"strokeText":"fillText"](a,i,n),n+=s}return this.getBounds()},destroy:function(){me.pool.push(this.fillStyle),me.pool.push(this.strokeStyle),this.fillStyle=this.strokeStyle=void 0,this._text.length=0,this._super(me.Renderable,"destroy")}}),measureTextWidth=function(e,t){for(var i=t.split(""),n=0,r=null,s=0;s<i.length;s++){var o=i[s].charCodeAt(0),a=e.fontData.glyphs[o],h=r&&r.kerning?r.getKerning(o):0;n+=(a.xadvance+h)*e.fontScale.x,r=a}return n},measureTextHeight=function(e){return e.fontData.capHeight*e.lineHeight*e.fontScale.y},me.BitmapText=me.Renderable.extend({init:function(e,t,i){this._super(me.Renderable,"init",[e,t,i.width||0,i.height||0]),this.textAlign=i.textAlign||"left",this.textBaseline=i.textBaseline||"top",this.lineHeight=i.lineHeight||1,this._text=[],this.fontScale=me.pool.pull("me.Vector2d",1,1),this.fontImage="object"===_typeof(i.font)?i.font:me.loader.getImage(i.font),"string"!=typeof i.fontData?this.fontData=me.pool.pull("me.BitmapTextData",me.loader.getBinary(i.font)):this.fontData=me.pool.pull("me.BitmapTextData",i.fontData.includes("info face")?i.fontData:me.loader.getBinary(i.fontData)),void 0!==i.floating&&(this.floating=!!i.floating),"number"==typeof i.size&&1!==i.size&&this.resize(i.size),void 0!==i.fillStyle&&(i.fillStyle instanceof me.Color?this.fillStyle.setColor(i.fillStyle):this.fillStyle.parseCSS(i.fillStyle)),void 0!==i.anchorPoint?this.anchorPoint.set(i.anchorPoint.x,i.anchorPoint.y):this.anchorPoint.set(0,0),this.setText(i.text)},set:function(e,t){return this.textAlign=e,t&&this.resize(t),this.isDirty=!0,this},setText:function(e){return void 0===e&&(e=""),this._text.toString()!==e.toString()&&(Array.isArray(e)?this._text=e:this._text=(""+e).split("\n"),this.isDirty=!0),this},resize:function(e){return this.fontScale.set(e,e),this.isDirty=!0,this},measureText:function(e,t){e=e||this._text;var i=measureTextHeight(this),n=t||this.getBounds(),r="string"==typeof e?(""+e).split("\n"):e;n.height=n.width=0;for(var s=0;s<r.length;s++)n.width=Math.max(measureTextWidth(this,r[s]),n.width),n.height+=i;return n},update:function(){return!0===this.isDirty&&this.measureText(),this.isDirty},draw:function(e,t,i,n){var r=e.globalAlpha();void 0===this.ancestor?(this.setText(t),this.update(0),e.setGlobalAlpha(r*this.getOpacity())):(i=this.pos.x,n=this.pos.y);for(var s=i,o=measureTextHeight(this),a=0,h=0;h<this._text.length;h++){i=s;var l=me.utils.string.trimRight(this._text[h]),u=measureTextWidth(this,l);switch(this.textAlign){case"right":i-=u;break;case"center":i-=.5*u}switch(this.textBaseline){case"middle":n-=.5*o;break;case"ideographic":case"alphabetic":case"bottom":n-=o}!0===this.isDirty&&void 0===this.ancestor&&(0===h&&(this.pos.y=n),a<u&&(a=u,this.pos.x=i));for(var c=null,d=0,f=l.length;d<f;d++){var p=l.charCodeAt(d),m=this.fontData.glyphs[p],g=m.width,v=m.height,y=c&&c.kerning?c.getKerning(p):0;0!==g&&0!==v&&e.drawImage(this.fontImage,m.x,m.y,g,v,i+m.xoffset,n+m.yoffset*this.fontScale.y,g*this.fontScale.x,v*this.fontScale.y),i+=(m.xadvance+y)*this.fontScale.x,c=m}n+=o}void 0===this.ancestor&&e.setGlobalAlpha(r),this.isDirty=!1},destroy:function(){me.pool.push(this.fontScale),this.fontScale=void 0,me.pool.push(this.fontData),this.fontData=void 0,this._text.length=0,this._super(me.Renderable,"destroy")}}),Object.defineProperty(me.BitmapText.prototype,"fillStyle",{get:function(){return this.tint},set:function(e){this.tint=e},configurable:!0}),capChars=["M","N","B","D","C","E","F","K","A","G","H","I","J","L","O","P","Q","R","S","T","U","V","W","X","Y","Z"],Glyph=me.Object.extend({init:function(){this.id=0,this.x=0,this.y=0,this.width=0,this.height=0,this.u=0,this.v=0,this.u2=0,this.v2=0,this.xoffset=0,this.yoffset=0,this.xadvance=0,this.fixedWidth=!1},getKerning:function(e){if(this.kerning){var t=this.kerning[e>>>9];if(t)return t[511&e]||0}return 0},setKerning:function(e,t){this.kerning||(this.kerning={});var i=this.kerning[e>>>9];void 0===i&&(this.kerning[e>>>9]={},i=this.kerning[e>>>9]),i[511&e]=t}}),me.BitmapTextData=me.Object.extend({init:function(e){this.padTop=0,this.padRight=0,this.padBottom=0,this.padLeft=0,this.lineHeight=0,this.capHeight=1,this.descent=0,this.glyphs={},this.parse(e)},_createSpaceGlyph:function(){var e=" ".charCodeAt(0),t=this.glyphs[e];t||((t=new Glyph).id=e,t.xadvance=this._getFirstGlyph().xadvance,this.glyphs[e]=t)},_getFirstGlyph:function(){for(var e=Object.keys(this.glyphs),t=0;t<e.length;t++)if(e[t]>32)return this.glyphs[e[t]];return null},_getValueFromPair:function(e,t){var i=e.match(t);if(!i)throw new Error("Could not find pattern "+t+" in string: "+e);return i[0].split("=")[1]},parse:function(e){if(!e)throw new Error("File containing font data was empty, cannot load the bitmap font.");var t=e.split(/\r\n|\n/),i=e.match(/padding\=\d+,\d+,\d+,\d+/g);if(!i)throw new Error("Padding not found in first line");var n=i[0].split("=")[1].split(",");this.padTop=parseFloat(n[0]),this.padLeft=parseFloat(n[1]),this.padBottom=parseFloat(n[2]),this.padRight=parseFloat(n[3]),this.lineHeight=parseFloat(this._getValueFromPair(t[1],/lineHeight\=\d+/g));var r,s=parseFloat(this._getValueFromPair(t[1],/base\=\d+/g)),o=this.padTop+this.padBottom,a=null;for(r=4;r<t.length;r++){var h=t[r],l=h.split(/=|\s+/);if(h&&!/^kernings/.test(h))if(/^kerning\s/.test(h)){var u=parseFloat(l[2]),c=parseFloat(l[4]),d=parseFloat(l[6]);null!=(a=this.glyphs[u])&&a.setKerning(c,d)}else{a=new Glyph;var f=parseFloat(l[2]);a.id=f,a.x=parseFloat(l[4]),a.y=parseFloat(l[6]),a.width=parseFloat(l[8]),a.height=parseFloat(l[10]),a.xoffset=parseFloat(l[12]),a.yoffset=parseFloat(l[14]),a.xadvance=parseFloat(l[16]),a.width>0&&a.height>0&&(this.descent=Math.min(s+a.yoffset,this.descent)),this.glyphs[f]=a}}this.descent+=this.padBottom,this._createSpaceGlyph();var p=null;for(r=0;r<capChars.length;r++){var m=capChars[r];if(p=this.glyphs[m.charCodeAt(0)])break}if(p)this.capHeight=p.height;else for(var g in this.glyphs)if(this.glyphs.hasOwnProperty(g)){if(0===(a=this.glyphs[g]).height||0===a.width)continue;this.capHeight=Math.max(this.capHeight,a.height)}this.capHeight-=o}});var howler=createCommonjsModule((function(e,t){
/*!
    *  howler.js v2.2.0
    *  howlerjs.com
    *
    *  (c) 2013-2020, James Simpson of GoldFire Studios
    *  goldfirestudios.com
    *
    *  MIT License
    */
!function(){var e=function(){this.init()};e.prototype={init:function(){var e=this||i;return e._counter=1e3,e._html5AudioPool=[],e.html5PoolSize=10,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.autoUnlock=!0,e._setup(),e},volume:function(e){var t=this||i;if(e=parseFloat(e),t.ctx||u(),void 0!==e&&e>=0&&e<=1){if(t._volume=e,t._muted)return t;t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e,i.ctx.currentTime);for(var n=0;n<t._howls.length;n++)if(!t._howls[n]._webAudio)for(var r=t._howls[n]._getSoundIds(),s=0;s<r.length;s++){var o=t._howls[n]._soundById(r[s]);o&&o._node&&(o._node.volume=o._volume*e)}return t}return t._volume},mute:function(e){var t=this||i;t.ctx||u(),t._muted=e,t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e?0:t._volume,i.ctx.currentTime);for(var n=0;n<t._howls.length;n++)if(!t._howls[n]._webAudio)for(var r=t._howls[n]._getSoundIds(),s=0;s<r.length;s++){var o=t._howls[n]._soundById(r[s]);o&&o._node&&(o._node.muted=!!e||o._muted)}return t},stop:function(){for(var e=this||i,t=0;t<e._howls.length;t++)e._howls[t].stop();return e},unload:function(){for(var e=this||i,t=e._howls.length-1;t>=0;t--)e._howls[t].unload();return e.usingWebAudio&&e.ctx&&void 0!==e.ctx.close&&(e.ctx.close(),e.ctx=null,u()),e},codecs:function(e){return(this||i)._codecs[e.replace(/^x-/,"")]},_setup:function(){var e=this||i;if(e.state=e.ctx&&e.ctx.state||"suspended",e._autoSuspend(),!e.usingWebAudio)if("undefined"!=typeof Audio)try{void 0===(new Audio).oncanplaythrough&&(e._canPlayEvent="canplay")}catch(t){e.noAudio=!0}else e.noAudio=!0;try{(new Audio).muted&&(e.noAudio=!0)}catch(e){}return e.noAudio||e._setupCodecs(),e},_setupCodecs:function(){var e=this||i,t=null;try{t="undefined"!=typeof Audio?new Audio:null}catch(t){return e}if(!t||"function"!=typeof t.canPlayType)return e;var n=t.canPlayType("audio/mpeg;").replace(/^no$/,""),r=e._navigator&&e._navigator.userAgent.match(/OPR\/([0-6].)/g),s=r&&parseInt(r[0].split("/")[1],10)<33;return e._codecs={mp3:!(s||!n&&!t.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!n,opus:!!t.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!t.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!t.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!t.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(t.canPlayType("audio/x-m4b;")||t.canPlayType("audio/m4b;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(t.canPlayType("audio/x-mp4;")||t.canPlayType("audio/mp4;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),dolby:!!t.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(t.canPlayType("audio/x-flac;")||t.canPlayType("audio/flac;")).replace(/^no$/,"")},e},_unlockAudio:function(){var e=this||i;if(!e._audioUnlocked&&e.ctx){e._audioUnlocked=!1,e.autoUnlock=!1,e._mobileUnloaded||44100===e.ctx.sampleRate||(e._mobileUnloaded=!0,e.unload()),e._scratchBuffer=e.ctx.createBuffer(1,1,22050);var t=function(i){for(;e._html5AudioPool.length<e.html5PoolSize;)try{var n=new Audio;n._unlocked=!0,e._releaseHtml5Audio(n)}catch(i){e.noAudio=!0;break}for(var r=0;r<e._howls.length;r++)if(!e._howls[r]._webAudio)for(var s=e._howls[r]._getSoundIds(),o=0;o<s.length;o++){var a=e._howls[r]._soundById(s[o]);a&&a._node&&!a._node._unlocked&&(a._node._unlocked=!0,a._node.load())}e._autoResume();var h=e.ctx.createBufferSource();h.buffer=e._scratchBuffer,h.connect(e.ctx.destination),void 0===h.start?h.noteOn(0):h.start(0),"function"==typeof e.ctx.resume&&e.ctx.resume(),h.onended=function(){h.disconnect(0),e._audioUnlocked=!0,document.removeEventListener("touchstart",t,!0),document.removeEventListener("touchend",t,!0),document.removeEventListener("click",t,!0);for(var i=0;i<e._howls.length;i++)e._howls[i]._emit("unlock")}};return document.addEventListener("touchstart",t,!0),document.addEventListener("touchend",t,!0),document.addEventListener("click",t,!0),e}},_obtainHtml5Audio:function(){var e=this||i;if(e._html5AudioPool.length)return e._html5AudioPool.pop();var t=(new Audio).play();return t&&"undefined"!=typeof Promise&&(t instanceof Promise||"function"==typeof t.then)&&t.catch((function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")})),new Audio},_releaseHtml5Audio:function(e){var t=this||i;return e._unlocked&&t._html5AudioPool.push(e),t},_autoSuspend:function(){var e=this;if(e.autoSuspend&&e.ctx&&void 0!==e.ctx.suspend&&i.usingWebAudio){for(var t=0;t<e._howls.length;t++)if(e._howls[t]._webAudio)for(var n=0;n<e._howls[t]._sounds.length;n++)if(!e._howls[t]._sounds[n]._paused)return e;return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout((function(){if(e.autoSuspend){e._suspendTimer=null,e.state="suspending";var t=function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())};e.ctx.suspend().then(t,t)}}),3e4),e}},_autoResume:function(){var e=this;if(e.ctx&&void 0!==e.ctx.resume&&i.usingWebAudio)return"running"===e.state&&"interrupted"!==e.ctx.state&&e._suspendTimer?(clearTimeout(e._suspendTimer),e._suspendTimer=null):"suspended"===e.state||"running"===e.state&&"interrupted"===e.ctx.state?(e.ctx.resume().then((function(){e.state="running";for(var t=0;t<e._howls.length;t++)e._howls[t]._emit("resume")})),e._suspendTimer&&(clearTimeout(e._suspendTimer),e._suspendTimer=null)):"suspending"===e.state&&(e._resumeAfterSuspend=!0),e}};var i=new e,n=function(e){e.src&&0!==e.src.length?this.init(e):console.error("An array of source files must be passed with any new Howl.")};n.prototype={init:function(e){var t=this;return i.ctx||u(),t._autoplay=e.autoplay||!1,t._format="string"!=typeof e.format?e.format:[e.format],t._html5=e.html5||!1,t._muted=e.mute||!1,t._loop=e.loop||!1,t._pool=e.pool||5,t._preload="boolean"!=typeof e.preload&&"metadata"!==e.preload||e.preload,t._rate=e.rate||1,t._sprite=e.sprite||{},t._src="string"!=typeof e.src?e.src:[e.src],t._volume=void 0!==e.volume?e.volume:1,t._xhr={method:e.xhr&&e.xhr.method?e.xhr.method:"GET",headers:e.xhr&&e.xhr.headers?e.xhr.headers:null,withCredentials:!(!e.xhr||!e.xhr.withCredentials)&&e.xhr.withCredentials},t._duration=0,t._state="unloaded",t._sounds=[],t._endTimers={},t._queue=[],t._playLock=!1,t._onend=e.onend?[{fn:e.onend}]:[],t._onfade=e.onfade?[{fn:e.onfade}]:[],t._onload=e.onload?[{fn:e.onload}]:[],t._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],t._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],t._onpause=e.onpause?[{fn:e.onpause}]:[],t._onplay=e.onplay?[{fn:e.onplay}]:[],t._onstop=e.onstop?[{fn:e.onstop}]:[],t._onmute=e.onmute?[{fn:e.onmute}]:[],t._onvolume=e.onvolume?[{fn:e.onvolume}]:[],t._onrate=e.onrate?[{fn:e.onrate}]:[],t._onseek=e.onseek?[{fn:e.onseek}]:[],t._onunlock=e.onunlock?[{fn:e.onunlock}]:[],t._onresume=[],t._webAudio=i.usingWebAudio&&!t._html5,void 0!==i.ctx&&i.ctx&&i.autoUnlock&&i._unlockAudio(),i._howls.push(t),t._autoplay&&t._queue.push({event:"play",action:function(){t.play()}}),t._preload&&"none"!==t._preload&&t.load(),t},load:function(){var e=null;if(i.noAudio)this._emit("loaderror",null,"No audio support.");else{"string"==typeof this._src&&(this._src=[this._src]);for(var t=0;t<this._src.length;t++){var n,s;if(this._format&&this._format[t])n=this._format[t];else{if("string"!=typeof(s=this._src[t])){this._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}(n=/^data:audio\/([^;,]+);/i.exec(s))||(n=/\.([^.]+)$/.exec(s.split("?",1)[0])),n&&(n=n[1].toLowerCase())}if(n||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),n&&i.codecs(n)){e=this._src[t];break}}if(e)return this._src=e,this._state="loading","https:"===window.location.protocol&&"http:"===e.slice(0,5)&&(this._html5=!0,this._webAudio=!1),new r(this),this._webAudio&&o(this),this;this._emit("loaderror",null,"No codec support for selected audio sources.")}},play:function(e,t){var n=this,r=null;if("number"==typeof e)r=e,e=null;else{if("string"==typeof e&&"loaded"===n._state&&!n._sprite[e])return null;if(void 0===e&&(e="__default",!n._playLock)){for(var s=0,o=0;o<n._sounds.length;o++)n._sounds[o]._paused&&!n._sounds[o]._ended&&(s++,r=n._sounds[o]._id);1===s?e=null:r=null}}var a=r?n._soundById(r):n._inactiveSound();if(!a)return null;if(r&&!e&&(e=a._sprite||"__default"),"loaded"!==n._state){a._sprite=e,a._ended=!1;var h=a._id;return n._queue.push({event:"play",action:function(){n.play(h)}}),h}if(r&&!a._paused)return t||n._loadQueue("play"),a._id;n._webAudio&&i._autoResume();var l=Math.max(0,a._seek>0?a._seek:n._sprite[e][0]/1e3),u=Math.max(0,(n._sprite[e][0]+n._sprite[e][1])/1e3-l),c=1e3*u/Math.abs(a._rate),d=n._sprite[e][0]/1e3,f=(n._sprite[e][0]+n._sprite[e][1])/1e3;a._sprite=e,a._ended=!1;var p=function(){a._paused=!1,a._seek=l,a._start=d,a._stop=f,a._loop=!(!a._loop&&!n._sprite[e][2])};if(!(l>=f)){var m=a._node;if(n._webAudio){var g=function(){n._playLock=!1,p(),n._refreshBuffer(a);var e=a._muted||n._muted?0:a._volume;m.gain.setValueAtTime(e,i.ctx.currentTime),a._playStart=i.ctx.currentTime,void 0===m.bufferSource.start?a._loop?m.bufferSource.noteGrainOn(0,l,86400):m.bufferSource.noteGrainOn(0,l,u):a._loop?m.bufferSource.start(0,l,86400):m.bufferSource.start(0,l,u),c!==1/0&&(n._endTimers[a._id]=setTimeout(n._ended.bind(n,a),c)),t||setTimeout((function(){n._emit("play",a._id),n._loadQueue()}),0)};"running"===i.state&&"interrupted"!==i.ctx.state?g():(n._playLock=!0,n.once("resume",g),n._clearTimer(a._id))}else{var v=function(){m.currentTime=l,m.muted=a._muted||n._muted||i._muted||m.muted,m.volume=a._volume*i.volume(),m.playbackRate=a._rate;try{var r=m.play();if(r&&"undefined"!=typeof Promise&&(r instanceof Promise||"function"==typeof r.then)?(n._playLock=!0,p(),r.then((function(){n._playLock=!1,m._unlocked=!0,t||(n._emit("play",a._id),n._loadQueue())})).catch((function(){n._playLock=!1,n._emit("playerror",a._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),a._ended=!0,a._paused=!0}))):t||(n._playLock=!1,p(),n._emit("play",a._id),n._loadQueue()),m.playbackRate=a._rate,m.paused)return void n._emit("playerror",a._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==e||a._loop?n._endTimers[a._id]=setTimeout(n._ended.bind(n,a),c):(n._endTimers[a._id]=function(){n._ended(a),m.removeEventListener("ended",n._endTimers[a._id],!1)},m.addEventListener("ended",n._endTimers[a._id],!1))}catch(e){n._emit("playerror",a._id,e)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===m.src&&(m.src=n._src,m.load());var y=window&&window.ejecta||!m.readyState&&i._navigator.isCocoonJS;if(m.readyState>=3||y)v();else{n._playLock=!0;var _=function(){v(),m.removeEventListener(i._canPlayEvent,_,!1)};m.addEventListener(i._canPlayEvent,_,!1),n._clearTimer(a._id)}}return a._id}n._ended(a)},pause:function(e){var t=this;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"pause",action:function(){t.pause(e)}}),t;for(var i=t._getSoundIds(e),n=0;n<i.length;n++){t._clearTimer(i[n]);var r=t._soundById(i[n]);if(r&&!r._paused&&(r._seek=t.seek(i[n]),r._rateSeek=0,r._paused=!0,t._stopFade(i[n]),r._node))if(t._webAudio){if(!r._node.bufferSource)continue;void 0===r._node.bufferSource.stop?r._node.bufferSource.noteOff(0):r._node.bufferSource.stop(0),t._cleanBuffer(r._node)}else isNaN(r._node.duration)&&r._node.duration!==1/0||r._node.pause();arguments[1]||t._emit("pause",r?r._id:null)}return t},stop:function(e,t){var i=this;if("loaded"!==i._state||i._playLock)return i._queue.push({event:"stop",action:function(){i.stop(e)}}),i;for(var n=i._getSoundIds(e),r=0;r<n.length;r++){i._clearTimer(n[r]);var s=i._soundById(n[r]);s&&(s._seek=s._start||0,s._rateSeek=0,s._paused=!0,s._ended=!0,i._stopFade(n[r]),s._node&&(i._webAudio?s._node.bufferSource&&(void 0===s._node.bufferSource.stop?s._node.bufferSource.noteOff(0):s._node.bufferSource.stop(0),i._cleanBuffer(s._node)):isNaN(s._node.duration)&&s._node.duration!==1/0||(s._node.currentTime=s._start||0,s._node.pause(),s._node.duration===1/0&&i._clearSound(s._node))),t||i._emit("stop",s._id))}return i},mute:function(e,t){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"mute",action:function(){n.mute(e,t)}}),n;if(void 0===t){if("boolean"!=typeof e)return n._muted;n._muted=e}for(var r=n._getSoundIds(t),s=0;s<r.length;s++){var o=n._soundById(r[s]);o&&(o._muted=e,o._interval&&n._stopFade(o._id),n._webAudio&&o._node?o._node.gain.setValueAtTime(e?0:o._volume,i.ctx.currentTime):o._node&&(o._node.muted=!!i._muted||e),n._emit("mute",o._id))}return n},volume:function(){var e,t,n,r=this,s=arguments;if(0===s.length)return r._volume;if(1===s.length||2===s.length&&void 0===s[1]){var o=r._getSoundIds(),a=o.indexOf(s[0]);a>=0?t=parseInt(s[0],10):e=parseFloat(s[0])}else s.length>=2&&(e=parseFloat(s[0]),t=parseInt(s[1],10));if(!(void 0!==e&&e>=0&&e<=1))return(n=t?r._soundById(t):r._sounds[0])?n._volume:0;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"volume",action:function(){r.volume.apply(r,s)}}),r;void 0===t&&(r._volume=e),t=r._getSoundIds(t);for(var h=0;h<t.length;h++)(n=r._soundById(t[h]))&&(n._volume=e,s[2]||r._stopFade(t[h]),r._webAudio&&n._node&&!n._muted?n._node.gain.setValueAtTime(e,i.ctx.currentTime):n._node&&!n._muted&&(n._node.volume=e*i.volume()),r._emit("volume",n._id));return r},fade:function(e,t,n,r){var s=this;if("loaded"!==s._state||s._playLock)return s._queue.push({event:"fade",action:function(){s.fade(e,t,n,r)}}),s;e=Math.min(Math.max(0,parseFloat(e)),1),t=Math.min(Math.max(0,parseFloat(t)),1),n=parseFloat(n),s.volume(e,r);for(var o=s._getSoundIds(r),a=0;a<o.length;a++){var h=s._soundById(o[a]);if(h){if(r||s._stopFade(o[a]),s._webAudio&&!h._muted){var l=i.ctx.currentTime,u=l+n/1e3;h._volume=e,h._node.gain.setValueAtTime(e,l),h._node.gain.linearRampToValueAtTime(t,u)}s._startFadeInterval(h,e,t,n,o[a],void 0===r)}}return s},_startFadeInterval:function(e,t,i,n,r,s){var o=this,a=t,h=i-t,l=Math.abs(h/.01),u=Math.max(4,l>0?n/l:n),c=Date.now();e._fadeTo=i,e._interval=setInterval((function(){var r=(Date.now()-c)/n;c=Date.now(),a+=h*r,a=h<0?Math.max(i,a):Math.min(i,a),a=Math.round(100*a)/100,o._webAudio?e._volume=a:o.volume(a,e._id,!0),s&&(o._volume=a),(i<t&&a<=i||i>t&&a>=i)&&(clearInterval(e._interval),e._interval=null,e._fadeTo=null,o.volume(i,e._id),o._emit("fade",e._id))}),u)},_stopFade:function(e){var t=this._soundById(e);return t&&t._interval&&(this._webAudio&&t._node.gain.cancelScheduledValues(i.ctx.currentTime),clearInterval(t._interval),t._interval=null,this.volume(t._fadeTo,e),t._fadeTo=null,this._emit("fade",e)),this},loop:function(){var e,t,i,n=this,r=arguments;if(0===r.length)return n._loop;if(1===r.length){if("boolean"!=typeof r[0])return!!(i=n._soundById(parseInt(r[0],10)))&&i._loop;e=r[0],n._loop=e}else 2===r.length&&(e=r[0],t=parseInt(r[1],10));for(var s=n._getSoundIds(t),o=0;o<s.length;o++)(i=n._soundById(s[o]))&&(i._loop=e,n._webAudio&&i._node&&i._node.bufferSource&&(i._node.bufferSource.loop=e,e&&(i._node.bufferSource.loopStart=i._start||0,i._node.bufferSource.loopEnd=i._stop)));return n},rate:function(){var e,t,n,r=this,s=arguments;if(0===s.length)t=r._sounds[0]._id;else if(1===s.length){var o=r._getSoundIds(),a=o.indexOf(s[0]);a>=0?t=parseInt(s[0],10):e=parseFloat(s[0])}else 2===s.length&&(e=parseFloat(s[0]),t=parseInt(s[1],10));if("number"!=typeof e)return(n=r._soundById(t))?n._rate:r._rate;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"rate",action:function(){r.rate.apply(r,s)}}),r;void 0===t&&(r._rate=e),t=r._getSoundIds(t);for(var h=0;h<t.length;h++)if(n=r._soundById(t[h])){r.playing(t[h])&&(n._rateSeek=r.seek(t[h]),n._playStart=r._webAudio?i.ctx.currentTime:n._playStart),n._rate=e,r._webAudio&&n._node&&n._node.bufferSource?n._node.bufferSource.playbackRate.setValueAtTime(e,i.ctx.currentTime):n._node&&(n._node.playbackRate=e);var l=r.seek(t[h]),u=(r._sprite[n._sprite][0]+r._sprite[n._sprite][1])/1e3-l,c=1e3*u/Math.abs(n._rate);!r._endTimers[t[h]]&&n._paused||(r._clearTimer(t[h]),r._endTimers[t[h]]=setTimeout(r._ended.bind(r,n),c)),r._emit("rate",n._id)}return r},seek:function(){var e,t,n=this,r=arguments;if(0===r.length)t=n._sounds[0]._id;else if(1===r.length){var s=n._getSoundIds(),o=s.indexOf(r[0]);o>=0?t=parseInt(r[0],10):n._sounds.length&&(t=n._sounds[0]._id,e=parseFloat(r[0]))}else 2===r.length&&(e=parseFloat(r[0]),t=parseInt(r[1],10));if(void 0===t)return n;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"seek",action:function(){n.seek.apply(n,r)}}),n;var a=n._soundById(t);if(a){if(!("number"==typeof e&&e>=0)){if(n._webAudio){var h=n.playing(t)?i.ctx.currentTime-a._playStart:0,l=a._rateSeek?a._rateSeek-a._seek:0;return a._seek+(l+h*Math.abs(a._rate))}return a._node.currentTime}var u=n.playing(t);u&&n.pause(t,!0),a._seek=e,a._ended=!1,n._clearTimer(t),n._webAudio||!a._node||isNaN(a._node.duration)||(a._node.currentTime=e);var c=function(){n._emit("seek",t),u&&n.play(t,!0)};if(u&&!n._webAudio){var d=function(){n._playLock?setTimeout(d,0):c()};setTimeout(d,0)}else c()}return n},playing:function(e){if("number"==typeof e){var t=this._soundById(e);return!!t&&!t._paused}for(var i=0;i<this._sounds.length;i++)if(!this._sounds[i]._paused)return!0;return!1},duration:function(e){var t=this._duration,i=this._soundById(e);return i&&(t=this._sprite[i._sprite][1]/1e3),t},state:function(){return this._state},unload:function(){for(var e=this,t=e._sounds,n=0;n<t.length;n++)t[n]._paused||e.stop(t[n]._id),e._webAudio||(e._clearSound(t[n]._node),t[n]._node.removeEventListener("error",t[n]._errorFn,!1),t[n]._node.removeEventListener(i._canPlayEvent,t[n]._loadFn,!1),i._releaseHtml5Audio(t[n]._node)),delete t[n]._node,e._clearTimer(t[n]._id);var r=i._howls.indexOf(e);r>=0&&i._howls.splice(r,1);var o=!0;for(n=0;n<i._howls.length;n++)if(i._howls[n]._src===e._src||e._src.indexOf(i._howls[n]._src)>=0){o=!1;break}return s&&o&&delete s[e._src],i.noAudio=!1,e._state="unloaded",e._sounds=[],e=null,null},on:function(e,t,i,n){var r=this["_on"+e];return"function"==typeof t&&r.push(n?{id:i,fn:t,once:n}:{id:i,fn:t}),this},off:function(e,t,i){var n=this["_on"+e],r=0;if("number"==typeof t&&(i=t,t=null),t||i)for(r=0;r<n.length;r++){var s=i===n[r].id;if(t===n[r].fn&&s||!t&&s){n.splice(r,1);break}}else if(e)this["_on"+e]=[];else{var o=Object.keys(this);for(r=0;r<o.length;r++)0===o[r].indexOf("_on")&&Array.isArray(this[o[r]])&&(this[o[r]]=[])}return this},once:function(e,t,i){return this.on(e,t,i,1),this},_emit:function(e,t,i){for(var n=this["_on"+e],r=n.length-1;r>=0;r--)n[r].id&&n[r].id!==t&&"load"!==e||(setTimeout(function(e){e.call(this,t,i)}.bind(this,n[r].fn),0),n[r].once&&this.off(e,n[r].fn,n[r].id));return this._loadQueue(e),this},_loadQueue:function(e){if(this._queue.length>0){var t=this._queue[0];t.event===e&&(this._queue.shift(),this._loadQueue()),e||t.action()}return this},_ended:function(e){var t=e._sprite;if(!this._webAudio&&e._node&&!e._node.paused&&!e._node.ended&&e._node.currentTime<e._stop)return setTimeout(this._ended.bind(this,e),100),this;var n=!(!e._loop&&!this._sprite[t][2]);if(this._emit("end",e._id),!this._webAudio&&n&&this.stop(e._id,!0).play(e._id),this._webAudio&&n){this._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=i.ctx.currentTime;var r=1e3*(e._stop-e._start)/Math.abs(e._rate);this._endTimers[e._id]=setTimeout(this._ended.bind(this,e),r)}return this._webAudio&&!n&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,this._clearTimer(e._id),this._cleanBuffer(e._node),i._autoSuspend()),this._webAudio||n||this.stop(e._id,!0),this},_clearTimer:function(e){if(this._endTimers[e]){if("function"!=typeof this._endTimers[e])clearTimeout(this._endTimers[e]);else{var t=this._soundById(e);t&&t._node&&t._node.removeEventListener("ended",this._endTimers[e],!1)}delete this._endTimers[e]}return this},_soundById:function(e){for(var t=0;t<this._sounds.length;t++)if(e===this._sounds[t]._id)return this._sounds[t];return null},_inactiveSound:function(){this._drain();for(var e=0;e<this._sounds.length;e++)if(this._sounds[e]._ended)return this._sounds[e].reset();return new r(this)},_drain:function(){var e=this._pool,t=0,i=0;if(!(this._sounds.length<e)){for(i=0;i<this._sounds.length;i++)this._sounds[i]._ended&&t++;for(i=this._sounds.length-1;i>=0;i--){if(t<=e)return;this._sounds[i]._ended&&(this._webAudio&&this._sounds[i]._node&&this._sounds[i]._node.disconnect(0),this._sounds.splice(i,1),t--)}}},_getSoundIds:function(e){if(void 0===e){for(var t=[],i=0;i<this._sounds.length;i++)t.push(this._sounds[i]._id);return t}return[e]},_refreshBuffer:function(e){return e._node.bufferSource=i.ctx.createBufferSource(),e._node.bufferSource.buffer=s[this._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop||0),e._node.bufferSource.playbackRate.setValueAtTime(e._rate,i.ctx.currentTime),this},_cleanBuffer:function(e){var t=i._navigator&&i._navigator.vendor.indexOf("Apple")>=0;if(i._scratchBuffer&&e.bufferSource&&(e.bufferSource.onended=null,e.bufferSource.disconnect(0),t))try{e.bufferSource.buffer=i._scratchBuffer}catch(e){}return e.bufferSource=null,this},_clearSound:function(e){/MSIE |Trident\//.test(i._navigator&&i._navigator.userAgent)||(e.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var r=function(e){this._parent=e,this.init()};r.prototype={init:function(){var e=this._parent;return this._muted=e._muted,this._loop=e._loop,this._volume=e._volume,this._rate=e._rate,this._seek=0,this._paused=!0,this._ended=!0,this._sprite="__default",this._id=++i._counter,e._sounds.push(this),this.create(),this},create:function(){var e=this._parent,t=i._muted||this._muted||this._parent._muted?0:this._volume;return e._webAudio?(this._node=void 0===i.ctx.createGain?i.ctx.createGainNode():i.ctx.createGain(),this._node.gain.setValueAtTime(t,i.ctx.currentTime),this._node.paused=!0,this._node.connect(i.masterGain)):i.noAudio||(this._node=i._obtainHtml5Audio(),this._errorFn=this._errorListener.bind(this),this._node.addEventListener("error",this._errorFn,!1),this._loadFn=this._loadListener.bind(this),this._node.addEventListener(i._canPlayEvent,this._loadFn,!1),this._node.src=e._src,this._node.preload=!0===e._preload?"auto":e._preload,this._node.volume=t*i.volume(),this._node.load()),this},reset:function(){var e=this._parent;return this._muted=e._muted,this._loop=e._loop,this._volume=e._volume,this._rate=e._rate,this._seek=0,this._rateSeek=0,this._paused=!0,this._ended=!0,this._sprite="__default",this._id=++i._counter,this},_errorListener:function(){this._parent._emit("loaderror",this._id,this._node.error?this._node.error.code:0),this._node.removeEventListener("error",this._errorFn,!1)},_loadListener:function(){var e=this._parent;e._duration=Math.ceil(10*this._node.duration)/10,0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue()),this._node.removeEventListener(i._canPlayEvent,this._loadFn,!1)}};var s={},o=function(e){var t=e._src;if(s[t])return e._duration=s[t].duration,void l(e);if(/^data:[^;]+;base64,/.test(t)){for(var i=atob(t.split(",")[1]),n=new Uint8Array(i.length),r=0;r<i.length;++r)n[r]=i.charCodeAt(r);h(n.buffer,e)}else{var o=new XMLHttpRequest;o.open(e._xhr.method,t,!0),o.withCredentials=e._xhr.withCredentials,o.responseType="arraybuffer",e._xhr.headers&&Object.keys(e._xhr.headers).forEach((function(t){o.setRequestHeader(t,e._xhr.headers[t])})),o.onload=function(){var t=(o.status+"")[0];"0"===t||"2"===t||"3"===t?h(o.response,e):e._emit("loaderror",null,"Failed loading audio file with status: "+o.status+".")},o.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete s[t],e.load())},a(o)}},a=function(e){try{e.send()}catch(t){e.onerror()}},h=function(e,t){var n=function(){t._emit("loaderror",null,"Decoding audio data failed.")},r=function(e){e&&t._sounds.length>0?(s[t._src]=e,l(t,e)):n()};"undefined"!=typeof Promise&&1===i.ctx.decodeAudioData.length?i.ctx.decodeAudioData(e).then(r).catch(n):i.ctx.decodeAudioData(e,r,n)},l=function(e,t){t&&!e._duration&&(e._duration=t.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue())},u=function(){if(i.usingWebAudio){try{"undefined"!=typeof AudioContext?i.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?i.ctx=new webkitAudioContext:i.usingWebAudio=!1}catch(e){i.usingWebAudio=!1}i.ctx||(i.usingWebAudio=!1);var e=/iP(hone|od|ad)/.test(i._navigator&&i._navigator.platform),t=i._navigator&&i._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),n=t?parseInt(t[1],10):null;if(e&&n&&n<9){var r=/safari/.test(i._navigator&&i._navigator.userAgent.toLowerCase());i._navigator&&!r&&(i.usingWebAudio=!1)}i.usingWebAudio&&(i.masterGain=void 0===i.ctx.createGain?i.ctx.createGainNode():i.ctx.createGain(),i.masterGain.gain.setValueAtTime(i._muted?0:i._volume,i.ctx.currentTime),i.masterGain.connect(i.ctx.destination)),i._setup()}};t.Howler=i,t.Howl=n,void 0!==commonjsGlobal?(commonjsGlobal.HowlerGlobal=e,commonjsGlobal.Howler=i,commonjsGlobal.Howl=n,commonjsGlobal.Sound=r):"undefined"!=typeof window&&(window.HowlerGlobal=e,window.Howler=i,window.Howl=n,window.Sound=r)}(),
/*!
    *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
    *  
    *  howler.js v2.2.0
    *  howlerjs.com
    *
    *  (c) 2013-2020, James Simpson of GoldFire Studios
    *  goldfirestudios.com
    *
    *  MIT License
    */
function(){var e;HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){if(!this.ctx||!this.ctx.listener)return this;for(var t=this._howls.length-1;t>=0;t--)this._howls[t].stereo(e);return this},HowlerGlobal.prototype.pos=function(e,t,i){return this.ctx&&this.ctx.listener?(t="number"!=typeof t?this._pos[1]:t,i="number"!=typeof i?this._pos[2]:i,"number"!=typeof e?this._pos:(this._pos=[e,t,i],void 0!==this.ctx.listener.positionX?(this.ctx.listener.positionX.setTargetAtTime(this._pos[0],Howler.ctx.currentTime,.1),this.ctx.listener.positionY.setTargetAtTime(this._pos[1],Howler.ctx.currentTime,.1),this.ctx.listener.positionZ.setTargetAtTime(this._pos[2],Howler.ctx.currentTime,.1)):this.ctx.listener.setPosition(this._pos[0],this._pos[1],this._pos[2]),this)):this},HowlerGlobal.prototype.orientation=function(e,t,i,n,r,s){if(!this.ctx||!this.ctx.listener)return this;var o=this._orientation;return t="number"!=typeof t?o[1]:t,i="number"!=typeof i?o[2]:i,n="number"!=typeof n?o[3]:n,r="number"!=typeof r?o[4]:r,s="number"!=typeof s?o[5]:s,"number"!=typeof e?o:(this._orientation=[e,t,i,n,r,s],void 0!==this.ctx.listener.forwardX?(this.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),this.ctx.listener.forwardY.setTargetAtTime(t,Howler.ctx.currentTime,.1),this.ctx.listener.forwardZ.setTargetAtTime(i,Howler.ctx.currentTime,.1),this.ctx.listener.upX.setTargetAtTime(n,Howler.ctx.currentTime,.1),this.ctx.listener.upY.setTargetAtTime(r,Howler.ctx.currentTime,.1),this.ctx.listener.upZ.setTargetAtTime(s,Howler.ctx.currentTime,.1)):this.ctx.listener.setOrientation(e,t,i,n,r,s),this)},Howl.prototype.init=(e=Howl.prototype.init,function(t){return this._orientation=t.orientation||[1,0,0],this._stereo=t.stereo||null,this._pos=t.pos||null,this._pannerAttr={coneInnerAngle:void 0!==t.coneInnerAngle?t.coneInnerAngle:360,coneOuterAngle:void 0!==t.coneOuterAngle?t.coneOuterAngle:360,coneOuterGain:void 0!==t.coneOuterGain?t.coneOuterGain:0,distanceModel:void 0!==t.distanceModel?t.distanceModel:"inverse",maxDistance:void 0!==t.maxDistance?t.maxDistance:1e4,panningModel:void 0!==t.panningModel?t.panningModel:"HRTF",refDistance:void 0!==t.refDistance?t.refDistance:1,rolloffFactor:void 0!==t.rolloffFactor?t.rolloffFactor:1},this._onstereo=t.onstereo?[{fn:t.onstereo}]:[],this._onpos=t.onpos?[{fn:t.onpos}]:[],this._onorientation=t.onorientation?[{fn:t.onorientation}]:[],e.call(this,t)}),Howl.prototype.stereo=function(e,i){var n=this;if(!n._webAudio)return n;if("loaded"!==n._state)return n._queue.push({event:"stereo",action:function(){n.stereo(e,i)}}),n;var r=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===i){if("number"!=typeof e)return n._stereo;n._stereo=e,n._pos=[e,0,0]}for(var s=n._getSoundIds(i),o=0;o<s.length;o++){var a=n._soundById(s[o]);if(a){if("number"!=typeof e)return a._stereo;a._stereo=e,a._pos=[e,0,0],a._node&&(a._pannerAttr.panningModel="equalpower",a._panner&&a._panner.pan||t(a,r),"spatial"===r?void 0!==a._panner.positionX?(a._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),a._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),a._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):a._panner.setPosition(e,0,0):a._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),n._emit("stereo",a._id)}}return n},Howl.prototype.pos=function(e,i,n,r){var s=this;if(!s._webAudio)return s;if("loaded"!==s._state)return s._queue.push({event:"pos",action:function(){s.pos(e,i,n,r)}}),s;if(i="number"!=typeof i?0:i,n="number"!=typeof n?-.5:n,void 0===r){if("number"!=typeof e)return s._pos;s._pos=[e,i,n]}for(var o=s._getSoundIds(r),a=0;a<o.length;a++){var h=s._soundById(o[a]);if(h){if("number"!=typeof e)return h._pos;h._pos=[e,i,n],h._node&&(h._panner&&!h._panner.pan||t(h,"spatial"),void 0!==h._panner.positionX?(h._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(n,Howler.ctx.currentTime)):h._panner.setPosition(e,i,n)),s._emit("pos",h._id)}}return s},Howl.prototype.orientation=function(e,i,n,r){var s=this;if(!s._webAudio)return s;if("loaded"!==s._state)return s._queue.push({event:"orientation",action:function(){s.orientation(e,i,n,r)}}),s;if(i="number"!=typeof i?s._orientation[1]:i,n="number"!=typeof n?s._orientation[2]:n,void 0===r){if("number"!=typeof e)return s._orientation;s._orientation=[e,i,n]}for(var o=s._getSoundIds(r),a=0;a<o.length;a++){var h=s._soundById(o[a]);if(h){if("number"!=typeof e)return h._orientation;h._orientation=[e,i,n],h._node&&(h._panner||(h._pos||(h._pos=s._pos||[0,0,-.5]),t(h,"spatial")),void 0!==h._panner.orientationX?(h._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.orientationZ.setValueAtTime(n,Howler.ctx.currentTime)):h._panner.setOrientation(e,i,n)),s._emit("orientation",h._id)}}return s},Howl.prototype.pannerAttr=function(){var e,i,n,r=this,s=arguments;if(!r._webAudio)return r;if(0===s.length)return r._pannerAttr;if(1===s.length){if("object"!=typeof s[0])return(n=r._soundById(parseInt(s[0],10)))?n._pannerAttr:r._pannerAttr;e=s[0],void 0===i&&(e.pannerAttr||(e.pannerAttr={coneInnerAngle:e.coneInnerAngle,coneOuterAngle:e.coneOuterAngle,coneOuterGain:e.coneOuterGain,distanceModel:e.distanceModel,maxDistance:e.maxDistance,refDistance:e.refDistance,rolloffFactor:e.rolloffFactor,panningModel:e.panningModel}),r._pannerAttr={coneInnerAngle:void 0!==e.pannerAttr.coneInnerAngle?e.pannerAttr.coneInnerAngle:r._coneInnerAngle,coneOuterAngle:void 0!==e.pannerAttr.coneOuterAngle?e.pannerAttr.coneOuterAngle:r._coneOuterAngle,coneOuterGain:void 0!==e.pannerAttr.coneOuterGain?e.pannerAttr.coneOuterGain:r._coneOuterGain,distanceModel:void 0!==e.pannerAttr.distanceModel?e.pannerAttr.distanceModel:r._distanceModel,maxDistance:void 0!==e.pannerAttr.maxDistance?e.pannerAttr.maxDistance:r._maxDistance,refDistance:void 0!==e.pannerAttr.refDistance?e.pannerAttr.refDistance:r._refDistance,rolloffFactor:void 0!==e.pannerAttr.rolloffFactor?e.pannerAttr.rolloffFactor:r._rolloffFactor,panningModel:void 0!==e.pannerAttr.panningModel?e.pannerAttr.panningModel:r._panningModel})}else 2===s.length&&(e=s[0],i=parseInt(s[1],10));for(var o=r._getSoundIds(i),a=0;a<o.length;a++)if(n=r._soundById(o[a])){var h=n._pannerAttr;h={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:h.coneInnerAngle,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:h.coneOuterAngle,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:h.coneOuterGain,distanceModel:void 0!==e.distanceModel?e.distanceModel:h.distanceModel,maxDistance:void 0!==e.maxDistance?e.maxDistance:h.maxDistance,refDistance:void 0!==e.refDistance?e.refDistance:h.refDistance,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:h.rolloffFactor,panningModel:void 0!==e.panningModel?e.panningModel:h.panningModel};var l=n._panner;l?(l.coneInnerAngle=h.coneInnerAngle,l.coneOuterAngle=h.coneOuterAngle,l.coneOuterGain=h.coneOuterGain,l.distanceModel=h.distanceModel,l.maxDistance=h.maxDistance,l.refDistance=h.refDistance,l.rolloffFactor=h.rolloffFactor,l.panningModel=h.panningModel):(n._pos||(n._pos=r._pos||[0,0,-.5]),t(n,"spatial"))}return r},Sound.prototype.init=function(e){return function(){var t=this._parent;this._orientation=t._orientation,this._stereo=t._stereo,this._pos=t._pos,this._pannerAttr=t._pannerAttr,e.call(this),this._stereo?t.stereo(this._stereo):this._pos&&t.pos(this._pos[0],this._pos[1],this._pos[2],this._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var t=this._parent;return this._orientation=t._orientation,this._stereo=t._stereo,this._pos=t._pos,this._pannerAttr=t._pannerAttr,this._stereo?t.stereo(this._stereo):this._pos?t.pos(this._pos[0],this._pos[1],this._pos[2],this._id):this._panner&&(this._panner.disconnect(0),this._panner=void 0,t._refreshBuffer(this)),e.call(this)}}(Sound.prototype.reset);var t=function(e,t){"spatial"===(t=t||"spatial")?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,void 0!==e._panner.positionX?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),void 0!==e._panner.orientationX?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}}()}));me.audio=function(){var e={},t={},i=null,n=0;function r(e,i){if(n++>3){var r="melonJS: failed loading "+e;if(!1!==me.sys.stopOnAudioError)throw new Error(r);me.audio.disable(),i&&i(),console.log(r+", disabling audio")}else t[e].load()}return e.init=function(e){if(!me.initialized)throw new Error("me.audio.init() called before engine initialization.");return e="string"==typeof e?e:"mp3",this.audioFormats=e.split(","),!howler.Howler.noAudio},e.hasAudio=function(){return!howler.Howler.noAudio},e.enable=function(){this.unmuteAll()},e.disable=function(){this.muteAll()},e.load=function(e,i,s,o){var a=[];if(void 0===this.audioFormats||0===this.audioFormats.length)throw new Error("target audio extension(s) should be set through me.audio.init() before calling the preloader.");for(var h=0;h<this.audioFormats.length;h++)a.push(e.src+e.name+"."+this.audioFormats[h]+me.loader.nocache);return t[e.name]=new howler.Howl({src:a,volume:howler.Howler.volume(),html5:!0===i,xhrWithCredentials:me.loader.withCredentials,onloaderror:function(){r.call(me.audio,e.name,o)},onload:function(){n=0,s&&s()}}),1},e.play=function(e,i,n,r){var s=t[e];if(s&&void 0!==s){var o=s.play();return"boolean"==typeof i&&s.loop(i,o),s.volume("number"==typeof r?me.Math.clamp(r,0,1):howler.Howler.volume(),o),"function"==typeof n&&(!0===i?s.on("end",n,o):s.once("end",n,o)),o}throw new Error("audio clip "+e+" does not exist")},e.fade=function(e,i,n,r,s){var o=t[e];if(!o||void 0===o)throw new Error("audio clip "+e+" does not exist");o.fade(i,n,r,s)},e.seek=function(e,i,n){var r=t[e];if(r&&void 0!==r)return r.seek.apply(r,Array.prototype.slice.call(arguments,1));throw new Error("audio clip "+e+" does not exist")},e.rate=function(e,i,n){var r=t[e];if(r&&void 0!==r)return r.rate.apply(r,Array.prototype.slice.call(arguments,1));throw new Error("audio clip "+e+" does not exist")},e.stop=function(e,i){if(void 0!==e){var n=t[e];if(!n||void 0===n)throw new Error("audio clip "+e+" does not exist");n.stop(i),n.off("end",void 0,i)}else howler.Howler.stop()},e.pause=function(e,i){var n=t[e];if(!n||void 0===n)throw new Error("audio clip "+e+" does not exist");n.pause(i)},e.resume=function(e,i){var n=t[e];if(!n||void 0===n)throw new Error("audio clip "+e+" does not exist");n.play(i)},e.playTrack=function(e,t){return i=e,me.audio.play(i,!0,null,t)},e.stopTrack=function(){null!==i&&(t[i].stop(),i=null)},e.pauseTrack=function(){null!==i&&t[i].pause()},e.resumeTrack=function(){null!==i&&t[i].play()},e.getCurrentTrack=function(){return i},e.setVolume=function(e){howler.Howler.volume(e)},e.getVolume=function(){return howler.Howler.volume()},e.mute=function(e,i,n){n=void 0===n||!!n;var r=t[e];if(!r||void 0===r)throw new Error("audio clip "+e+" does not exist");r.mute(n,i)},e.unmute=function(t,i){e.mute(t,i,!1)},e.muteAll=function(){howler.Howler.mute(!0)},e.unmuteAll=function(){howler.Howler.mute(!1)},e.muted=function(){return howler.Howler._muted},e.unload=function(e){return e in t&&(t[e].unload(),delete t[e],!0)},e.unloadAll=function(){for(var i in t)t.hasOwnProperty(i)&&e.unload(i)},e}(),me.video=function(){var e={},t=1,i=0,n=0,r={parent:document.body,renderer:2,doubleBuffering:!1,autoScale:!1,scale:1,scaleMethod:"fit",transparent:!1,blendMode:"normal",antiAlias:!1,failIfMajorPerformanceCaveat:!0,subPixel:!1,preferWebGL1:!0,powerPreference:"default",verbose:!1,consoleHeader:!0};return e.CANVAS=0,e.WEBGL=1,e.AUTO=2,e.parent=null,e.scaleRatio=new me.Vector2d(1,1),e.init=function(s,o,a){if(!me.initialized)throw new Error("me.video.init() called before engine initialization.");(r=Object.assign(r,a||{})).width=s,r.height=o,r.doubleBuffering=!!r.doubleBuffering,r.transparent=!!r.transparent,r.antiAlias=!!r.antiAlias,r.failIfMajorPerformanceCaveat=!!r.failIfMajorPerformanceCaveat,r.subPixel=!!r.subPixel,r.verbose=!!r.verbose,-1!==r.scaleMethod.search(/^(fill-(min|max)|fit|flex(-(width|height))?|stretch)$/)?r.autoScale="auto"===r.scale||!0:(r.scaleMethod="fit",r.autoScale="auto"===r.scale||!1),void 0!==r.wrapper&&(me.utils.deprecated("settings.wrapper","settings.parent","8.0.0"),r.parent=r.wrapper),!1!==r.consoleHeader&&console.log("melonJS v"+me.version+" | http://melonjs.org");var h=me.utils.getUriFragment();!0!==h.webgl&&!0!==h.webgl1&&!0!==h.webgl2||(r.renderer=e.WEBGL,!0===h.webgl2&&(r.preferWebGL1=!1)),r.scale=r.autoScale?1:+r.scale||1,me.video.scaleRatio.set(r.scale,r.scale),(r.autoScale||1!==r.scale)&&(r.doubleBuffering=!0),t=s/o,i=s,n=o,r.zoomX=s*me.video.scaleRatio.x,r.zoomY=o*me.video.scaleRatio.y,window.addEventListener("resize",me.utils.function.throttle((function(e){me.event.publish(me.event.WINDOW_ONRESIZE,[e])}),100),!1),window.addEventListener("orientationchange",(function(e){me.event.publish(me.event.WINDOW_ONORIENTATION_CHANGE,[e])}),!1),window.addEventListener("onmozorientationchange",(function(e){me.event.publish(me.event.WINDOW_ONORIENTATION_CHANGE,[e])}),!1),void 0!==window.screen&&(window.screen.onorientationchange=function(e){me.event.publish(me.event.WINDOW_ONORIENTATION_CHANGE,[e])}),window.addEventListener("scroll",me.utils.function.throttle((function(e){me.event.publish(me.event.WINDOW_ONSCROLL,[e])}),100),!1),me.event.subscribe(me.event.WINDOW_ONRESIZE,me.video.onresize.bind(me.video)),me.event.subscribe(me.event.WINDOW_ONORIENTATION_CHANGE,me.video.onresize.bind(me.video));try{switch(r.renderer){case e.AUTO:case e.WEBGL:this.renderer=function(e){try{if(me.device.isWebGLSupported(e))return new me.WebGLRenderer(e)}catch(e){console.log("Error creating WebGL renderer :"+e.message)}return new me.CanvasRenderer(e)}(r);break;default:this.renderer=new me.CanvasRenderer(r)}}catch(e){return console(e.message),!1}if(me.video.parent=me.device.getElement(r.parent),me.video.parent.appendChild(this.renderer.getScreenCanvas()),me.video.onresize(),"MutationObserver"in window&&new MutationObserver(me.video.onresize.bind(me.video)).observe(me.video.parent,{attributes:!1,childList:!0,subtree:!0}),!1!==r.consoleHeader){var l=me.video.renderer instanceof me.CanvasRenderer?"CANVAS":"WebGL"+me.video.renderer.WebGLVersion,u=me.device.hasWebAudio?"Web Audio":"HTML5 Audio",c="string"==typeof me.video.renderer.GPURenderer?" ("+me.video.renderer.GPURenderer+")":"";console.log(l+" renderer"+c+" | "+u+" | pixel ratio "+me.device.devicePixelRatio+" | "+(me.device.isMobile?"mobile":"desktop")+" | "+me.device.getScreenOrientation()+" | "+me.device.language),console.log("resolution: requested "+s+"x"+o+", got "+me.video.renderer.getWidth()+"x"+me.video.renderer.getHeight())}return me.event.publish(me.event.VIDEO_INIT),!0},e.createCanvas=function(e,t,i){var n;if(0===e||0===t)throw new Error("width or height was zero, Canvas could not be initialized !");return!0===me.device.OffscreenCanvas&&!0===i?void 0===(n=new OffscreenCanvas(0,0)).style&&(n.style={}):n=document.createElement("canvas"),n.width=e,n.height=t,n},e.getParent=function(){return me.video.parent},e.onresize=function(){var e=me.video.renderer,r=e.settings,s=1,o=1;if(r.autoScale){var a=1/0,h=1/0;if(window.getComputedStyle){var l=window.getComputedStyle(e.getScreenCanvas(),null);a=parseInt(l.maxWidth,10)||1/0,h=parseInt(l.maxHeight,10)||1/0}var u=me.device.getParentBounds(me.video.getParent()),c=Math.min(a,u.width),d=Math.min(h,u.height),f=c/d;if("fill-min"===r.scaleMethod&&f>t||"fill-max"===r.scaleMethod&&f<t||"flex-width"===r.scaleMethod){var p=Math.min(a,n*f);s=o=c/p,e.resize(Math.floor(p),n)}else if("fill-min"===r.scaleMethod&&f<t||"fill-max"===r.scaleMethod&&f>t||"flex-height"===r.scaleMethod){var m=Math.min(h,i*(d/c));s=o=d/m,e.resize(i,Math.floor(m))}else"flex"===r.scaleMethod?e.resize(Math.floor(c),Math.floor(d)):"stretch"===r.scaleMethod?(s=c/i,o=d/n):s=o=f<t?c/i:d/n;me.video.scale(s,o)}},e.scale=function(e,t){var i=me.video.renderer,n=i.getScreenCanvas(),r=i.getScreenContext(),s=i.settings,o=me.device.devicePixelRatio,a=s.zoomX=n.width*e*o,h=s.zoomY=n.height*t*o;me.video.scaleRatio.set(e*o,t*o),n.style.width=a/o+"px",n.style.height=h/o+"px",i.setAntiAlias(r,s.antiAlias),i.setBlendMode(s.blendMode,r),me.game.repaint()},e}(),me.Renderer=me.Object.extend({init:function(e){return this.settings=e,this.isContextValid=!0,this.currentScissor=new Int32Array([0,0,this.settings.width,this.settings.height]),this.currentBlendMode="normal",!0===me.device.ejecta?this.canvas=document.getElementById("canvas"):void 0!==window.canvas?this.canvas=window.canvas:void 0!==this.settings.canvas?this.canvas=this.settings.canvas:this.canvas=me.video.createCanvas(this.settings.zoomX,this.settings.zoomY),this.backBufferCanvas=this.canvas,this.context=null,this.currentColor=new me.Color(0,0,0,1),this.currentTint=new me.Color(255,255,255,1),this.projectionMatrix=new me.Matrix3d,this.uvOffset=0,this.parentBounds=new me.Rect(0,0,0,0),me.event.subscribe(me.event.GAME_RESET,(function(){me.video.renderer.reset()})),this},clear:function(){},reset:function(){this.resetTransform(),this.setBlendMode(this.settings.blendMode),this.setColor("#000000"),this.clearTint(),this.cache.clear(),this.currentScissor[0]=0,this.currentScissor[1]=0,this.currentScissor[2]=this.backBufferCanvas.width,this.currentScissor[3]=this.backBufferCanvas.height},getCanvas:function(){return this.backBufferCanvas},getScreenCanvas:function(){return this.canvas},getScreenContext:function(){return this.context},getBlendMode:function(){return this.currentBlendMode},getContext2d:function(e,t){if(null==e)throw new Error("You must pass a canvas element in order to create a 2d context");if(void 0===e.getContext)throw new Error("Your browser does not support HTML5 canvas.");"boolean"!=typeof t&&(t=!0);var i=e.getContext("2d",{alpha:t});return i.canvas||(i.canvas=e),this.setAntiAlias(i,this.settings.antiAlias),i},getWidth:function(){return this.backBufferCanvas.width},getHeight:function(){return this.backBufferCanvas.height},getColor:function(){return this.currentColor},globalAlpha:function(){return this.currentColor.glArray[3]},overlaps:function(e){return e.left<this.getWidth()&&e.right>0&&e.top<this.getHeight()&&e.bottom>0},resize:function(e,t){e===this.backBufferCanvas.width&&t===this.backBufferCanvas.height||(this.canvas.width=this.backBufferCanvas.width=e,this.canvas.height=this.backBufferCanvas.height=t,this.currentScissor[0]=0,this.currentScissor[1]=0,this.currentScissor[2]=e,this.currentScissor[3]=t,me.event.publish(me.event.CANVAS_ONRESIZE,[e,t]))},setAntiAlias:function(e,t){var i=e.canvas;me.agent.setPrefixed("imageSmoothingEnabled",!0===t,e),!0!==t?(i.style["image-rendering"]="optimizeSpeed",i.style["image-rendering"]="-moz-crisp-edges",i.style["image-rendering"]="-o-crisp-edges",i.style["image-rendering"]="-webkit-optimize-contrast",i.style["image-rendering"]="optimize-contrast",i.style["image-rendering"]="crisp-edges",i.style["image-rendering"]="pixelated",i.style.msInterpolationMode="nearest-neighbor"):i.style["image-rendering"]="auto"},setProjection:function(e){this.projectionMatrix.copy(e)},stroke:function(e,t){"Rectangle"===e.shapeType?this.strokeRect(e.left,e.top,e.width,e.height,t):e instanceof me.Line||e instanceof me.Polygon?this.strokePolygon(e,t):e instanceof me.Ellipse&&this.strokeEllipse(e.pos.x,e.pos.y,e.radiusV.x,e.radiusV.y,t)},tint:function(e,t,i){var n=me.video.createCanvas(e.width,e.height,!0),r=this.getContext2d(n);return r.save(),r.fillStyle=t instanceof me.Color?t.toRGB():t,r.fillRect(0,0,e.width,e.height),r.globalCompositeOperation=i||"multiply",r.drawImage(e,0,0),r.globalCompositeOperation="destination-atop",r.drawImage(e,0,0),r.restore(),n},fill:function(e){this.stroke(e,!0)},setMask:function(e){},clearMask:function(){},setTint:function(e){this.currentTint.copy(e)},clearTint:function(){this.currentTint.setColor(255,255,255,1)},drawFont:function(){}}),me.Renderer.prototype.Texture=me.Object.extend({init:function(e,t,i){if(this.format=null,this.sources=new Map,this.atlases=new Map,void 0!==e)for(var n in e=Array.isArray(e)?e:[e]){var r=e[n];if(void 0!==r.meta){if(r.meta.app.includes("texturepacker")||r.meta.app.includes("free-tex-packer")){if(this.format="texturepacker",void 0===t){var s=me.loader.getImage(r.meta.image);if(!s)throw new Error("Atlas texture '"+s+"' not found");this.sources.set(r.meta.image,s)}else this.sources.set(r.meta.image||"default","string"==typeof t?me.loader.getImage(t):t);this.repeat="no-repeat"}else if(r.meta.app.includes("ShoeBox")){if(!r.meta.exporter||!r.meta.exporter.includes("melonJS"))throw new Error("ShoeBox requires the JSON exporter : https://github.com/melonjs/melonJS/tree/master/media/shoebox_JSON_export.sbx");this.format="ShoeBox",this.repeat="no-repeat",this.sources.set("default","string"==typeof t?me.loader.getImage(t):t)}else r.meta.app.includes("melonJS")&&(this.format="melonJS",this.repeat=r.meta.repeat||"no-repeat",this.sources.set("default","string"==typeof t?me.loader.getImage(t):t));this.atlases.set(r.meta.image||"default",this.parse(r))}else void 0!==r.framewidth&&void 0!==r.frameheight&&(this.format="Spritesheet (fixed cell size)",this.repeat="no-repeat",void 0!==t&&(r.image="string"==typeof t?me.loader.getImage(t):t),this.atlases.set("default",this.parseFromSpriteSheet(r)),this.sources.set("default",r.image))}if(0===this.atlases.length)throw new Error("texture atlas format not supported");if(!1!==i){var o,a=_createForOfIteratorHelper(this.sources);try{for(a.s();!(o=a.n()).done;){var h=o.value;i instanceof me.Renderer.TextureCache?i.set(h,this):me.video.renderer.cache.set(h,this)}}catch(e){a.e(e)}finally{a.f()}}},createAtlas:function(e,t,i,n){return{meta:{app:"melonJS",size:{w:e,h:t},repeat:n||"no-repeat",image:"default"},frames:[{filename:i||"default",frame:{x:0,y:0,w:e,h:t}}]}},parse:function(e){var t={},i=this;return e.frames.forEach((function(n){if(n.hasOwnProperty("filename")){var r,s,o=n.frame,a=n.spriteSourceSize&&n.sourceSize&&n.pivot;a&&(r=n.sourceSize.w*n.pivot.x-(n.trimmed?n.spriteSourceSize.x:0),s=n.sourceSize.h*n.pivot.y-(n.trimmed?n.spriteSourceSize.y:0)),t[n.filename]={name:n.filename,texture:e.meta.image||"default",offset:new me.Vector2d(o.x,o.y),anchorPoint:a?new me.Vector2d(r/o.w,s/o.h):null,trimmed:!!n.trimmed,width:o.w,height:o.h,angle:!0===n.rotated?-me.Math.ETA:0},i.addUvsMap(t,n.filename,e.meta.size.w,e.meta.size.h)}})),t},parseFromSpriteSheet:function(e){var t={},i=e.image,n=e.spacing||0,r=e.margin||0,s=i.width,o=i.height,a=me.pool.pull("me.Vector2d",~~((s-r+n)/(e.framewidth+n)),~~((o-r+n)/(e.frameheight+n)));if(s%(e.framewidth+n)!=0||o%(e.frameheight+n)!=0){var h=a.x*(e.framewidth+n),l=a.y*(e.frameheight+n);h-s!==n&&l-o!==n&&(s=h,o=l,console.warn("Spritesheet Texture for image: "+i.src+" is not divisible by "+(e.framewidth+n)+"x"+(e.frameheight+n)+", truncating effective size to "+s+"x"+o))}for(var u=0,c=a.x*a.y;u<c;u++){var d=""+u;t[d]={name:d,texture:"default",offset:new me.Vector2d(r+(n+e.framewidth)*(u%a.x),r+(n+e.frameheight)*~~(u/a.x)),anchorPoint:e.anchorPoint||null,trimmed:!1,width:e.framewidth,height:e.frameheight,angle:0},this.addUvsMap(t,d,s,o)}return me.pool.push(a),t},addUvsMap:function(e,t,i,n){if(me.video.renderer instanceof me.WebGLRenderer){var r=e[t].offset,s=e[t].width,o=e[t].height;e[t].uvs=new Float32Array([r.x/i,r.y/n,(r.x+s)/i,(r.y+o)/n]),e[r.x+","+r.y+","+i+","+n]=e[t]}return e[t]},addQuadRegion:function(e,t,i,n,r){!0===me.video.renderer.settings.verbose&&console.warn("Adding texture region",e,"for texture",this);var s=this.getTexture(),o=this.getAtlas(),a=s.width,h=s.height;return o[e]={name:e,offset:new me.Vector2d(t,i),width:n,height:r,angle:0},this.addUvsMap(o,e,a,h),o[e]},getAtlas:function(e){return"string"==typeof e?this.atlases.get(e):this.atlases.values().next().value},getTexture:function(e){return"object"===_typeof(e)&&"string"==typeof e.texture?this.sources.get(e.texture):this.sources.values().next().value},getRegion:function(e,t){var i;return"string"==typeof t?i=this.getAtlas(t)[e]:this.atlases.forEach((function(t){void 0!==t[e]&&(i=t[e])})),i},getUVs:function(e){var t=this.getRegion(e);if(void 0===t){var i=e.split(","),n=+i[0],r=+i[1],s=+i[2],o=+i[3];t=this.addQuadRegion(e,n,r,s,o)}return t.uvs},createSpriteFromName:function(e,t){return me.pool.pull("me.Sprite",0,0,Object.assign({image:this,region:e},t||{}))},createAnimationFromName:function(e,t){for(var i,n=[],r={},s=0,o=0,a=0;a<e.length;++a){if(null==(i=this.getRegion(e[a])))throw new Error("Texture - region for "+e[a]+" not found");n[a]=i,r[e[a]]=a,s=Math.max(i.width,s),o=Math.max(i.height,o)}return new me.Sprite(0,0,Object.assign({image:this,framewidth:s,frameheight:o,margin:0,spacing:0,atlas:n,atlasIndices:r},t||{}))}}),me.Renderer.TextureCache=me.Object.extend({init:function(e){this.cache=new Map,this.tinted=new Map,this.units=new Map,this.max_size=e||1/0,this.clear()},clear:function(){this.cache.clear(),this.tinted.clear(),this.units.clear(),this.length=0},validate:function(){if(this.length>=this.max_size)throw new Error("Texture cache overflow: "+this.max_size+" texture units available for this GPU.")},get:function(e,t){return this.cache.has(e)||(t||(t=me.video.renderer.Texture.prototype.createAtlas.apply(me.video.renderer.Texture.prototype,[e.width,e.height,e.src?me.utils.file.getBasename(e.src):void 0])),this.set(e,new me.video.renderer.Texture(t,e,!1))),this.cache.get(e)},tint:function(e,t){var i=this.tinted.get(e);return void 0===i&&(i=this.tinted.set(e,new Map)),i.has(t)||i.set(t,me.video.renderer.tint(e,t,"multiply")),i.get(t)},set:function(e,t){var i=e.width,n=e.height;if(!(1!==me.video.renderer.WebGLVersion||me.Math.isPowerOfTwo(i)&&me.Math.isPowerOfTwo(n))){var r=void 0!==e.src?e.src:e;console.warn("[Texture] "+r+" is not a POT texture ("+i+"x"+n+")")}this.cache.set(e,t)},getUnit:function(e){return this.units.has(e)||(this.validate(),this.units.set(e,this.length++)),this.units.get(e)}}),me.CanvasRenderer=me.Renderer.extend({init:function(e){return this._super(me.Renderer,"init",[e]),this.context=this.getContext2d(this.getScreenCanvas(),this.settings.transparent),this.settings.doubleBuffering?(this.backBufferCanvas=me.video.createCanvas(this.settings.width,this.settings.height,!0),this.backBufferContext2D=this.getContext2d(this.backBufferCanvas)):(this.backBufferCanvas=this.getScreenCanvas(),this.backBufferContext2D=this.context),this.setBlendMode(this.settings.blendMode),this.setColor(this.currentColor),this.cache=new me.Renderer.TextureCache,!1===this.settings.textureSeamFix||this.settings.antiAlias||(this.uvOffset=1),this},reset:function(){this._super(me.Renderer,"reset"),this.clearColor(this.currentColor,!0!==this.settings.transparent)},resetTransform:function(){this.backBufferContext2D.setTransform(1,0,0,1,0,0)},setBlendMode:function(e,t){switch(t=t||this.getContext(),this.currentBlendMode=e,e){case"multiply":t.globalCompositeOperation="multiply";break;default:t.globalCompositeOperation="source-over",this.currentBlendMode="normal"}this.settings.doubleBuffering&&this.settings.transparent&&(this.context.globalCompositeOperation="copy")},clear:function(){this.settings.transparent&&this.clearColor("rgba(0,0,0,0)",!0)},flush:function(){this.settings.doubleBuffering&&this.context.drawImage(this.backBufferCanvas,0,0)},clearColor:function(e,t){this.save(),this.resetTransform(),this.backBufferContext2D.globalCompositeOperation=t?"copy":"source-over",this.backBufferContext2D.fillStyle=e instanceof me.Color?e.toRGBA():e,this.fillRect(0,0,this.backBufferCanvas.width,this.backBufferCanvas.height),this.restore()},clearRect:function(e,t,i,n){this.backBufferContext2D.clearRect(e,t,i,n)},createPattern:function(e,t){return this.backBufferContext2D.createPattern(e,t)},drawImage:function(e,t,i,n,r,s,o,a,h){if(!(this.backBufferContext2D.globalAlpha<1/255)){void 0===n?(n=a=e.width,r=h=e.height,s=t,o=i,t=0,i=0):void 0===s&&(s=t,o=i,a=n,h=r,n=e.width,r=e.height,t=0,i=0),!1===this.settings.subPixel&&(s=~~s,o=~~o);var l=e,u=this.currentTint.toArray();1===u[0]&&1===u[1]&&1===u[2]||(l=this.cache.tint(e,this.currentTint.toRGB())),this.backBufferContext2D.drawImage(l,t,i,n,r,s,o,a,h)}},drawPattern:function(e,t,i,n,r){if(!(this.backBufferContext2D.globalAlpha<1/255)){var s=this.backBufferContext2D.fillStyle;this.backBufferContext2D.fillStyle=e,this.backBufferContext2D.fillRect(t,i,n,r),this.backBufferContext2D.fillStyle=s}},strokeArc:function(e,t,i,n,r,s,o){var a=this.backBufferContext2D;a.globalAlpha<1/255||(a.translate(e,t),a.beginPath(),a.arc(0,0,i,n,r,s||!1),a[!0===o?"fill":"stroke"](),a.translate(-e,-t))},fillArc:function(e,t,i,n,r,s){this.strokeArc(e,t,i,n,r,s||!1,!0)},strokeEllipse:function(e,t,i,n,r){var s=this.backBufferContext2D;if(!(s.globalAlpha<1/255)){var o=e-i,a=e+i,h=t-n,l=t+n,u=.551784*i,c=.551784*n,d=e-u,f=e+u,p=t-c,m=t+c;s.beginPath(),s.moveTo(e,h),s.bezierCurveTo(f,h,a,p,a,t),s.bezierCurveTo(a,m,f,l,e,l),s.bezierCurveTo(d,l,o,m,o,t),s.bezierCurveTo(o,p,d,h,e,h),s[!0===r?"fill":"stroke"](),s.closePath()}},fillEllipse:function(e,t,i,n){this.strokeEllipse(e,t,i,n,!0)},strokeLine:function(e,t,i,n){var r=this.backBufferContext2D;r<1/255||(r.beginPath(),r.moveTo(e,t),r.lineTo(i,n),r.stroke())},fillLine:function(e,t,i,n){this.strokeLine(e,t,i,n)},strokePolygon:function(e,t){var i=this.backBufferContext2D;if(!(i.globalAlpha<1/255)){var n;this.translate(e.pos.x,e.pos.y),i.beginPath(),i.moveTo(e.points[0].x,e.points[0].y);for(var r=1;r<e.points.length;r++)n=e.points[r],i.lineTo(n.x,n.y);i.lineTo(e.points[0].x,e.points[0].y),i[!0===t?"fill":"stroke"](),i.closePath(),this.translate(-e.pos.x,-e.pos.y)}},fillPolygon:function(e){this.strokePolygon(e,!0)},strokeRect:function(e,t,i,n,r){if(!0===r)this.fillRect(e,t,i,n);else{if(this.backBufferContext2D.globalAlpha<1/255)return;this.backBufferContext2D.strokeRect(e,t,i,n)}},fillRect:function(e,t,i,n){this.backBufferContext2D.globalAlpha<1/255||this.backBufferContext2D.fillRect(e,t,i,n)},getContext:function(){return this.backBufferContext2D},getFontContext:function(){return this.getContext()},save:function(){this.backBufferContext2D.save()},restore:function(){this.backBufferContext2D.restore(),this.currentColor.glArray[3]=this.backBufferContext2D.globalAlpha,this.currentScissor[0]=0,this.currentScissor[1]=0,this.currentScissor[2]=this.backBufferCanvas.width,this.currentScissor[3]=this.backBufferCanvas.height},rotate:function(e){this.backBufferContext2D.rotate(e)},scale:function(e,t){this.backBufferContext2D.scale(e,t)},setColor:function(e){this.backBufferContext2D.strokeStyle=this.backBufferContext2D.fillStyle=e instanceof me.Color?e.toRGBA():e},setGlobalAlpha:function(e){this.backBufferContext2D.globalAlpha=this.currentColor.glArray[3]=e},setLineWidth:function(e){this.backBufferContext2D.lineWidth=e},setTransform:function(e){this.resetTransform(),this.transform(e)},transform:function(e){var t=e.toArray(),i=t[0],n=t[1],r=t[3],s=t[4],o=t[6],a=t[7];!1===this.settings.subPixel&&(o|=0,a|=0),this.backBufferContext2D.transform(i,n,r,s,o,a)},translate:function(e,t){!1===this.settings.subPixel?this.backBufferContext2D.translate(~~e,~~t):this.backBufferContext2D.translate(e,t)},clipRect:function(e,t,i,n){var r=this.backBufferCanvas;if(0!==e||0!==t||i!==r.width||n!==r.height){var s=this.currentScissor;if(s[0]!==e||s[1]!==t||s[2]!==i||s[3]!==n){var o=this.backBufferContext2D;o.beginPath(),o.rect(e,t,i,n),o.clip(),s[0]=e,s[1]=t,s[2]=i,s[3]=n}}},setMask:function(e){var t=this.backBufferContext2D,i=e.pos.x,n=e.pos.y;if(e instanceof me.Ellipse){var r=e.radiusV.x,s=e.radiusV.y,o=i-r,a=i+r,h=n-s,l=n+s,u=.551784*r,c=.551784*s,d=i-u,f=i+u,p=n-c,m=n+c;t.beginPath(),t.moveTo(i,h),t.bezierCurveTo(f,h,a,p,a,n),t.bezierCurveTo(a,m,f,l,i,l),t.bezierCurveTo(d,l,o,m,o,n),t.bezierCurveTo(o,p,d,h,i,h)}else{var g;t.save(),t.beginPath(),t.moveTo(i+e.points[0].x,n+e.points[0].y);for(var v=1;v<e.points.length;v++)g=e.points[v],t.lineTo(i+g.x,n+g.y);t.closePath()}t.clip()},clearMask:function(){this.backBufferContext2D.restore()}}),me.WebGLRenderer=me.Renderer.extend({init:function(e){var t=this;this._super(me.Renderer,"init",[e]),this.context=this.gl=this.getContextGL(this.getScreenCanvas(),e.transparent),this.webGLVersion=1,this.GPUVendor=null,this.GPURenderer=null,this.maxTextures=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this._colorStack=[],this._matrixStack=[],this._scissorStack=[],this._glPoints=[new me.Vector2d,new me.Vector2d,new me.Vector2d,new me.Vector2d],this.currentTransform=new me.Matrix2d,this.currentCompositor=null;var i=this.settings.compositor||me.WebGLCompositor;this.setCompositor(new i(this)),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.enable(this.gl.BLEND),this.setBlendMode(this.settings.blendMode);var n=this.gl.getExtension("WEBGL_debug_renderer_info");return null!==n&&(this.GPUVendor=this.gl.getParameter(n.UNMASKED_VENDOR_WEBGL),this.GPURenderer=this.gl.getParameter(n.UNMASKED_RENDERER_WEBGL)),this.cache=new me.Renderer.TextureCache(this.maxTextures),this.getScreenCanvas().addEventListener("webglcontextlost",(function(e){e.preventDefault(),t.isContextValid=!1,me.event.publish(me.event.WEBGL_ONCONTEXT_LOST,[t])}),!1),this.getScreenCanvas().addEventListener("webglcontextrestored",(function(e){t.reset(),t.isContextValid=!0,me.event.publish(me.event.WEBGL_ONCONTEXT_RESTORED,[t])}),!1),this},reset:function(){this._super(me.Renderer,"reset"),!1===this.isContextValid?this.currentCompositor.init(this):this.currentCompositor.reset(),this.gl.disable(this.gl.SCISSOR_TEST),void 0!==this.fontContext2D&&this.createFontTexture(this.cache)},setCompositor:function(e){null!==this.currentCompositor&&this.currentCompositor!==e&&this.currentCompositor.flush(),this.currentCompositor=e},resetTransform:function(){this.currentTransform.identity()},createFontTexture:function(e){if(void 0===this.fontTexture){var t=this.backBufferCanvas,i=t.width,n=t.height;1===this.WebGLVersion&&(me.Math.isPowerOfTwo(i)||(i=me.Math.nextPowerOfTwo(t.width)),me.Math.isPowerOfTwo(n)||(n=me.Math.nextPowerOfTwo(t.height)));var r=me.video.createCanvas(i,n,!0);this.fontContext2D=this.getContext2d(r),this.fontTexture=new this.Texture(this.Texture.prototype.createAtlas.apply(this.Texture.prototype,[t.width,t.height,"fontTexture"]),r,e),this.currentCompositor.uploadTexture(this.fontTexture,0,0,0)}else e.set(this.fontContext2D.canvas,this.fontTexture)},createPattern:function(e,t){if(!(1!==me.video.renderer.WebGLVersion||me.Math.isPowerOfTwo(e.width)&&me.Math.isPowerOfTwo(e.height))){var i=void 0!==e.src?e.src:e;throw new Error("[WebGL Renderer] "+i+" is not a POT texture ("+e.width+"x"+e.height+")")}var n=new this.Texture(this.Texture.prototype.createAtlas.apply(this.Texture.prototype,[e.width,e.height,"pattern",t]),e);return this.currentCompositor.uploadTexture(n),n},flush:function(){this.currentCompositor.flush()},clearColor:function(e,t){var i;this.save(),i=e instanceof me.Color?e.toArray():this.getColor().parseCSS(e).toArray(),this.currentCompositor.clearColor(i[0],i[1],i[2],!0===t?1:i[3]),this.currentCompositor.clear(),this.currentCompositor.clearColor(0,0,0,0),this.restore()},clearRect:function(e,t,i,n){var r=this.currentColor.clone();this.currentColor.copy("#000000"),this.fillRect(e,t,i,n),this.currentColor.copy(r),me.pool.push(r)},drawFont:function(e){var t=this.getFontContext();this.currentCompositor.uploadTexture(this.fontTexture,0,0,0,!0);var i=e.pos.x+","+e.pos.y+","+e.width+","+e.height;this.currentCompositor.addQuad(this.fontTexture,i,e.pos.x,e.pos.y,e.width,e.height),t.clearRect(e.pos.x,e.pos.y,e.width,e.height)},drawImage:function(e,t,i,n,r,s,o,a,h){void 0===n?(n=a=e.width,r=h=e.height,s=t,o=i,t=0,i=0):void 0===s&&(s=t,o=i,a=n,h=r,n=e.width,r=e.height,t=0,i=0),!1===this.settings.subPixel&&(s|=0,o|=0);var l=t+","+i+","+n+","+r;this.currentCompositor.addQuad(this.cache.get(e),l,s,o,a,h)},drawPattern:function(e,t,i,n,r){var s="0,0,"+n+","+r;this.currentCompositor.addQuad(e,s,t,i,n,r)},getScreenContext:function(){return this.gl},getContextGL:function(e,t){if(null==e)throw new Error("You must pass a canvas element in order to create a GL context");"boolean"!=typeof t&&(t=!0);var i,n={alpha:t,antialias:this.settings.antiAlias,depth:!1,stencil:!0,preserveDrawingBuffer:!1,premultipliedAlpha:t,powerPreference:this.settings.powerPreference,failIfMajorPerformanceCaveat:this.settings.failIfMajorPerformanceCaveat};if(!1===this.settings.preferWebGL1&&(i=e.getContext("webgl2",n))&&(this.WebGLVersion=2),i||(this.WebGLVersion=1,i=e.getContext("webgl",n)||e.getContext("experimental-webgl",n)),!i)throw new Error("A WebGL context could not be created.");return i},getContext:function(){return this.gl},setBlendMode:function(e,t){switch((t=t||this.gl).enable(t.BLEND),e){case"multiply":t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.currentBlendMode=e;break;default:t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),this.currentBlendMode="normal"}},getFontContext:function(){return void 0===this.fontContext2D&&(console.warn("[WebGL Renderer] WARNING : Using Standard me.Text with WebGL will severly impact performances !"),this.createFontTexture(this.cache)),this.fontContext2D},restore:function(){if(0!==this._matrixStack.length){var e=this._colorStack.pop(),t=this._matrixStack.pop();this.currentColor.copy(e),this.currentTransform.copy(t),me.pool.push(e),me.pool.push(t)}0!==this._scissorStack.length?this.currentScissor.set(this._scissorStack.pop()):(this.gl.disable(this.gl.SCISSOR_TEST),this.currentScissor[0]=0,this.currentScissor[1]=0,this.currentScissor[2]=this.backBufferCanvas.width,this.currentScissor[3]=this.backBufferCanvas.height)},save:function(){this._colorStack.push(this.currentColor.clone()),this._matrixStack.push(this.currentTransform.clone()),this.gl.isEnabled(this.gl.SCISSOR_TEST)&&this._scissorStack.push(this.currentScissor.slice())},rotate:function(e){this.currentTransform.rotate(e)},scale:function(e,t){this.currentTransform.scale(e,t)},setAntiAlias:function(e,t){this._super(me.Renderer,"setAntiAlias",[e,t])},setGlobalAlpha:function(e){this.currentColor.glArray[3]=e},setColor:function(e){var t=this.currentColor.glArray[3];this.currentColor.copy(e),this.currentColor.glArray[3]*=t},setLineWidth:function(e){this.getScreenContext().lineWidth(e)},strokeArc:function(e,t,i,n,r,s,o){if(!0===o)this.fillArc(e,t,i,n,r,s);else{var a,h=this._glPoints,l=Math.floor(24*Math.sqrt(2*i)),u=(r-n)/(2*l),c=2*u,d=Math.cos(u),f=Math.sin(u);for(a=h.length;a<l+1;a++)h.push(new me.Vector2d);for(a=0;a<l;a++){var p=u+n+c*a,m=Math.cos(p),g=-Math.sin(p);h[a].x=e+(d*m+f*g)*i,h[a].y=t+(d*-g+f*m)*i}this.currentCompositor.drawVertices(this.gl.LINE_STRIP,h,l)}},fillArc:function(e,t,i,n,r,s){var o,a=this._glPoints,h=0,l=Math.floor(24*Math.sqrt(2*i)),u=(r-n)/(2*l),c=2*u,d=Math.cos(u),f=Math.sin(u);for(o=a.length;o<2*l;o++)a.push(new me.Vector2d);for(o=0;o<l-1;o++){var p=u+n+c*o,m=Math.cos(p),g=-Math.sin(p);a[h++].set(e,t),a[h++].set(e-(d*m+f*g)*i,t-(d*-g+f*m)*i)}this.currentCompositor.drawVertices(this.gl.TRIANGLE_STRIP,a,h)},strokeEllipse:function(e,t,i,n,r){if(!0===r)this.fillEllipse(e,t,i,n);else{var s,o=Math.floor(24*Math.sqrt(i))||Math.floor(12*Math.sqrt(i+n)),a=me.Math.TAU/o,h=this._glPoints;for(s=h.length;s<o;s++)h.push(new me.Vector2d);for(s=0;s<o;s++)h[s].x=e+Math.sin(a*-s)*i,h[s].y=t+Math.cos(a*-s)*n;this.currentCompositor.drawVertices(this.gl.LINE_LOOP,h,o)}},fillEllipse:function(e,t,i,n){var r,s=Math.floor(24*Math.sqrt(i))||Math.floor(12*Math.sqrt(i+n)),o=me.Math.TAU/s,a=this._glPoints,h=0;for(r=a.length;r<2*(s+1);r++)a.push(new me.Vector2d);for(r=0;r<s+1;r++)a[h++].set(e,t),a[h++].set(e+Math.sin(o*r)*i,t+Math.cos(o*r)*n);this.currentCompositor.drawVertices(this.gl.TRIANGLE_STRIP,a,h)},strokeLine:function(e,t,i,n){var r=this._glPoints;r[0].x=e,r[0].y=t,r[1].x=i,r[1].y=n,this.currentCompositor.drawVertices(this.gl.LINE_STRIP,r,2)},fillLine:function(e,t,i,n){this.strokeLine(e,t,i,n)},strokePolygon:function(e,t){if(!0===t)this.fillPolygon(e);else{var i,n=e.points.length,r=this._glPoints;for(i=r.length;i<n;i++)r.push(new me.Vector2d);for(i=0;i<n;i++)r[i].x=e.pos.x+e.points[i].x,r[i].y=e.pos.y+e.points[i].y;this.currentCompositor.drawVertices(this.gl.LINE_LOOP,r,n)}},fillPolygon:function(e){var t,i=e.points,n=this._glPoints,r=e.getIndices(),s=e.pos.x,o=e.pos.y;for(t=n.length;t<r.length;t++)n.push(new me.Vector2d);for(t=0;t<r.length;t++)n[t].set(s+i[r[t]].x,o+i[r[t]].y);this.currentCompositor.drawVertices(this.gl.TRIANGLES,n,r.length)},strokeRect:function(e,t,i,n,r){if(!0===r)this.fillRect(e,t,i,n);else{var s=this._glPoints;s[0].x=e,s[0].y=t,s[1].x=e+i,s[1].y=t,s[2].x=e+i,s[2].y=t+n,s[3].x=e,s[3].y=t+n,this.currentCompositor.drawVertices(this.gl.LINE_LOOP,s,4)}},fillRect:function(e,t,i,n){var r=this._glPoints;r[0].x=e+i,r[0].y=t,r[1].x=e,r[1].y=t,r[2].x=e+i,r[2].y=t+n,r[3].x=e,r[3].y=t+n,this.currentCompositor.drawVertices(this.gl.TRIANGLE_STRIP,r,4)},setTransform:function(e){this.resetTransform(),this.transform(e)},transform:function(e){var t=this.currentTransform;if(t.multiply(e),!1===this.settings.subPixel){var i=t.toArray();i[6]|=0,i[7]|=0}},translate:function(e,t){var i=this.currentTransform;if(i.translate(e,t),!1===this.settings.subPixel){var n=i.toArray();n[6]|=0,n[7]|=0}},clipRect:function(e,t,i,n){var r=this.backBufferCanvas,s=this.gl;if(0!==e||0!==t||i!==r.width||n!==r.height){var o=this.currentScissor;if(s.isEnabled(s.SCISSOR_TEST)&&o[0]===e&&o[1]===t&&o[2]===i&&o[3]===n)return;this.flush(),s.enable(this.gl.SCISSOR_TEST),s.scissor(e+this.currentTransform.tx,r.height-n-t-this.currentTransform.ty,i,n),o[0]=e,o[1]=t,o[2]=i,o[3]=n}else s.disable(s.SCISSOR_TEST)},setMask:function(e){var t=this.gl;this.flush(),t.enable(t.STENCIL_TEST),t.clear(t.STENCIL_BUFFER_BIT),t.colorMask(!1,!1,!1,!1),t.stencilFunc(t.NOTEQUAL,1,1),t.stencilOp(t.REPLACE,t.REPLACE,t.REPLACE),this.fill(e),this.flush(),t.colorMask(!0,!0,!0,!0),t.stencilFunc(t.EQUAL,1,1),t.stencilOp(t.KEEP,t.KEEP,t.KEEP)},clearMask:function(){this.flush(),this.gl.disable(this.gl.STENCIL_TEST)}});var primitiveVertex="// Current vertex point\nattribute vec2 aVertex;\n\n// Projection matrix\nuniform mat4 uProjectionMatrix;\n\n// Vertex color\nuniform vec4 uColor;\n\n// Fragment color\nvarying vec4 vColor;\n\nvoid main(void) {\n    // Transform the vertex position by the projection matrix\n    gl_Position = uProjectionMatrix * vec4(aVertex, 0.0, 1.0);\n    // Pass the remaining attributes to the fragment shader\n    vColor = vec4(uColor.rgb * uColor.a, uColor.a);\n}\n",primitiveFragment="varying vec4 vColor;\n\nvoid main(void) {\n    gl_FragColor = vColor;\n}\n",quadVertex="attribute vec2 aVertex;\nattribute vec2 aRegion;\nattribute vec4 aColor;\n\nuniform mat4 uProjectionMatrix;\n\nvarying vec2 vRegion;\nvarying vec4 vColor;\n\nvoid main(void) {\n    // Transform the vertex position by the projection matrix\n     gl_Position = uProjectionMatrix * vec4(aVertex, 0.0, 1.0);\n    // Pass the remaining attributes to the fragment shader\n    vColor = vec4(aColor.rgb * aColor.a, aColor.a);\n    vRegion = aRegion;\n}\n",quadFragment="uniform sampler2D uSampler;\nvarying vec4 vColor;\nvarying vec2 vRegion;\n\nvoid main(void) {\n    gl_FragColor = texture2D(uSampler, vRegion) * vColor;\n}\n",ELEMENT_OFFSET,viewportOffset,_toHex,rgbaRx,hex3Rx,hex4Rx,hex6Rx,hex8Rx,cssToRGB,offsetsStaggerX,offsetsStaggerY,a,singleton,Entity,Input,Event,Vector,canvas,context,pixel;ELEMENT_OFFSET=8*Float32Array.BYTES_PER_ELEMENT,me.WebGLCompositor=me.Object.extend({init:function(e){var t=e.gl;this.length=0,this.currentTextureUnit=-1,this.boundTextures=[],this.v=[new me.Vector2d,new me.Vector2d,new me.Vector2d,new me.Vector2d],this.renderer=e,this.gl=e.gl,this.color=e.currentColor,this.tint=e.currentTint,this.viewMatrix=e.currentTransform,this.activeShader=null,this.mode=t.TRIANGLES,this.attributes=[],this.primitiveShader=new me.GLShader(this.gl,primitiveVertex,primitiveFragment),this.quadShader=new me.GLShader(this.gl,quadVertex,quadFragment),this.addAttribute("aVertex",2,t.FLOAT,!1,0*Float32Array.BYTES_PER_ELEMENT),this.addAttribute("aRegion",2,t.FLOAT,!1,2*Float32Array.BYTES_PER_ELEMENT),this.addAttribute("aColor",4,t.FLOAT,!1,4*Float32Array.BYTES_PER_ELEMENT),t.bindBuffer(t.ARRAY_BUFFER,t.createBuffer()),t.bufferData(t.ARRAY_BUFFER,16e3*ELEMENT_OFFSET*4,t.STREAM_DRAW),this.sbSize=256,this.sbIndex=0,this.stream=new Float32Array(8*this.sbSize*4),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,t.createBuffer()),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.createIB(),t.STATIC_DRAW),me.event.subscribe(me.event.CANVAS_ONRESIZE,function(e,t){this.flush(),this.setViewport(0,0,e,t)}.bind(this)),this.reset()},reset:function(){this.sbIndex=0,this.length=0,this.gl=this.renderer.gl,this.flush(),this.setViewport(0,0,this.renderer.getScreenCanvas().width,this.renderer.getScreenCanvas().height),this.clearColor(0,0,0,0);for(var e=0;e<this.renderer.maxTextures;e++){var t=this.boundTextures[e];null!==t&&this.gl.deleteTexture(t),this.boundTextures[e]=null}this.currentTextureUnit=-1,this.useShader(this.quadShader)},addAttribute:function(e,t,i,n,r){this.attributes.push({name:e,size:t,type:i,normalized:n,offset:r})},setViewport:function(e,t,i,n){this.gl.viewport(e,t,i,n)},createTexture2D:function(e,t,i,n,r,s,o,a,h){var l=this.gl;n=n||"no-repeat";var u=me.Math.isPowerOfTwo(r||t.width)&&me.Math.isPowerOfTwo(s||t.height),c=l.createTexture(),d=0!==n.search(/^repeat(-x)?$/)||!u&&2!==this.renderer.WebGLVersion?l.CLAMP_TO_EDGE:l.REPEAT,f=0!==n.search(/^repeat(-y)?$/)||!u&&2!==this.renderer.WebGLVersion?l.CLAMP_TO_EDGE:l.REPEAT;return this.setTexture2D(c,e),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,d),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,f),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,i),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,i),l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,"boolean"!=typeof a||a),r||s||o?l.texImage2D(l.TEXTURE_2D,0,l.RGBA,r,s,o,l.RGBA,l.UNSIGNED_BYTE,t):l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,t),u&&!1!==h&&l.generateMipmap(l.TEXTURE_2D),c},setTexture2D:function(e,t){var i=this.gl;e!==this.boundTextures[t]?(this.flush(),this.currentTextureUnit!==t&&(this.currentTextureUnit=t,i.activeTexture(i.TEXTURE0+t)),i.bindTexture(i.TEXTURE_2D,e),this.boundTextures[t]=e):this.currentTextureUnit!==t&&(this.flush(),this.currentTextureUnit=t,i.activeTexture(i.TEXTURE0+t))},uploadTexture:function(e,t,i,n,r){var s=this.renderer.cache.getUnit(e),o=this.boundTextures[s];return null===o||r?this.createTexture2D(s,e.getTexture(),this.renderer.settings.antiAlias?this.gl.LINEAR:this.gl.NEAREST,e.repeat,t,i,n,e.premultipliedAlpha):this.setTexture2D(o,s),this.currentTextureUnit},createIB:function(){for(var e=[0,1,2,2,1,3],t=new Array(96e3),i=0;i<t.length;i++)t[i]=e[i%6]+4*~~(i/6);return new Uint16Array(t)},resizeSB:function(){this.sbSize<<=1;var e=new Float32Array(8*this.sbSize*4);e.set(this.stream),this.stream=e},useShader:function(e){if(this.activeShader!==e){this.flush(),this.activeShader=e,this.activeShader.bind(),this.activeShader.setUniform("uProjectionMatrix",this.renderer.projectionMatrix);for(var t=0;t<this.attributes.length;++t){var i=this.gl,n=this.attributes[t],r=this.activeShader.getAttribLocation(n.name);-1!==r?(i.enableVertexAttribArray(r),i.vertexAttribPointer(r,n.size,n.type,n.normalized,ELEMENT_OFFSET,n.offset)):i.disableVertexAttribArray(t)}}},addQuad:function(e,t,i,n,r,s){var o=this.color.toArray(),a=this.tint.toArray();if(!(o[3]<1/255)){a[3]=o[3],this.length>=16e3&&this.flush(),this.length>=this.sbSize&&this.resizeSB(),this.useShader(this.quadShader);var h=this.uploadTexture(e);this.quadShader.setUniform("uSampler",h);var l=this.viewMatrix,u=this.v[0].set(i,n),c=this.v[1].set(i+r,n),d=this.v[2].set(i,n+s),f=this.v[3].set(i+r,n+s);l.isIdentity()||(l.apply(u),l.apply(c),l.apply(d),l.apply(f));var p=this.sbIndex,m=p+8,g=m+8,v=g+8;this.stream[p+0+0]=u.x,this.stream[p+0+1]=u.y,this.stream[m+0+0]=c.x,this.stream[m+0+1]=c.y,this.stream[g+0+0]=d.x,this.stream[g+0+1]=d.y,this.stream[v+0+0]=f.x,this.stream[v+0+1]=f.y;var y=e.getUVs(t);this.stream[p+2+0]=y[0],this.stream[p+2+1]=y[1],this.stream[m+2+0]=y[2],this.stream[m+2+1]=y[1],this.stream[g+2+0]=y[0],this.stream[g+2+1]=y[3],this.stream[v+2+0]=y[2],this.stream[v+2+1]=y[3],this.stream.set(a,p+4),this.stream.set(a,m+4),this.stream.set(a,g+4),this.stream.set(a,v+4),this.sbIndex+=32,this.length++}},flush:function(){if(this.length){var e=this.gl,t=8*this.length*4;e.bufferData(e.ARRAY_BUFFER,this.stream.subarray(0,t),e.STREAM_DRAW),e.drawElements(this.mode,6*this.length,e.UNSIGNED_SHORT,0),this.sbIndex=0,this.length=0}},drawVertices:function(e,t,i){var n=this.gl;i=i||t.length,this.useShader(this.primitiveShader),this.primitiveShader.setUniform("uColor",this.color);for(var r=0,s=this.viewMatrix,o=s.isIdentity(),a=0;a<i;a++)o||s.apply(t[a]),this.stream[r+0]=t[a].x,this.stream[r+1]=t[a].y,r+=8;n.bufferData(n.ARRAY_BUFFER,this.stream.subarray(0,8*i),n.STREAM_DRAW),n.drawArrays(e,0,i)},clearColor:function(e,t,i,n){this.gl.clearColor(e,t,i,n)},clear:function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}),function(){function e(e,t,i){var n=e.createShader(t);if(e.shaderSource(n,i),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(n));return n}var t={bool:"1i",int:"1i",float:"1f",vec2:"2fv",vec3:"3fv",vec4:"4fv",bvec2:"2iv",bvec3:"3iv",bvec4:"4iv",ivec2:"2iv",ivec3:"3iv",ivec4:"4iv",mat2:"Matrix2fv",mat3:"Matrix3fv",mat4:"Matrix4fv",sampler2D:"1i"};function i(e,t){return"precision"!==e.substring(0,9)?"precision "+t+" float;"+e:e}function n(e){return e=(e=(e=(e=e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")).replace(/(\\n\s+)|(\s+\\n)/g,"")).replace(/(\\r|\\n)+/g,"")).replace(/\s*([;,[\](){}\\\/\-+*|^&!=<>?~%])\s*/g,"$1")}me.GLShader=me.Object.extend({init:function(r,s,o,a){return this.gl=r,this.vertex=i(n(s),a||me.device.getMaxShaderPrecision(this.gl)),this.fragment=i(n(o),a||me.device.getMaxShaderPrecision(this.gl)),this.attributes=function(e,t){for(var i,n={},r=/attribute\s+\w+\s+(\w+)/g,s=0;i=r.exec(t.vertex);)n[i[1]]=s++;return n}(this.gl,this),this.program=function(t,i,n,r){var s=e(t,t.VERTEX_SHADER,i),o=e(t,t.FRAGMENT_SHADER,n),a=t.createProgram();for(var h in t.attachShader(a,s),t.attachShader(a,o),r)t.bindAttribLocation(a,r[h],h);if(t.linkProgram(a),!t.getProgramParameter(a,t.LINK_STATUS)){var l="Error initializing Shader "+this+"\ngl.VALIDATE_STATUS: "+t.getProgramParameter(a,t.VALIDATE_STATUS)+"\ngl.getError()"+t.getError()+"\ngl.getProgramInfoLog()"+t.getProgramInfoLog(a);throw t.deleteProgram(a),a=null,new Error(l)}return t.useProgram(a),t.deleteShader(s),t.deleteShader(o),a}(this.gl,this.vertex,this.fragment,this.attributes),this.uniforms=function(e,i){var n,r={},s=/uniform\s+(\w+)\s+(\w+)/g,o={},a={},h={};return[i.vertex,i.fragment].forEach((function(e){for(;n=s.exec(e);)o[n[2]]=n[1]})),Object.keys(o).forEach((function(n){var r=o[n];h[n]=e.getUniformLocation(i.program,n),a[n]={get:function(e){return function(){return h[e]}}(n),set:function(t,i,n){return 0===i.indexOf("mat")?function(i){e[n](h[t],!1,i)}:function(i){var r=n;i.length&&"v"!==n.substr(-1)&&(r+="v"),e[r](h[t],i)}}(n,r,"uniform"+t[r])}})),Object.defineProperties(r,a),r}(this.gl,this),me.event.subscribe(me.event.WEBGL_ONCONTEXT_LOST,this.destroy.bind(this)),this},bind:function(){this.gl.useProgram(this.program)},getAttribLocation:function(e){var t=this.attributes[e];return void 0!==t?t:-1},setUniform:function(e,t){var i=this.uniforms;if(void 0===i[e])throw new Error("undefined ("+e+") uniform for shader "+this);"object"===_typeof(t)&&"function"==typeof t.toArray?i[e]=t.toArray():i[e]=t},destroy:function(){this.uniforms=null,this.attributes=null,this.gl.deleteProgram(this.program),this.vertex=null,this.fragment=null}})}(),viewportOffset=new me.Vector2d,me.Pointer=me.Rect.extend({init:function(e,t,i,n){this.event=void 0,this.type=void 0,this.button=0,this.isPrimary=!1,this.pageX=0,this.pageY=0,this.clientX=0,this.clientY=0,this.deltaMode=0,this.deltaX=0,this.deltaY=0,this.deltaZ=0,this.gameX=0,this.gameY=0,this.gameScreenX=0,this.gameScreenY=0,this.gameWorldX=0,this.gameWorldY=0,this.gameLocalX=0,this.gameLocalY=0,this.pointerId=void 0,this._super(me.Rect,"init",[e||0,t||0,i||1,n||1])},setEvent:function(e,t,i,n,r,s){var o=1,a=1;this.event=e,this.pageX=t||0,this.pageY=i||0,this.clientX=n||0,this.clientY=r||0,me.input.globalToLocal(this.pageX,this.pageY,this.pos),this.isNormalized=!me.device.PointerEvent||me.device.PointerEvent&&!(e instanceof window.PointerEvent),"wheel"===e.type?(this.deltaMode=e.deltaMode||0,this.deltaX=e.deltaX||0,this.deltaY=e.deltaY||0,this.deltaZ=e.deltaZ||0):(this.deltaMode=0,this.deltaX=0,this.deltaY=0,this.deltaZ=0),this.pointerId=void 0!==s?s:1,this.isPrimary=void 0===e.isPrimary||e.isPrimary,this.button=e.button||0,this.type=e.type,this.gameScreenX=this.pos.x,this.gameScreenY=this.pos.y,void 0!==me.game.viewport&&me.game.viewport.localToWorld(this.gameScreenX,this.gameScreenY,viewportOffset),this.gameWorldX=viewportOffset.x,this.gameWorldY=viewportOffset.y,!1===this.isNormalized?(o=e.width||1,a=e.height||1):"number"==typeof e.radiusX&&(o=2*e.radiusX||1,a=2*e.radiusY||1),this.resize(o,a)}}),me.input={keyBoardEventTarget:null,pointerEventTarget:null,preventDefault:!0},function(e){var t={},i={},n={},r={},s={},o={},a=function(e,i,a){i=i||e.keyCode||e.button;var h=o[i];if(me.event.publish(me.event.KEYDOWN,[h,i,!h||!n[h]]),h){if(!n[h]){var l=void 0!==a?a:i;r[h][l]||(t[h]++,r[h][l]=!0)}return!s[i]||"function"!=typeof e.preventDefault||e.preventDefault()}return!0},h=function(e,i,a){i=i||e.keyCode||e.button;var h=o[i];if(me.event.publish(me.event.KEYUP,[h,i]),h){var l=void 0!==a?a:i;return r[h][l]=void 0,t[h]>0&&t[h]--,n[h]=!1,!s[i]||"function"!=typeof e.preventDefault||e.preventDefault()}return!0};e.KEY={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,PRINT_SCREEN:42,INSERT:45,DELETE:46,NUM0:48,NUM1:49,NUM2:50,NUM3:51,NUM4:52,NUM5:53,NUM6:54,NUM7:55,NUM8:56,NUM9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,WINDOW_KEY:91,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,TILDE:126,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,PLUS:187,COMMA:188,MINUS:189,PERIOD:190,FORWAND_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222},e.initKeyboardEvent=function(){null===me.input.keyBoardEventTarget&&!1===me.device.isMobile&&(me.input.keyBoardEventTarget=window,me.input.keyBoardEventTarget.addEventListener("keydown",a,!1),me.input.keyBoardEventTarget.addEventListener("keyup",h,!1))},e.isKeyPressed=function(e){return!(!t[e]||n[e])&&(i[e]&&(n[e]=!0),!0)},e.keyStatus=function(e){return t[e]>0},e.triggerKeyEvent=function(e,t,i){!0===t?a({},e,i):h({},e,i)},e.bindKey=function(e,a,h,l){"boolean"!=typeof l&&(l=me.input.preventDefault),o[e]=a,s[e]=l,t[a]=0,i[a]=h||!1,n[a]=!1,r[a]={}},e.getBindingKey=function(e){return o[e]},e.unlockKey=function(e){n[e]=!1},e.unbindKey=function(e){var n=o[e];t[n]=0,i[n]=!1,r[n]={},o[e]=null,s[e]=null}}(me.input),function(e){var t=[],i=new Map,n=new me.Rect(0,0,1,1),r=!1,s=0,o=[],a=["wheel"],h=["pointermove","mousemove","touchmove"],l=["pointerdown","mousedown","touchstart"],u=["pointerup","mouseup","touchend"],c=["pointercancel","mousecancel","touchcancel"],d=["pointerenter","mouseenter","touchenter"],f=["pointerover","mouseover","touchover"],p=["pointerleave","mouseleave","touchleave"],m=[a[0],h[0],l[0],u[0],c[0],d[0],f[0],p[0]],g=[a[0],h[1],l[1],u[1],c[1],d[1],f[1],p[1]],v=[h[2],l[2],u[2],c[2],d[2],f[2],p[2]],y={wheel:a,pointermove:h,pointerdown:l,pointerup:u,pointercancel:c,pointerenter:d,pointerover:f,pointerleave:p},_=[];function x(){if(!r){for(var i=0;i<me.device.maxTouchPoints;i++)t.push(new me.Pointer);var n;null===me.input.pointerEventTarget&&(me.input.pointerEventTarget=me.video.renderer.getScreenCanvas()),o=me.device.PointerEvent?m:g,me.device.touch&&!me.device.PointerEvent&&(o=o.concat(v)),function(t,i){for(var n=0;n<t.length;n++)-1===h.indexOf(t[n])&&me.input.pointerEventTarget.addEventListener(t[n],i,{passive:!1===e.preventDefault})}(o,C),void 0===e.throttlingInterval&&(e.throttlingInterval=~~(1e3/me.timer.maxfps)),!0===me.sys.autoFocus&&(me.device.focus(),me.input.pointerEventTarget.addEventListener(o[2],(function(){me.device.focus()}),{passive:!1===e.preventDefault}));var s=b(o,h);if(e.throttlingInterval<17)for(n=0;n<s.length;n++)-1!==o.indexOf(s[n])&&me.input.pointerEventTarget.addEventListener(s[n],S,{passive:!0});else for(n=0;n<s.length;n++)-1!==o.indexOf(s[n])&&me.input.pointerEventTarget.addEventListener(s[n],me.utils.function.throttle(S,e.throttlingInterval,!1),{passive:!0});me.input.setTouchAction(me.input.pointerEventTarget),r=!0}}function w(e,t){for(var i=0;i<t.length;i++){if(-1!==e.indexOf(t[i]))return t[i]}}function b(e,t){for(var i=[],n=0;n<t.length;n++){-1!==e.indexOf(t[n])&&i.push(t[n])}return i}function T(e,t,i,n){var r;if(e.callbacks[t]){e.pointerId=n;for(var s=e.callbacks[t].length-1;s>=0&&(r=e.callbacks[t][s]);s--)if(!1===r(i))return!0}return!1}function A(e){for(var r=!1;e.length>0;){var a=e.pop();if(t.push(a),void 0!==a.event.timeStamp){if(a.event.timeStamp<s)continue;s=a.event.timeStamp}n.setShape(a.gameWorldX,a.gameWorldY,a.width,a.height),h.includes(a.type)&&(a.gameX=a.gameLocalX=a.gameScreenX,a.gameY=a.gameLocalY=a.gameScreenY,me.event.publish(me.event.POINTERMOVE,[a]));for(var l,f=me.game.world.broadphase.retrieve(n,me.Container.prototype._sortReverseZ),m=(f=f.concat([me.game.viewport])).length;l=f[--m];){if(i.has(l)&&!0!==l.isKinematic){var g=i.get(l),v=g.region,y=v.ancestor,_=v.getBounds(),x=!1;if(!0===v.floating?(a.gameX=a.gameLocalX=a.gameScreenX,a.gameY=a.gameLocalY=a.gameScreenY):(a.gameX=a.gameLocalX=a.gameWorldX,a.gameY=a.gameLocalY=a.gameWorldY),void 0!==y){var b=y.getBounds().pos;a.gameLocalX=a.gameX-b.x,a.gameLocalY=a.gameY-b.y}if(v instanceof me.Sprite){var A=a.gameX,E=a.gameY;if(!v.currentTransform.isIdentity()){var S=v.currentTransform.applyInverse(me.pool.pull("me.Vector2d",A,E));A=S.x,E=S.y,me.pool.push(S)}x=_.containsPoint(A,E)}else x=_.containsPoint(a.gameX,a.gameY)&&(_===v||v.containsPoint(a.gameLocalX,a.gameLocalY));switch(a.type){case h[0]:case h[1]:case h[2]:case h[3]:if(g.pointerId!==a.pointerId||x){if(null===g.pointerId&&x&&T(g,w(o,d),a,a.pointerId)){r=!0;break}}else if(T(g,w(o,p),a,null)){r=!0;break}if(x&&T(g,a.type,a,a.pointerId)){r=!0;break}break;case u[0]:case u[1]:case u[2]:case u[3]:if(g.pointerId===a.pointerId&&x&&T(g,a.type,a,null)){r=!0;break}break;case c[0]:case c[1]:case c[2]:case c[3]:if(g.pointerId===a.pointerId&&T(g,a.type,a,null)){r=!0;break}break;default:if(x&&T(g,a.type,a,a.pointerId)){r=!0;break}}}if(!0===r)break}}return r}function E(i){var n;if(me.device.TouchEvent&&i.changedTouches)for(var r=0,s=i.changedTouches.length;r<s;r++){var o=i.changedTouches[r];(n=t.pop()).setEvent(i,o.pageX,o.pageY,o.clientX,o.clientY,o.identifier),_.push(n)}else(n=t.pop()).setEvent(i,i.pageX,i.pageY,i.clientX,i.clientY,i.pointerId),_.push(n);return!1===i.isPrimary||(_[0].isPrimary=!0,Object.assign(e.pointer,_[0])),_}function S(e){A(E(e))}function C(t){E(t);var i=_[0].button;(A(_)||"wheel"===t.type)&&!0===e.preventDefault&&t.preventDefault();var n=e.pointer.bind[i];n&&me.input.triggerKeyEvent(n,l.includes(t.type),i+1)}e.pointer=new me.Pointer(0,0,1,1),e.pointer.bind=[0,0,0],e.pointer.LEFT=0,e.pointer.MIDDLE=1,e.pointer.RIGHT=2,e.throttlingInterval=void 0,e.globalToLocal=function(e,t,i){i=i||new me.Vector2d;var n=me.device.getElementBounds(me.video.renderer.getScreenCanvas()),r=me.device.devicePixelRatio;e-=n.left+(window.pageXOffset||0),t-=n.top+(window.pageYOffset||0);var s=me.video.scaleRatio;return 1===s.x&&1===s.y||(e/=s.x,t/=s.y),i.set(e*r,t*r)},e.setTouchAction=function(e,t){e.style["touch-action"]=t||"none"},e.bindPointer=function(){var t=arguments.length<2?e.pointer.LEFT:arguments[0],i=arguments.length<2?arguments[0]:arguments[1];if(x(),!me.input.getBindingKey(i))throw new Error("no action defined for keycode "+i);e.pointer.bind[t]=i},e.unbindPointer=function(t){e.pointer.bind[void 0===t?e.pointer.LEFT:t]=null},e.registerPointerEvent=function(e,t,n){if(x(),-1===m.indexOf(e))throw new Error("invalid event type : "+e);if(void 0===t)throw new Error("registerPointerEvent: region for "+toString(t)+" event is undefined ");var r=b(o,y[e]);i.has(t)||i.set(t,{region:t,callbacks:{},pointerId:null});for(var s=i.get(t),a=0;a<r.length;a++)e=r[a],s.callbacks[e]?s.callbacks[e].push(n):s.callbacks[e]=[n]},e.releasePointerEvent=function(e,t,n){if(-1===m.indexOf(e))throw new Error("invalid event type : "+e);var r=b(o,y[e]),s=i.get(t);if(void 0!==s){for(var a=0;a<r.length;a++)if(e=r[a],s.callbacks[e]){if(void 0!==n)me.utils.array.remove(s.callbacks[e],n);else for(;s.callbacks[e].length>0;)s.callbacks[e].pop();0===s.callbacks[e].length&&delete s.callbacks[e]}0===Object.keys(s.callbacks).length&&i.delete(t)}},e.releaseAllPointerEvents=function(t){if(i.has(t))for(var n=0;n<m.length;n++)e.releasePointerEvent(m[n],t)}}(me.input),function(e){var t=.1;function i(e){return e}function n(t,i,n){return t=t>0?n===e.GAMEPAD.BUTTONS.L2?Math.max(0,t-2e4)/111070:(t-1)/131070:(65536+t)/131070+.5}var r=/^([0-9a-f]{1,4})-([0-9a-f]{1,4})-/i,s=/^0+/;function o(e,t){var n=e.replace(r,(function(e,t,i){return"000".substr(t.length-1)+t+"-"+"000".substr(i.length-1)+i+"-"})),o=e.replace(r,(function(e,t,i){return t.replace(s,"")+"-"+i.replace(s,"")+"-"}));t.analog=t.analog||t.buttons.map((function(){return-1})),t.normalize_fn=t.normalize_fn||i,l.set(n,t),l.set(o,t)}var a,h={},l=new Map;[["45e-28e-Xbox 360 Wired Controller",{axes:[0,1,3,4],buttons:[11,12,13,14,8,9,-1,-1,5,4,6,7,0,1,2,3,10],analog:[-1,-1,-1,-1,-1,-1,2,5,-1,-1,-1,-1,-1,-1,-1,-1,-1],normalize_fn:function(t,i,n){return n===e.GAMEPAD.BUTTONS.L2||n===e.GAMEPAD.BUTTONS.R2?(t+1)/2:t}}],["54c-268-PLAYSTATION(R)3 Controller",{axes:[0,1,2,3],buttons:[14,13,15,12,10,11,8,9,0,3,1,2,4,6,7,5,16]}],["54c-5c4-Wireless Controller",{axes:[0,1,2,3],buttons:[1,0,2,3,4,5,6,7,8,9,10,11,14,15,16,17,12,13]}],["2836-1-OUYA Game Controller",{axes:[0,3,7,9],buttons:[3,6,4,5,7,8,15,16,-1,-1,9,10,11,12,13,14,-1],analog:[-1,-1,-1,-1,-1,-1,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1],normalize_fn:n}],["OUYA Game Controller (Vendor: 2836 Product: 0001)",{axes:[0,1,3,4],buttons:[0,3,1,2,4,5,12,13,-1,-1,6,7,8,9,10,11,-1],analog:[-1,-1,-1,-1,-1,-1,2,5,-1,-1,-1,-1,-1,-1,-1,-1,-1],normalize_fn:n}]].forEach((function(e){o(e[0],e[1])}));var u=function(){var i=navigator.getGamepads();Object.keys(h).forEach((function(n){var r=i[n];if(r){var s=null;"standard"!==r.mapping&&(s=l.get(r.id));var o=h[n];Object.keys(o.buttons).forEach((function(i){var a=o.buttons[i],h=i,l=-1;if(!(s&&(h=s.buttons[i],l=s.analog[i],h<0&&l<0))){var u=r.buttons[h]||{};if(s&&l>=0){var c=s.normalize_fn(r.axes[l],-1,+i);u={value:c,pressed:u.pressed||Math.abs(c)>=t}}me.event.publish(me.event.GAMEPAD_UPDATE,[n,"buttons",+i,u]),!a.pressed&&u.pressed?e.triggerKeyEvent(a.keyCode,!0,h+256):a.pressed&&!u.pressed&&e.triggerKeyEvent(a.keyCode,!1,h+256),a.value=u.value,a.pressed=u.pressed}})),Object.keys(o.axes).forEach((function(i){var a=o.axes[i],h=i;if(!(s&&(h=s.axes[i])<0)){var l=r.axes[h];if(void 0!==l){s&&(l=s.normalize_fn(l,+i,-1));var u=Math.sign(l)||1;if(0!==a[u].keyCode){var c=Math.abs(l)>=t+Math.abs(a[u].threshold);me.event.publish(me.event.GAMEPAD_UPDATE,[n,"axes",+i,l]),!a[u].pressed&&c?(a[-u].pressed&&(e.triggerKeyEvent(a[-u].keyCode,!1,h+256),a[-u].value=0,a[-u].pressed=!1),e.triggerKeyEvent(a[u].keyCode,!0,h+256)):!a[u].pressed&&!a[-u].pressed||c||(u=a[u].pressed?u:-u,e.triggerKeyEvent(a[u].keyCode,!1,h+256)),a[u].value=l,a[u].pressed=c}}}}))}}))};window.addEventListener("gamepadconnected",(function(e){me.event.publish(me.event.GAMEPAD_CONNECTED,[e.gamepad])}),!1),window.addEventListener("gamepaddisconnected",(function(e){me.event.publish(me.event.GAMEPAD_DISCONNECTED,[e.gamepad])}),!1),e.GAMEPAD={AXES:{LX:0,LY:1,RX:2,RY:3,EXTRA_1:4,EXTRA_2:5,EXTRA_3:6,EXTRA_4:7},BUTTONS:{FACE_1:0,FACE_2:1,FACE_3:2,FACE_4:3,L1:4,R1:5,L2:6,R2:7,SELECT:8,BACK:8,START:9,FORWARD:9,L3:10,R3:11,UP:12,DOWN:13,LEFT:14,RIGHT:15,HOME:16,EXTRA_1:17,EXTRA_2:18,EXTRA_3:19,EXTRA_4:20}},e.bindGamepad=function(e,t,i){if(!me.input.getBindingKey(i))throw new Error("no action defined for keycode "+i);void 0===a&&"function"==typeof navigator.getGamepads&&(a=me.event.subscribe(me.event.GAME_UPDATE,u)),h[e]||(h[e]={axes:{},buttons:{}});var n={keyCode:i,value:0,pressed:!1,threshold:t.threshold},r=h[e][t.type];if("buttons"===t.type)r[t.code]=n;else if("axes"===t.type){var s=Math.sign(t.threshold)||1;r[t.code]||(r[t.code]={});var o=r[t.code];o[s]=n,o[-s]||(o[-s]={keyCode:0,value:0,pressed:!1,threshold:-s})}},e.unbindGamepad=function(e,t){if(!h[e])throw new Error("no bindings for gamepad "+e);h[e].buttons[t]={}},e.setGamepadDeadzone=function(e){t=e},e.setGamepadMapping=o}(me.input),me.utils=function(){var e,t,i={},n="",r=0;return i.deprecated=function(e,t,i){console.warn("melonJS: %s is deprecated since version %s, please use %s",e,i,t)},i.getPixels=function(e){if(e instanceof HTMLImageElement){var t=me.CanvasRenderer.getContext2d(me.video.createCanvas(e.width,e.height));return t.drawImage(e,0,0),t.getImageData(0,0,e.width,e.height)}return e.getContext("2d").getImageData(0,0,e.width,e.height)},i.checkVersion=function(e,t){t=t||me.version;for(var i=e.split("."),n=t.split("."),r=Math.min(i.length,n.length),s=0,o=0;o<r&&!(s=+i[o]-+n[o]);o++);return s||i.length-n.length},i.getUriFragment=(e={},t=!1,function(i){var n;if(void 0===i){if(n=e,!0===t)return n;i=document.location,t=!0}else n={};return i&&i.hash&&i.hash.substr(1).split("&").filter((function(e){return""!==e})).forEach((function(e){var t=e.split("="),i=t.shift(),r=t.join("=");n[i]=r||!0})),n}),i.resetGUID=function(e,t){n=me.utils.string.toHex(e.toString().toUpperCase()),r=t||0},i.createGUID=function(e){return r+=e||1,n+"-"+(e||r)},i}(),function(e){var t=function(){var e={},t=/^.*(\\|\/|\:)/,i=/\.[^\.]*$/;return e.getBasename=function(e){return e.replace(t,"").replace(i,"")},e.getExtension=function(e){return e.substring(e.lastIndexOf(".")+1,e.length)},e}();e.file=t}(me.utils),function(e){var t=function(){var e={defer:function(e,t){var i=Array.prototype.slice.call(arguments,1);return setTimeout(e.bind.apply(e,i),.01)},throttle:function(e,t,i){var n,r=window.performance.now();return"boolean"!=typeof i&&(i=!1),function(){var s=window.performance.now(),o=s-r,a=arguments;if(!(o<t))return r=s,e.apply(null,a);!1===i&&(clearTimeout(n),n=setTimeout((function(){return r=s,e.apply(null,a)}),o))}}};return e}();e.function=t}(me.utils),function(e){var t=function(){var e={remove:function(e,t){var i=Array.prototype.indexOf.call(e,t);return-1!==i&&Array.prototype.splice.call(e,i,1),e},random:function(e){return e[me.Math.random(0,e.length)]},weightedRandom:function(e){return e[me.Math.weightedRandom(0,e.length)]}};return e}();e.array=t}(me.utils),function(e){var t=function(){var e={capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},trimLeft:function(e){return e.replace(/^\s+/,"")},trimRight:function(e){return e.replace(/\s+$/,"")},isNumeric:function(e){return!isNaN(e)&&""!==e.trim()},isBoolean:function(e){var t=e.trim();return"true"===t||"false"===t},toHex:function(e){for(var t="",i=0;i<e.length;)t+=e.charCodeAt(i++).toString(16);return t}};return e}();e.string=t}(me.utils),_toHex=function(e){return"0123456789ABCDEF".charAt(e-e%16>>4)+"0123456789ABCDEF".charAt(e%16)},rgbaRx=/^rgba?\((\d+), ?(\d+), ?(\d+)(, ?([\d\.]+))?\)$/,hex3Rx=/^#([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,hex4Rx=/^#([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,hex6Rx=/^#([\da-fA-F]{2})([\da-fA-F]{2})([\da-fA-F]{2})$/,hex8Rx=/^#([\da-fA-F]{2})([\da-fA-F]{2})([\da-fA-F]{2})([\da-fA-F]{2})$/,cssToRGB=new Map,[["black",[0,0,0]],["silver",[192,192,129]],["gray",[128,128,128]],["white",[255,255,255]],["maroon",[128,0,0]],["red",[255,0,0]],["purple",[128,0,128]],["fuchsia",[255,0,255]],["green",[0,128,0]],["lime",[0,255,0]],["olive",[128,128,0]],["yellow",[255,255,0]],["navy",[0,0,128]],["blue",[0,0,255]],["teal",[0,128,128]],["aqua",[0,255,255]],["orange",[255,165,0]],["aliceblue",[240,248,245]],["antiquewhite",[250,235,215]],["aquamarine",[127,255,212]],["azure",[240,255,255]],["beige",[245,245,220]],["bisque",[255,228,196]],["blanchedalmond",[255,235,205]],["blueviolet",[138,43,226]],["brown",[165,42,42]],["burlywood",[222,184,35]],["cadetblue",[95,158,160]],["chartreuse",[127,255,0]],["chocolate",[210,105,30]],["coral",[255,127,80]],["cornflowerblue",[100,149,237]],["cornsilk",[255,248,220]],["crimson",[220,20,60]],["darkblue",[0,0,139]],["darkcyan",[0,139,139]],["darkgoldenrod",[184,134,11]],["darkgray[*]",[169,169,169]],["darkgreen",[0,100,0]],["darkgrey[*]",[169,169,169]],["darkkhaki",[189,183,107]],["darkmagenta",[139,0,139]],["darkolivegreen",[85,107,47]],["darkorange",[255,140,0]],["darkorchid",[153,50,204]],["darkred",[139,0,0]],["darksalmon",[233,150,122]],["darkseagreen",[143,188,143]],["darkslateblue",[72,61,139]],["darkslategray",[47,79,79]],["darkslategrey",[47,79,79]],["darkturquoise",[0,206,209]],["darkviolet",[148,0,211]],["deeppink",[255,20,147]],["deepskyblue",[0,191,255]],["dimgray",[105,105,105]],["dimgrey",[105,105,105]],["dodgerblue",[30,144,255]],["firebrick",[178,34,34]],["floralwhite",[255,250,240]],["forestgreen",[34,139,34]],["gainsboro",[220,220,220]],["ghostwhite",[248,248,255]],["gold",[255,215,0]],["goldenrod",[218,165,32]],["greenyellow",[173,255,47]],["grey",[128,128,128]],["honeydew",[240,255,240]],["hotpink",[255,105,180]],["indianred",[205,92,92]],["indigo",[75,0,130]],["ivory",[255,255,240]],["khaki",[240,230,140]],["lavender",[230,230,250]],["lavenderblush",[255,240,245]],["lawngreen",[124,252,0]],["lemonchiffon",[255,250,205]],["lightblue",[173,216,230]],["lightcoral",[240,128,128]],["lightcyan",[224,255,255]],["lightgoldenrodyellow",[250,250,210]],["lightgray",[211,211,211]],["lightgreen",[144,238,144]],["lightgrey",[211,211,211]],["lightpink",[255,182,193]],["lightsalmon",[255,160,122]],["lightseagreen",[32,178,170]],["lightskyblue",[135,206,250]],["lightslategray",[119,136,153]],["lightslategrey",[119,136,153]],["lightsteelblue",[176,196,222]],["lightyellow",[255,255,224]],["limegreen",[50,205,50]],["linen",[250,240,230]],["mediumaquamarine",[102,205,170]],["mediumblue",[0,0,205]],["mediumorchid",[186,85,211]],["mediumpurple",[147,112,219]],["mediumseagreen",[60,179,113]],["mediumslateblue",[123,104,238]],["mediumspringgreen",[0,250,154]],["mediumturquoise",[72,209,204]],["mediumvioletred",[199,21,133]],["midnightblue",[25,25,112]],["mintcream",[245,255,250]],["mistyrose",[255,228,225]],["moccasin",[255,228,181]],["navajowhite",[255,222,173]],["oldlace",[253,245,230]],["olivedrab",[107,142,35]],["orangered",[255,69,0]],["orchid",[218,112,214]],["palegoldenrod",[238,232,170]],["palegreen",[152,251,152]],["paleturquoise",[175,238,238]],["palevioletred",[219,112,147]],["papayawhip",[255,239,213]],["peachpuff",[255,218,185]],["peru",[205,133,63]],["pink",[255,192,203]],["plum",[221,160,221]],["powderblue",[176,224,230]],["rosybrown",[188,143,143]],["royalblue",[65,105,225]],["saddlebrown",[139,69,19]],["salmon",[250,128,114]],["sandybrown",[244,164,96]],["seagreen",[46,139,87]],["seashell",[255,245,238]],["sienna",[160,82,45]],["skyblue",[135,206,235]],["slateblue",[106,90,205]],["slategray",[112,128,144]],["slategrey",[112,128,144]],["snow",[255,250,250]],["springgreen",[0,255,127]],["steelblue",[70,130,180]],["tan",[210,180,140]],["thistle",[216,191,216]],["tomato",[255,99,71]],["turquoise",[64,224,208]],["violet",[238,130,238]],["wheat",[245,222,179]],["whitesmoke",[245,245,245]],["yellowgreen",[154,205,50]]].forEach((function(e){cssToRGB.set(e[0],e[1])})),me.Color=me.Object.extend({init:function(e,t,i,n){return void 0===this.glArray&&(this.glArray=new Float32Array([0,0,0,1])),this.setColor(e,t,i,n)},setColor:function(e,t,i,n){return e instanceof me.Color?(this.glArray.set(e.glArray),e):(this.r=e,this.g=t,this.b=i,this.alpha=n,this)},clone:function(){return me.pool.pull("me.Color",this)},copy:function(e){return e instanceof me.Color?(this.glArray.set(e.glArray),this):this.parseCSS(e)},add:function(e){return this.glArray[0]=me.Math.clamp(this.glArray[0]+e.glArray[0],0,1),this.glArray[1]=me.Math.clamp(this.glArray[1]+e.glArray[1],0,1),this.glArray[2]=me.Math.clamp(this.glArray[2]+e.glArray[2],0,1),this.glArray[3]=(this.glArray[3]+e.glArray[3])/2,this},darken:function(e){return e=me.Math.clamp(e,0,1),this.glArray[0]*=e,this.glArray[1]*=e,this.glArray[2]*=e,this},lerp:function(e,t){return t=me.Math.clamp(t,0,1),this.glArray[0]+=(e.glArray[0]-this.glArray[0])*t,this.glArray[1]+=(e.glArray[1]-this.glArray[1])*t,this.glArray[2]+=(e.glArray[2]-this.glArray[2])*t,this},lighten:function(e){return e=me.Math.clamp(e,0,1),this.glArray[0]=me.Math.clamp(this.glArray[0]+(1-this.glArray[0])*e,0,1),this.glArray[1]=me.Math.clamp(this.glArray[1]+(1-this.glArray[1])*e,0,1),this.glArray[2]=me.Math.clamp(this.glArray[2]+(1-this.glArray[2])*e,0,1),this},random:function(e,t){return(void 0===e||e<0)&&(e=0),(void 0===t||e>255)&&(t=255),this.setColor(me.Math.random(e,t),me.Math.random(e,t),me.Math.random(e,t),this.alpha)},equals:function(e){return this.glArray[0]===e.glArray[0]&&this.glArray[1]===e.glArray[1]&&this.glArray[2]===e.glArray[2]&&this.glArray[3]===e.glArray[3]},parseCSS:function(e){return cssToRGB.has(e)?this.setColor.apply(this,cssToRGB.get(e)):this.parseRGB(e)},parseRGB:function(e){var t=rgbaRx.exec(e);return t?this.setColor(+t[1],+t[2],+t[3],+t[5]):this.parseHex(e)},parseHex:function(e){var t;if(t=hex8Rx.exec(e))return this.setColor(parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16),(me.Math.clamp(parseInt(t[4],16),0,255)/255).toFixed(1));if(t=hex6Rx.exec(e))return this.setColor(parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16));if(t=hex4Rx.exec(e))return this.setColor(parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16),parseInt(t[3]+t[3],16),(me.Math.clamp(parseInt(t[4]+t[4],16),0,255)/255).toFixed(1));if(t=hex3Rx.exec(e))return this.setColor(parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16),parseInt(t[3]+t[3],16));throw new Error("invalid parameter: "+e)},toArray:function(){return this.glArray},toHex:function(){return"#"+_toHex(this.r)+_toHex(this.g)+_toHex(this.b)},toHex8:function(){return"#"+_toHex(this.r)+_toHex(this.g)+_toHex(this.b)+_toHex(255*this.alpha)},toRGB:function(){return"rgb("+this.r+","+this.g+","+this.b+")"},toRGBA:function(){return"rgba("+this.r+","+this.g+","+this.b+","+this.alpha+")"}}),Object.defineProperty(me.Color.prototype,"r",{get:function(){return~~(255*this.glArray[0])},set:function(e){this.glArray[0]=me.Math.clamp(~~e||0,0,255)/255},enumerable:!0,configurable:!0}),Object.defineProperty(me.Color.prototype,"g",{get:function(){return~~(255*this.glArray[1])},set:function(e){this.glArray[1]=me.Math.clamp(~~e||0,0,255)/255},enumerable:!0,configurable:!0}),Object.defineProperty(me.Color.prototype,"b",{get:function(){return~~(255*this.glArray[2])},set:function(e){this.glArray[2]=me.Math.clamp(~~e||0,0,255)/255},enumerable:!0,configurable:!0}),Object.defineProperty(me.Color.prototype,"alpha",{get:function(){return this.glArray[3]},set:function(e){this.glArray[3]=void 0===e?1:me.Math.clamp(+e,0,1)},enumerable:!0,configurable:!0}),me.save=function(){var e={};function t(e){return"add"===e||"remove"===e}var i={init:function(){if(!0===me.device.localStorage){var t=localStorage.getItem("me.save");"string"==typeof t&&t.length>0&&(JSON.parse(t)||[]).forEach((function(t){e[t]=JSON.parse(localStorage.getItem("me.save."+t))}))}},add:function(n){Object.keys(n).forEach((function(r){var s;t(r)||(s=r,Object.defineProperty(i,s,{configurable:!0,enumerable:!0,get:function(){return e[s]},set:function(t){e[s]=t,!0===me.device.localStorage&&localStorage.setItem("me.save."+s,JSON.stringify(t))}}),r in e||(i[r]=n[r]))})),!0===me.device.localStorage&&localStorage.setItem("me.save",JSON.stringify(Object.keys(e)))},remove:function(i){t(i)||void 0!==e[i]&&(delete e[i],!0===me.device.localStorage&&(localStorage.removeItem("me.save."+i),localStorage.setItem("me.save",JSON.stringify(Object.keys(e)))))}};return i}(),me.levelDirector=function(){var e={},t={},i=[],n=0;function r(r,s,o){s.container.reset(),me.game.reset(),t[e.getCurrentLevelId()]&&t[e.getCurrentLevelId()].destroy(),n=i.indexOf(r),function(e,i,n,r){var s=t[e];me.utils.resetGUID(e,s.nextobjectid),i.anchorPoint.set(0,0),s.addTo(i,n,r)}(r,s.container,s.flatten,s.setViewportBounds),me.event.publish(me.event.LEVEL_LOADED,[r]),s.onLoaded(r),o&&me.state.restart()}return e.init=function(){},e.reset=function(){},e.addLevel=function(){throw new Error("no level loader defined")},e.addTMXLevel=function(e,n){return null==t[e]&&(t[e]=new me.TMXTileMap(e,me.loader.getTMX(e)),i.push(e),n&&n(),!0)},e.loadLevel=function(e,i){if(i=Object.assign({container:me.game.world,onLoaded:me.game.onLevelLoaded,flatten:me.game.mergeGroup,setViewportBounds:!0},i||{}),void 0===t[e])throw new Error("level "+e+" not found");if(!(t[e]instanceof me.TMXTileMap))throw new Error("no level loader defined");return me.state.isRunning()?(me.state.stop(),me.utils.function.defer(r,this,e,i,!0)):r(e,i),!0},e.getCurrentLevelId=function(){return i[n]},e.getCurrentLevel=function(){return t[e.getCurrentLevelId()]},e.reloadLevel=function(t){return e.loadLevel(e.getCurrentLevelId(),t)},e.nextLevel=function(t){return n+1<i.length&&e.loadLevel(i[n+1],t)},e.previousLevel=function(t){return n-1>=0&&e.loadLevel(i[n-1],t)},e.levelCount=function(){return i.length},e}(),function(){me.TMXUtils=function(){var api={};function setTMXValue(name,type,value){var match;if("string"!=typeof value)return value;switch(type){case"int":case"float":value=Number(value);break;case"bool":value="true"===value;break;default:if(!value||me.utils.string.isBoolean(value))value=!value||"true"===value;else if(me.utils.string.isNumeric(value))value=Number(value);else if(0===value.search(/^json:/i)){match=value.split(/^json:/i)[1];try{value=JSON.parse(match)}catch(e){throw new Error("Unable to parse JSON: "+match)}}else if(0===value.search(/^eval:/i)){match=value.split(/^eval:/i)[1];try{value=eval(match)}catch(e){throw new Error("Unable to evaluate: "+match)}}else((match=value.match(/^#([\da-fA-F])([\da-fA-F]{3})$/))||(match=value.match(/^#([\da-fA-F]{2})([\da-fA-F]{6})$/)))&&(value="#"+match[2]+match[1]);0===name.search(/^(ratio|anchorPoint)$/)&&"number"==typeof value&&(value={x:value,y:value})}return value}function parseAttributes(e,t){if(t.attributes&&t.attributes.length>0)for(var i=0;i<t.attributes.length;i++){var n=t.attributes.item(i);void 0!==n.name?e[n.name]=n.value:e[n.nodeName]=n.nodeValue}}return api.decompress=function(){throw new Error("GZIP/ZLIB compressed TMX Tile Map not supported!")},api.decodeCSV=function(e){for(var t=e.replace("\n","").trim().split(","),i=[],n=0;n<t.length;n++)i.push(+t[n]);return i},api.decodeBase64AsArray=function(e,t){var i,n,r;t=t||1;var s=window.atob(e.replace(/[^A-Za-z0-9\+\/\=]/g,"")),o=new Uint32Array(s.length/t);for(i=0,r=s.length/t;i<r;i++)for(o[i]=0,n=t-1;n>=0;--n)o[i]+=s.charCodeAt(i*t+n)<<(n<<3);return o},api.decode=function(e,t,i){switch(i=i||"none",t=t||"none"){case"csv":return api.decodeCSV(e);case"base64":var n=api.decodeBase64AsArray(e,4);return"none"===i?n:api.decompress(n,i);case"none":return e;case"xml":throw new Error("XML encoding is deprecated, use base64 instead");default:throw new Error("Unknown layer encoding: "+t)}},api.normalize=function(e,t){var i=t.nodeName;switch(i){case"data":var n=api.parse(t);n.text=n.text||n.chunk.text,n.encoding=n.encoding||"xml",e.data=api.decode(n.text,n.encoding,n.compression),e.encoding="none";break;case"imagelayer":case"layer":case"objectgroup":case"group":var r=api.parse(t);r.type="layer"===i?"tilelayer":i,r.image&&(r.image=r.image.source),e.layers=e.layers||[],e.layers.push(r);break;case"animation":e.animation=api.parse(t).frames;break;case"frame":case"object":var s=i+"s";e[s]=e[s]||[],e[s].push(api.parse(t));break;case"tile":var o=api.parse(t);o.image&&(o.imagewidth=o.image.width,o.imageheight=o.image.height,o.image=o.image.source),e.tiles=e.tiles||{},e.tiles[o.id]=o;break;case"tileset":var a=api.parse(t);a.image&&(a.imagewidth=a.image.width,a.imageheight=a.image.height,a.image=a.image.source),e.tilesets=e.tilesets||[],e.tilesets.push(a);break;case"polygon":case"polyline":e[i]=[];for(var h,l=api.parse(t).points.split(" "),u=0;u<l.length;u++)h=l[u].split(","),e[i].push({x:+h[0],y:+h[1]});break;case"properties":e.properties=api.parse(t);break;case"property":var c=api.parse(t),d=void 0!==c.value?c.value:c.text;e[c.name]=setTMXValue(c.name,c.type||"string",d);break;default:e[i]=api.parse(t)}},api.parse=function(e){var t={},i="";if(1===e.nodeType&&parseAttributes(t,e),e.hasChildNodes())for(var n=0;n<e.childNodes.length;n++){var r=e.childNodes.item(n);switch(r.nodeType){case 1:api.normalize(t,r);break;case 3:i+=r.nodeValue.trim()}}return i&&(t.text=i),t},api.applyTMXProperties=function(e,t){var i=t.properties,n=t.propertytypes;if(void 0!==i)for(var r in i)if(i.hasOwnProperty(r)){var s="string",o=r,a=i[r];void 0!==i[r].name&&(o=i[r].name),void 0!==n?s=n[r]:void 0!==i[r].type&&(s=i[r].type),void 0!==i[r].value&&(a=i[r].value),e[o]=setTMXValue(o,s,a)}},api}()}(),me.TMXGroup=me.Object.extend({init:function(e,t,i){this.name=t.name,this.width=t.width||0,this.height=t.height||0,this.z=i,this.objects=[];var n=void 0===t.visible||t.visible;this.opacity=!0===n?me.Math.clamp(+t.opacity||1,0,1):0,me.TMXUtils.applyTMXProperties(this,t);var r=this;t.objects&&t.objects.forEach((function(t){r.objects.push(new me.TMXObject(e,t,i))})),t.layers&&t.layers.forEach((function(t){var n=new me.TMXLayer(t,e.tilewidth,e.tileheight,e.orientation,e.tilesets,i++);n.setRenderer(e.getRenderer()),r.width=Math.max(r.width,n.width),r.height=Math.max(r.height,n.height),r.objects.push(n)}))},destroy:function(){this.objects=null},getObjectCount:function(){return this.objects.length},getObjectByIndex:function(e){return this.objects[e]}}),me.TMXObject=me.Object.extend({init:function(e,t,i){this.points=void 0,this.name=t.name,this.x=+t.x,this.y=+t.y,this.z=+i,this.width=+t.width||0,this.height=+t.height||0,this.gid=+t.gid||null,this.type=t.type,this.type=t.type,this.rotation=me.Math.degToRad(+t.rotation||0),this.id=+t.id||void 0,this.orientation=e.orientation,this.shapes=void 0,this.isEllipse=!1,this.isPolygon=!1,this.isPolyLine=!1,"number"==typeof this.gid?this.setTile(e.tilesets):void 0!==t.ellipse?this.isEllipse=!0:void 0!==t.polygon?(this.points=t.polygon,this.isPolygon=!0):void 0!==t.polyline&&(this.points=t.polyline,this.isPolyLine=!0),void 0!==t.text?(this.text=t.text,this.text.font=t.text.fontfamily||"sans-serif",this.text.size=t.text.pixelsize||16,this.text.fillStyle=t.text.color||"#000000",this.text.textAlign=t.text.halign||"left",this.text.textBaseline=t.text.valign||"top",this.text.width=this.width,this.text.height=this.height,me.TMXUtils.applyTMXProperties(this.text,t)):(me.TMXUtils.applyTMXProperties(this,t),this.shapes||(this.shapes=this.parseTMXShapes())),e.isEditor||e.getRenderer().adjustPosition(this)},setTile:function(e){var t=e.getTilesetByGid(this.gid);!1===t.isCollection&&(this.width=this.framewidth=t.tilewidth,this.height=this.frameheight=t.tileheight),this.tile=new me.Tile(this.x,this.y,this.gid,t)},parseTMXShapes:function(){var e=0,t=[];if(!0===this.isEllipse)t.push(new me.Ellipse(this.width/2,this.height/2,this.width,this.height).rotate(this.rotation));else if(!0===this.isPolygon)t.push(new me.Polygon(0,0,this.points).rotate(this.rotation));else if(!0===this.isPolyLine){var i,n,r=this.points,s=r.length-1;for(e=0;e<s;e++)i=new me.Vector2d(r[e].x,r[e].y),n=new me.Vector2d(r[e+1].x,r[e+1].y),0!==this.rotation&&(i=i.rotate(this.rotation),n=n.rotate(this.rotation)),t.push(new me.Line(0,0,[i,n]))}else t.push(new me.Polygon(0,0,[new me.Vector2d,new me.Vector2d(this.width,0),new me.Vector2d(this.width,this.height),new me.Vector2d(0,this.height)]).rotate(this.rotation));if("isometric"===this.orientation)for(e=0;e<t.length;e++)t[e].toIso();return t},getObjectPropertyByName:function(e){return this[e]}}),me.Tile=me.Rect.extend({init:function(e,t,i,n){var r,s;if(n.isCollection){var o=n.getTileImage(536870911&i);r=o.width,s=o.height}else r=n.tilewidth,s=n.tileheight;this._super(me.Rect,"init",[e*r,t*s,r,s]),this.tileset=n,this.currentTransform=null,this.col=e,this.row=t,this.tileId=i,this.flippedX=0!=(2147483648&this.tileId),this.flippedY=0!=(1073741824&this.tileId),this.flippedAD=0!=(536870912&this.tileId),this.flipped=this.flippedX||this.flippedY||this.flippedAD,!0===this.flipped&&(null===this.currentTransform&&(this.currentTransform=new me.Matrix2d),this.setTileTransform(this.currentTransform.identity())),this.tileId&=536870911},setTileTransform:function(e){e.translate(this.width/2,this.height/2),this.flippedAD&&(e.rotate(-90*Math.PI/180),e.scale(-1,1)),this.flippedX&&e.scale(this.flippedAD?1:-1,this.flippedAD?-1:1),this.flippedY&&e.scale(this.flippedAD?-1:1,this.flippedAD?1:-1),e.translate(-this.width/2,-this.height/2)},getRenderable:function(e){var t,i=this.tileset;if(i.animations.has(this.tileId)){var n=[],r=[];i.animations.get(this.tileId).frames.forEach((function(e){r.push(e.tileid),n.push({name:""+e.tileid,delay:e.duration})})),(t=i.texture.createAnimationFromName(r,e)).addAnimation(this.tileId-i.firstgid,n),t.setCurrentAnimation(this.tileId-i.firstgid)}else if(!0===i.isCollection){var s=i.getTileImage(this.tileId);(t=new me.Sprite(0,0,Object.assign({image:s}))).anchorPoint.set(0,0),t.scale(e.width/this.width,e.height/this.height),void 0!==e.rotation&&(t.anchorPoint.set(.5,.5),t.currentTransform.rotate(e.rotation),t.currentTransform.translate(e.width/2,e.height/2),e.rotation=void 0)}else t=i.texture.createSpriteFromName(this.tileId-i.firstgid,e);return this.flippedX&&t.currentTransform.scaleX(-1),this.flippedY&&t.currentTransform.scaleY(-1),t}}),me.TMXTileset=me.Object.extend({init:function(e){var t=0;if(this.TileProperties=[],this.imageCollection=[],this.firstgid=this.lastgid=+e.firstgid,void 0!==e.source){var i=e.source,n=me.utils.file.getExtension(i);if(("tsx"===n||"json"===n)&&!(e=me.loader.getTMX(me.utils.file.getBasename(i))))throw new Error(i+" external TSX/JSON tileset not found")}this.name=e.name,this.tilewidth=+e.tilewidth,this.tileheight=+e.tileheight,this.spacing=+e.spacing||0,this.margin=+e.margin||0,this.tileoffset=new me.Vector2d,this.isAnimated=!1,this.isCollection=!1,this.animations=new Map,this._lastUpdate=0;var r=e.tiles;for(t in r)if(r.hasOwnProperty(t)&&("animation"in r[t]&&(this.isAnimated=!0,this.animations.set(r[+t].animation[0].tileid,{dt:0,idx:0,frames:r[+t].animation,cur:r[+t].animation[0]})),"properties"in r[t]&&this.setTileProperty(+t+this.firstgid,r[t].properties),"image"in r[t])){var s=me.loader.getImage(r[t].image);if(!s)throw new Error("melonJS: '"+r[t].image+"' file for tile '"+(+t+this.firstgid)+"' not found!");this.imageCollection[+t+this.firstgid]=s}this.isCollection=this.imageCollection.length>0;var o=e.tileoffset;o&&(this.tileoffset.x=+o.x,this.tileoffset.y=+o.y);var a=e.tileproperties;if(a)for(t in a)a.hasOwnProperty(t)&&this.setTileProperty(+t+this.firstgid,a[t]);if(!1===this.isCollection){if(this.image=me.loader.getImage(e.image),!this.image)throw new Error("melonJS: '"+e.image+"' file for tileset '"+this.name+"' not found!");this.texture=me.video.renderer.cache.get(this.image,{framewidth:this.tilewidth,frameheight:this.tileheight,margin:this.margin,spacing:this.spacing}),this.atlas=this.texture.getAtlas();var h=+e.columns||Math.round(this.image.width/(this.tilewidth+this.spacing)),l=Math.round(this.image.height/(this.tileheight+this.spacing));e.tilecount%h>0&&++l,this.lastgid=this.firstgid+(h*l-1||0),e.tilecount&&this.lastgid-this.firstgid+1!=+e.tilecount&&console.warn("Computed tilecount ("+(this.lastgid-this.firstgid+1)+") does not match expected tilecount ("+e.tilecount+")")}},getTileImage:function(e){return this.imageCollection[e]},setTileProperty:function(e,t){this.TileProperties[e]=t},contains:function(e){return e>=this.firstgid&&e<=this.lastgid},getViewTileId:function(e){var t=e-this.firstgid;return this.animations.has(t)?this.animations.get(t).cur.tileid:t},getTileProperties:function(e){return this.TileProperties[e]},update:function(e){var t=0,i=me.timer.getTime(),n=!1;return this._lastUpdate!==i&&(this._lastUpdate=i,this.animations.forEach((function(i){for(i.dt+=e,t=i.cur.duration;i.dt>=t;)i.dt-=t,i.idx=(i.idx+1)%i.frames.length,i.cur=i.frames[i.idx],t=i.cur.duration,n=!0}))),n},drawTile:function(e,t,i,n){if(n.flipped&&(e.save(),e.translate(t,i),e.transform(n.currentTransform),t=i=0),!0===this.isCollection)e.drawImage(this.imageCollection[n.tileId],0,0,n.width,n.height,t,i,n.width,n.height);else{var r=this.atlas[this.getViewTileId(n.tileId)].offset;e.drawImage(this.image,r.x,r.y,this.tilewidth,this.tileheight,t,i,this.tilewidth+e.uvOffset,this.tileheight+e.uvOffset)}n.flipped&&e.restore()}}),me.TMXTilesetGroup=me.Object.extend({init:function(){this.tilesets=[],this.length=0},add:function(e){this.tilesets.push(e),this.length++},getTilesetByIndex:function(e){return this.tilesets[e]},getTilesetByGid:function(e){var t=-1;e&=536870911;for(var i=0,n=this.tilesets.length;i<n;i++){if(this.tilesets[i].contains(e))return this.tilesets[i];this.tilesets[i].firstgid===this.tilesets[i].lastgid&&e>=this.tilesets[i].firstgid&&(t=i)}if(-1!==t)return this.tilesets[t];throw new Error("no matching tileset found for gid "+e)}}),function(){function e(e,t){var i=0;!function(e){e.layerData=new Array(e.cols);for(var t=0;t<e.cols;t++){e.layerData[t]=new Array(e.rows);for(var i=0;i<e.rows;i++)e.layerData[t][i]=null}}(e);for(var n=0;n<e.rows;n++)for(var r=0;r<e.cols;r++){var s=t[i++];0!==s&&e.setTile(r,n,s)}}me.TMXLayer=me.Renderable.extend({init:function(t,i,n,r,s,o){this._super(me.Renderable,"init",[0,0,0,0]),this.tilewidth=t.tilewidth||i,this.tileheight=t.tileheight||n,this.orientation=r,this.tilesets=s,this.tileset=this.tilesets?this.tilesets.getTilesetByIndex(0):null,this.maxTileSize={width:0,height:0};for(var a=0;a<this.tilesets.length;a++){var h=this.tilesets.getTilesetByIndex(a);this.maxTileSize.width=Math.max(this.maxTileSize.width,h.tilewidth),this.maxTileSize.height=Math.max(this.maxTileSize.height,h.tileheight)}this.animatedTilesets=[],this.isAnimated=!1,this.renderorder=t.renderorder||"right-down",this.pos.z=o,this.anchorPoint.set(0,0),this.name=t.name,this.cols=+t.width,this.rows=+t.height;var l=void 0!==t.visible?+t.visible:1;this.setOpacity(l?+t.opacity:0),"isometric"===this.orientation?(this.width=(this.cols+this.rows)*(this.tilewidth/2),this.height=(this.cols+this.rows)*(this.tileheight/2)):(this.width=this.cols*this.tilewidth,this.height=this.rows*this.tileheight),me.TMXUtils.applyTMXProperties(this,t),void 0===this.preRender&&(this.preRender=me.sys.preRender),e(this,me.TMXUtils.decode(t.data,t.encoding,t.compression))},onActivateEvent:function(){if(void 0===this.animatedTilesets&&(this.animatedTilesets=[]),this.tilesets)for(var e=this.tilesets.tilesets,t=0;t<e.length;t++)e[t].isAnimated&&this.animatedTilesets.push(e[t]);this.isAnimated=this.animatedTilesets.length>0,this.isAnimated&&(this.preRender=!1);var i=this.getRenderer().getBounds(this);this.getBounds().resize(i.width,i.height),!0!==this.preRender||this.canvasRenderer||(this.canvasRenderer=new me.CanvasRenderer(me.video.createCanvas(this.width,this.height),this.width,this.height,{transparent:!0}))},onDeactivateEvent:function(){this.animatedTilesets=void 0},setRenderer:function(e){this.renderer=e},getRenderer:function(e){return this.renderer},getTileId:function(e,t){var i=this.getTile(e,t);return i?i.tileId:null},getTile:function(e,t){var i=null;if(this.containsPoint(e,t)){var n=this.renderer.pixelToTileCoords(e,t,me.pool.pull("me.Vector2d"));i=this.cellAt(n.x,n.y),me.pool.push(n)}return i},cellAt:function(e,t,i){var n=~~e,r=~~t;return!1===i||n>=0&&n<this.renderer.cols&&r>=0&&r<this.renderer.rows?this.layerData[n][r]:null},setTile:function(e,t,i){this.tileset.contains(i)||(this.tileset=this.tilesets.getTilesetByGid(i));var n=this.layerData[e][t]=new me.Tile(e,t,i,this.tileset);return this.preRender&&this.renderer.drawTile(this.canvasRenderer,e,t,n),n},clearTile:function(e,t){this.layerData[e][t]=null,this.preRender&&this.canvasRenderer.clearRect(e*this.tilewidth,t*this.tileheight,this.tilewidth,this.tileheight)},update:function(e){if(this.isAnimated){for(var t=!1,i=0;i<this.animatedTilesets.length;i++)t=this.animatedTilesets[i].update(e)||t;return t}return!1},draw:function(e,t){if(this.preRender){var i=Math.min(t.width,this.width),n=Math.min(t.height,this.height);e.drawImage(this.canvasRenderer.getCanvas(),t.pos.x,t.pos.y,i,n,t.pos.x,t.pos.y,i,n)}else this.renderer.drawTileLayer(e,this,t)}})}(),function(){var e=null;function t(e,t,i){return new me.TMXGroup(e,t,i)}me.TMXTileMap=me.Object.extend({init:function(e,t){if(this.data=t,this.name=e,this.cols=+t.width,this.rows=+t.height,this.tilewidth=+t.tilewidth,this.tileheight=+t.tileheight,this.infinite=+t.infinite,this.orientation=t.orientation,this.renderorder=t.renderorder||"right-down",this.version=t.version,this.tiledversion=t.tiledversion,this.tilesets=null,void 0===this.layers&&(this.layers=[]),void 0===this.objectGroups&&(this.objectGroups=[]),this.isEditor="melon-editor"===t.editor,this.nextobjectid=+t.nextobjectid||void 0,this.hexsidelength=+t.hexsidelength,this.staggeraxis=t.staggeraxis,this.staggerindex=t.staggerindex,this.bounds=this.getRenderer().getBounds(),this.width=this.bounds.width,this.height=this.bounds.height,this.backgroundcolor=t.backgroundcolor,me.TMXUtils.applyTMXProperties(this,t),this.initialized=!1,1===this.infinite)throw new Error("Tiled Infinite Map not supported!")},getRenderer:function(){return void 0!==this.renderer&&this.renderer.canRender(this)||(this.renderer=function(e){switch(e.orientation){case"orthogonal":return new me.TMXOrthogonalRenderer(e);case"isometric":return new me.TMXIsometricRenderer(e);case"hexagonal":return new me.TMXHexagonalRenderer(e);case"staggered":return new me.TMXStaggeredRenderer(e);default:throw new Error(e.orientation+" type TMX Tile Map not supported!")}}(this)),this.renderer},getBounds:function(){return this.bounds},readMapObjects:function(e){if(!0!==this.initialized){var i=0,n=this;if(this.tilesets||(this.tilesets=new me.TMXTilesetGroup),void 0!==e.tilesets)e.tilesets.forEach((function(e){n.tilesets.add(function(e){return new me.TMXTileset(e)}(e))}));this.backgroundcolor&&this.layers.push(me.pool.pull("me.ColorLayer","background_color",this.backgroundcolor,i++)),this.background_image&&this.layers.push(me.pool.pull("me.ImageLayer",0,0,{name:"background_image",image:this.background_image,z:i++})),e.layers.forEach((function(e){switch(e.type){case"imagelayer":n.layers.push(function(e,t,i){me.TMXUtils.applyTMXProperties(t.properties,t);var n=me.pool.pull("me.ImageLayer",+t.offsetx||+t.x||0,+t.offsety||+t.y||0,Object.assign({name:t.name,image:t.image,z:i},t.properties)),r=void 0===t.visible||t.visible;return n.setOpacity(r?+t.opacity:0),n}(0,e,i++));break;case"tilelayer":n.layers.push(function(e,t,i){var n=new me.TMXLayer(t,e.tilewidth,e.tileheight,e.orientation,e.tilesets,i);return n.setRenderer(e.getRenderer()),n}(n,e,i++));break;case"objectgroup":case"group":n.objectGroups.push(t(n,e,i++))}})),this.initialized=!0}},addTo:function(t,i,n){var r=t.autoSort,s=t.autoDepth,o=this.getBounds();function a(e,i){me.game.viewport.setBounds(0,0,Math.max(o.width,e),Math.max(o.height,i)),t.pos.set(Math.max(0,~~((e-o.width)/2)),Math.max(0,~~((i-o.height)/2)),t.pos.z)}t.autoSort=!1,t.autoDepth=!1,this.getLayers().forEach((function(e){t.addChild(e)})),this.getObjects(i).forEach((function(e){t.addChild(e)})),t.resize(this.bounds.width,this.bounds.height),t.sort(!0),!0===n&&(a(me.game.viewport.width,me.game.viewport.height),e&&me.event.unsubscribe(e),e=me.event.subscribe(me.event.VIEWPORT_ONRESIZE,a)),t.autoSort=r,t.autoDepth=s},getObjects:function(e){var t,i=[],n=!1;this.readMapObjects(this.data);for(var r=0;r<this.objectGroups.length;r++){var s=this.objectGroups[r];n=s.name.toLowerCase().includes("collision"),!1===e&&((t=new me.Container(0,0,this.width,this.height)).anchorPoint.set(0,0),t.name=s.name,t.pos.z=s.z,t.setOpacity(s.opacity),t.autoSort=!1,t.autoDepth=!1);for(var o=0;o<s.objects.length;o++){var a,h=s.objects[o];if(void 0===h.anchorPoint&&(h.anchorPoint={x:0,y:0}),h instanceof me.TMXLayer?a=h:"object"===_typeof(h.text)?(void 0===h.text.anchorPoint&&(h.text.anchorPoint=h.anchorPoint),(a=!0===h.text.bitmap?me.pool.pull("me.BitmapText",h.x,h.y,h.text):me.pool.pull("me.Text",h.x,h.y,h.text)).pos.z=h.z):(a=me.pool.pull(h.name||"me.Entity",h.x,h.y,h)).pos.z=h.z,"object"===_typeof(h.tile)&&!a.renderable)switch(a.renderable=h.tile.getRenderable(h),h.rotation){case Math.PI:a.translate(-a.renderable.width,a.renderable.height);break;case Math.PI/2:a.translate(0,a.renderable.height);break;case-Math.PI/2:a.translate(-a.renderable.width,0)}n&&!h.name&&(a.body.collisionType=me.collision.types.WORLD_SHAPE),!1!==e?(!0===a.isRenderable&&(a.setOpacity(a.getOpacity()*s.opacity),a.renderable instanceof me.Renderable&&a.renderable.setOpacity(a.renderable.getOpacity()*s.opacity)),i.push(a)):t.addChild(a)}!1===e&&t.children.length>0&&(t.autoSort=!0,t.autoDepth=!0,i.push(t))}return i},getLayers:function(){return this.readMapObjects(this.data),this.layers},destroy:function(){this.tilesets=void 0,this.layers.length=0,this.objectGroups.length=0,this.initialized=!1}})}(),me.TMXRenderer=me.Object.extend({init:function(e,t,i,n){this.cols=e,this.rows=t,this.tilewidth=i,this.tileheight=n,this.bounds=new me.Rect(0,0,0,0)},canRender:function(e){return this.tilewidth===e.tilewidth&&this.tileheight===e.tileheight},getBounds:function(e){var t=e instanceof me.TMXLayer?me.pool.pull("me.Rect",0,0,0,0):this.bounds;return t.setShape(0,0,this.cols*this.tilewidth,this.rows*this.tileheight),t},pixelToTileCoords:function(e,t,i){return i},tileToPixelCoords:function(e,t,i){return i},drawTile:function(e,t,i,n){},drawTileLayer:function(e,t,i){}}),me.TMXOrthogonalRenderer=me.TMXRenderer.extend({init:function(e){this._super(me.TMXRenderer,"init",[e.cols,e.rows,e.tilewidth,e.tileheight])},canRender:function(e){return"orthogonal"===e.orientation&&this._super(me.TMXRenderer,"canRender",[e])},pixelToTileCoords:function(e,t,i){return(i||new me.Vector2d).set(e/this.tilewidth,t/this.tileheight)},tileToPixelCoords:function(e,t,i){return(i||new me.Vector2d).set(e*this.tilewidth,t*this.tileheight)},adjustPosition:function(e){"number"==typeof e.gid&&(e.y-=e.height)},drawTile:function(e,t,i,n){var r=n.tileset;r.drawTile(e,r.tileoffset.x+t*this.tilewidth,r.tileoffset.y+(i+1)*this.tileheight-r.tileheight,n)},drawTileLayer:function(e,t,i){var n=1,r=1,s=this.pixelToTileCoords(Math.max(i.pos.x-(t.maxTileSize.width-t.tilewidth),0),Math.max(i.pos.y-(t.maxTileSize.height-t.tileheight),0),me.pool.pull("me.Vector2d")).floorSelf(),o=this.pixelToTileCoords(i.pos.x+i.width+this.tilewidth,i.pos.y+i.height+this.tileheight,me.pool.pull("me.Vector2d")).ceilSelf();switch(o.x=o.x>this.cols?this.cols:o.x,o.y=o.y>this.rows?this.rows:o.y,t.renderorder){case"right-up":o.y=s.y+(s.y=o.y)-o.y,r=-1;break;case"left-down":o.x=s.x+(s.x=o.x)-o.x,n=-1;break;case"left-up":o.x=s.x+(s.x=o.x)-o.x,o.y=s.y+(s.y=o.y)-o.y,n=-1,r=-1}for(var a=s.y;a!==o.y;a+=r)for(var h=s.x;h!==o.x;h+=n){var l=t.cellAt(h,a,!1);l&&this.drawTile(e,h,a,l)}me.pool.push(s),me.pool.push(o)}}),me.TMXIsometricRenderer=me.TMXRenderer.extend({init:function(e){this._super(me.TMXRenderer,"init",[e.cols,e.rows,e.tilewidth,e.tileheight]),this.hTilewidth=this.tilewidth/2,this.hTileheight=this.tileheight/2,this.originX=this.rows*this.hTilewidth},canRender:function(e){return"isometric"===e.orientation&&this._super(me.TMXRenderer,"canRender",[e])},getBounds:function(e){var t=e instanceof me.TMXLayer?me.pool.pull("me.Rect",0,0,0,0):this.bounds;return t.setShape(0,0,(this.cols+this.rows)*(this.tilewidth/2),(this.cols+this.rows)*(this.tileheight/2)),t},pixelToTileCoords:function(e,t,i){return(i||new me.Vector2d).set(t/this.tileheight+(e-this.originX)/this.tilewidth,t/this.tileheight-(e-this.originX)/this.tilewidth)},tileToPixelCoords:function(e,t,i){return(i||new me.Vector2d).set((e-t)*this.hTilewidth+this.originX,(e+t)*this.hTileheight)},adjustPosition:function(e){var t=e.x/this.hTilewidth,i=e.y/this.tileheight,n=me.pool.pull("me.Vector2d");this.tileToPixelCoords(t,i,n),e.x=n.x,e.y=n.y,me.pool.push(n)},drawTile:function(e,t,i,n){var r=n.tileset;r.drawTile(e,(this.cols-1)*r.tilewidth+(t-i)*r.tilewidth>>1,-r.tilewidth+(t+i)*r.tileheight>>2,n)},drawTileLayer:function(e,t,i){var n=t.tileset,r=this.pixelToTileCoords(i.pos.x-n.tilewidth,i.pos.y-n.tileheight,me.pool.pull("me.Vector2d")).floorSelf(),s=this.pixelToTileCoords(i.pos.x+i.width+n.tilewidth,i.pos.y+i.height+n.tileheight,me.pool.pull("me.Vector2d")).ceilSelf(),o=this.tileToPixelCoords(s.x,s.y,me.pool.pull("me.Vector2d")),a=this.tileToPixelCoords(r.x,r.y,me.pool.pull("me.Vector2d"));a.x-=this.hTilewidth,a.y+=this.tileheight;var h=a.y-i.pos.y>this.hTileheight,l=i.pos.x-a.x<this.hTilewidth;h&&(l?(r.x--,a.x-=this.hTilewidth):(r.y--,a.x+=this.hTilewidth),a.y-=this.hTileheight);for(var u=h^l,c=r.clone(),d=2*a.y;d-2*this.tileheight<2*o.y;d+=this.tileheight){c.setV(r);for(var f=a.x;f<o.x;f+=this.tilewidth){var p=t.cellAt(c.x,c.y);if(p){var m=(n=p.tileset).tileoffset;n.drawTile(e,m.x+f,m.y+d/2-n.tileheight,p)}c.x++,c.y--}u?(r.y++,a.x-=this.hTilewidth,u=!1):(r.x++,a.x+=this.hTilewidth,u=!0)}me.pool.push(c),me.pool.push(r),me.pool.push(s),me.pool.push(o),me.pool.push(a)}}),offsetsStaggerX=[{x:0,y:0},{x:1,y:-1},{x:1,y:0},{x:2,y:0}],offsetsStaggerY=[{x:0,y:0},{x:-1,y:1},{x:0,y:1},{x:0,y:2}],me.TMXHexagonalRenderer=me.TMXRenderer.extend({init:function(e){this._super(me.TMXRenderer,"init",[e.cols,e.rows,-2&e.tilewidth,-2&e.tileheight]),this.hexsidelength=e.hexsidelength||0,this.staggerX="x"===e.staggeraxis,this.staggerEven="even"===e.staggerindex,this.sidelengthx=0,this.sidelengthy=0,"hexagonal"===e.orientation&&(this.staggerX?this.sidelengthx=this.hexsidelength:this.sidelengthy=this.hexsidelength),this.sideoffsetx=(this.tilewidth-this.sidelengthx)/2,this.sideoffsety=(this.tileheight-this.sidelengthy)/2,this.columnwidth=this.sideoffsetx+this.sidelengthx,this.rowheight=this.sideoffsety+this.sidelengthy,this.centers=[new me.Vector2d,new me.Vector2d,new me.Vector2d,new me.Vector2d]},canRender:function(e){return"hexagonal"===e.orientation&&this._super(me.TMXRenderer,"canRender",[e])},getBounds:function(e){var t=e instanceof me.TMXLayer?me.pool.pull("me.Rect",0,0,0,0):this.bounds;return t.pos.set(0,0),this.staggerX?(t.resize(this.cols*this.columnwidth+this.sideoffsetx,this.rows*(this.tileheight+this.sidelengthy)),t.width>1&&(t.height+=this.rowheight)):(t.resize(this.cols*(this.tilewidth+this.sidelengthx),this.rows*this.rowheight+this.sideoffsety),t.height>1&&(t.width+=this.columnwidth)),t},doStaggerX:function(e){return this.staggerX&&1&e^this.staggerEven},doStaggerY:function(e){return!this.staggerX&&1&e^this.staggerEven},topLeft:function(e,t,i){var n=i||new me.Vector2d;return this.staggerX?1&e^this.staggerEven?n.set(e-1,t):n.set(e-1,t-1):1&t^this.staggerEven?n.set(e,t-1):n.set(e-1,t-1),n},topRight:function(e,t,i){var n=i||new me.Vector2d;return this.staggerX?1&e^this.staggerEven?n.set(e+1,t):n.set(e+1,t-1):1&t^this.staggerEven?n.set(e+1,t-1):n.set(e,t-1),n},bottomLeft:function(e,t,i){var n=i||new me.Vector2d;return this.staggerX?1&e^this.staggerEven?n.set(e-1,t+1):n.set(e-1,t):1&t^this.staggerEven?n.set(e,t+1):n.set(e-1,t+1),n},bottomRight:function(e,t,i){var n=i||new me.Vector2d;return this.staggerX?1&e^this.staggerEven?n.set(e+1,t+1):n.set(e+1,t):1&t^this.staggerEven?n.set(e+1,t+1):n.set(e,t+1),n},pixelToTileCoords:function(e,t,i){var n=i||new me.Vector2d;this.staggerX?e-=this.staggerEven?this.tilewidth:this.sideoffsetx:t-=this.staggerEven?this.tileheight:this.sideoffsety;var r,s,o,a,h=me.pool.pull("me.Vector2d",Math.floor(e/(2*this.columnwidth)),Math.floor(t/(2*this.rowheight))),l=me.pool.pull("me.Vector2d",e-h.x*(2*this.columnwidth),t-h.y*(2*this.rowheight));this.staggerX?(h.x=2*h.x,this.staggerEven&&++h.x):(h.y=2*h.y,this.staggerEven&&++h.y),this.staggerX?(o=(r=this.sidelengthx/2)+this.columnwidth,a=this.tileheight/2,this.centers[0].set(r,a),this.centers[1].set(o,a-this.rowheight),this.centers[2].set(o,a+this.rowheight),this.centers[3].set(o+this.columnwidth,a)):(s=this.sidelengthy/2,o=this.tilewidth/2,a=s+this.rowheight,this.centers[0].set(o,s),this.centers[1].set(o-this.columnwidth,a),this.centers[2].set(o+this.columnwidth,a),this.centers[3].set(o,a+this.rowheight));for(var u=0,c=Number.MAX_VALUE,d=0;d<4;++d){var f=this.centers[d].sub(l).length2();f<c&&(c=f,u=d)}var p=this.staggerX?offsetsStaggerX:offsetsStaggerY;return n.set(h.x+p[u].x,h.y+p[u].y),me.pool.push(h),me.pool.push(l),n},tileToPixelCoords:function(e,t,i){var n=Math.floor(e),r=Math.floor(t),s=i||new me.Vector2d;return this.staggerX?(s.y=r*(this.tileheight+this.sidelengthy),this.doStaggerX(n)&&(s.y+=this.rowheight),s.x=n*this.columnwidth):(s.x=n*(this.tilewidth+this.sidelengthx),this.doStaggerY(r)&&(s.x+=this.columnwidth),s.y=r*this.rowheight),s},adjustPosition:function(e){"number"==typeof e.gid&&(e.y-=e.height)},drawTile:function(e,t,i,n){var r=n.tileset,s=this.tileToPixelCoords(t,i,me.pool.pull("me.Vector2d"));r.drawTile(e,r.tileoffset.x+s.x,r.tileoffset.y+s.y+(this.tileheight-r.tileheight),n),me.pool.push(s)},drawTileLayer:function(e,t,i){var n,r=this.pixelToTileCoords(i.pos.x,i.pos.y,me.pool.pull("me.Vector2d"));r.sub(t.pos);var s=this.tileToPixelCoords(r.x+t.pos.x,r.y+t.pos.y,me.pool.pull("me.Vector2d")),o=r.clone(),a=s.clone(),h=i.pos.y-s.y<this.sideoffsety,l=i.pos.x-s.x<this.sideoffsetx;h&&r.y--,l&&r.x--;var u=t.cols,c=t.rows;if(this.staggerX){r.x=Math.max(0,r.x),r.y=Math.max(0,r.y),s=this.tileToPixelCoords(r.x+t.pos.x,r.y+t.pos.y);for(var d=this.doStaggerX(r.x+t.pos.x);s.y<i.bottom&&r.y<c;){for(o.setV(r),a.setV(s);a.x<i.right&&o.x<u;o.x+=2)(n=t.cellAt(o.x,o.y,!1))&&n.tileset.drawTile(e,a.x,a.y,n),a.x+=this.tilewidth+this.sidelengthx;d?(r.x-=1,r.y+=1,s.x-=this.columnwidth,d=!1):(r.x+=1,s.x+=this.columnwidth,d=!0),s.y+=this.rowheight}me.pool.push(o),me.pool.push(a)}else{for(r.x=Math.max(0,r.x),r.y=Math.max(0,r.y),s=this.tileToPixelCoords(r.x+t.pos.x,r.y+t.pos.y),this.doStaggerY(r.y)&&(s.x-=this.columnwidth);s.y<i.bottom&&r.y<c;r.y++){for(o.setV(r),a.setV(s),this.doStaggerY(r.y)&&(a.x+=this.columnwidth);a.x<i.right&&o.x<u;o.x++)(n=t.cellAt(o.x,o.y,!1))&&n.tileset.drawTile(e,a.x,a.y,n),a.x+=this.tilewidth+this.sidelengthx;s.y+=this.rowheight}me.pool.push(o),me.pool.push(a)}me.pool.push(r),me.pool.push(s)}}),me.TMXStaggeredRenderer=me.TMXHexagonalRenderer.extend({canRender:function(e){return"staggered"===e.orientation&&this._super(me.TMXRenderer,"canRender",[e])},pixelToTileCoords:function(e,t,i){var n=i||new me.Vector2d,r=e,s=t;this.staggerX?r-=this.staggerEven?this.sideoffsetx:0:s-=this.staggerEven?this.sideoffsety:0;var o=me.pool.pull("me.Vector2d",Math.floor(r/this.tilewidth),Math.floor(s/this.tileheight));this.staggerX?(o.x=2*o.x,this.staggerEven&&++o.x):(o.y=2*o.y,this.staggerEven&&++o.y);var a=me.pool.pull("me.Vector2d",r-o.x*this.tilewidth,s-o.y*this.tileheight),h=a.x*(this.tileheight/this.tilewidth);return this.sideoffsety-h>a.y&&(o=this.topLeft(o.x,o.y,o)),-this.sideoffsety+h>a.y&&(o=this.topRight(o.x,o.y,o)),this.sideoffsety+h<a.y&&(o=this.bottomLeft(o.x,o.y,o)),3*this.sideoffsety-h<a.y&&(o=this.bottomRight(o.x,o.y,o)),(n=this.tileToPixelCoords(o.x,o.y,n)).set(e-n.x,t-n.y),n.set(n.x-this.tilewidth/2,n.y*(this.tilewidth/this.tileheight)),n.div(this.tilewidth/Math.sqrt(2)).rotate(me.Math.degToRad(-45)).add(o),me.pool.push(o),me.pool.push(a),n}}),me.Tween=function(e){var t=null,i=null,n=null,r=null,s=null,o=null,a=null,h=null,l=null,u=null,c=null,d=null,f=null,p=null,m=null,g=null,v=null;this.isRenderable=!1,this._resumeCallback=function(e){l&&(l+=e)},this.setProperties=function(e){for(var y in t=e,i={},n={},r={},s=1e3,o=0,a=!1,h=0,l=null,u=me.Tween.Easing.Linear.None,c=me.Tween.Interpolation.Linear,d=[],f=null,p=!1,m=null,g=null,v=me.timer.lastUpdate,this.isPersistent=!1,this.updateWhenPaused=!1,e)"object"!==_typeof(e)&&(i[y]=parseFloat(e[y]))},this.setProperties(e),this.onResetEvent=function(e){this.setProperties(e)},this.onActivateEvent=function(){me.event.subscribe(me.event.STATE_RESUME,this._resumeCallback)},this.onDeactivateEvent=function(){me.event.unsubscribe(me.event.STATE_RESUME,this._resumeCallback)},this.to=function(e,t){return void 0!==t&&(s=t),n=e,this},this.start=function(e){for(var s in p=!1,me.game.world.addChild(this),l=(void 0===e?me.timer.getTime():e)+h,n){if(n[s]instanceof Array){if(0===n[s].length)continue;n[s]=[t[s]].concat(n[s])}i[s]=t[s],i[s]instanceof Array==0&&(i[s]*=1),r[s]=i[s]||0}return this},this.stop=function(){return me.game.world.removeChildNow(this),this},this.delay=function(e){return h=e,this},this.repeat=function(e){return o=e,this},this.yoyo=function(e){return a=e,this},this.easing=function(e){if("function"!=typeof e)throw new Error("invalid easing function for me.Tween.easing()");return u=e,this},this.interpolation=function(e){return c=e,this},this.chain=function(){return d=arguments,this},this.onStart=function(e){return f=e,this},this.onUpdate=function(e){return m=e,this},this.onComplete=function(e){return g=e,this},this.update=function(e){var y,_=v=me.timer.lastUpdate>v?me.timer.lastUpdate:v+e;if(_<l)return!0;!1===p&&(null!==f&&f.call(t),p=!0);var x=(_-l)/s,w=u(x=x>1?1:x);for(y in n){var b=i[y]||0,T=n[y];T instanceof Array?t[y]=c(T,w):("string"==typeof T&&(T=b+parseFloat(T)),"number"==typeof T&&(t[y]=b+(T-b)*w))}if(null!==m&&m.call(t,w),1===x){if(o>0){for(y in isFinite(o)&&o--,r){if("string"==typeof n[y]&&(r[y]=r[y]+parseFloat(n[y])),a){var A=r[y];r[y]=n[y],n[y]=A}i[y]=r[y]}return l=_+h,!0}me.game.world.removeChildNow(this),null!==g&&g.call(t);for(var E=0,S=d.length;E<S;E++)d[E].start(_);return!1}return!0}},me.Tween.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}},Back:{In:function(e){var t=1.70158;return e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-me.Tween.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*me.Tween.Easing.Bounce.In(2*e):.5*me.Tween.Easing.Bounce.Out(2*e-1)+.5}}},me.Tween.Interpolation={Linear:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),s=me.Tween.Interpolation.Utils.Linear;return t<0?s(e[0],e[1],n):t>1?s(e[i],e[i-1],i-n):s(e[r],e[r+1>i?i:r+1],n-r)},Bezier:function(e,t){var i,n=0,r=e.length-1,s=Math.pow,o=me.Tween.Interpolation.Utils.Bernstein;for(i=0;i<=r;i++)n+=s(1-t,r-i)*s(t,i)*e[i]*o(r,i);return n},CatmullRom:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),s=me.Tween.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(t<0&&(r=Math.floor(n=i*(1+t))),s(e[(r-1+i)%i],e[r],e[(r+1)%i],e[(r+2)%i],n-r)):t<0?e[0]-(s(e[0],e[0],e[1],e[1],-n)-e[0]):t>1?e[i]-(s(e[i],e[i],e[i-1],e[i-1],n-i)-e[i]):s(e[r?r-1:0],e[r],e[i<r+1?i:r+1],e[i<r+2?i:r+2],n-r)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=me.Tween.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:(a=[1],function(e){var t,i=1;if(a[e])return a[e];for(t=e;t>1;t--)i*=t;return a[e]=i}),CatmullRom:function(e,t,i,n,r){var s=.5*(i-e),o=.5*(n-t),a=r*r;return(2*t-2*i+s+o)*(r*a)+(-3*t+3*i-2*s-o)*a+s*r+t}}},me.plugins={},me.plugin=((singleton={}).Base=me.Object.extend({init:function(){this.version="8.0.1"}}),singleton.patch=function(e,t,i){if(void 0!==e.prototype&&(e=e.prototype),"function"!=typeof e[t])throw new Error(t+" is not an existing function");var n=e[t];Object.defineProperty(e,t,{configurable:!0,value:function(e,t){return function(){this._patched=n;var e=t.apply(this,arguments);return this._patched=null,e}}(0,i)})},singleton.register=function(e,t){if(me.plugin[t])throw new Error("plugin "+t+" already registered");var i=[];arguments.length>2&&(i=Array.prototype.slice.call(arguments,1)),i[0]=e;var n=new(e.bind.apply(e,i));if(void 0===n||!(n instanceof me.plugin.Base))throw new Error("Plugin should extend the me.plugin.Base Class !");if(me.utils.checkVersion(n.version)>0)throw new Error("Plugin version mismatch, expected: "+n.version+", got: "+me.version);me.plugins[t]=n},singleton),me.DraggableEntity=(Entity=me.Entity,Input=me.input,Event=me.event,Vector=me.Vector2d,Entity.extend({init:function(e,t,i){this._super(Entity,"init",[e,t,i]),this.dragging=!1,this.dragId=null,this.grabOffset=new Vector(0,0),this.onPointerEvent=Input.registerPointerEvent,this.removePointerEvent=Input.releasePointerEvent,this.initEvents()},initEvents:function(){var e=this;this.mouseDown=function(e){this.translatePointerEvent(e,Event.DRAGSTART)},this.mouseUp=function(e){this.translatePointerEvent(e,Event.DRAGEND)},this.onPointerEvent("pointerdown",this,this.mouseDown.bind(this)),this.onPointerEvent("pointerup",this,this.mouseUp.bind(this)),this.onPointerEvent("pointercancel",this,this.mouseUp.bind(this)),Event.subscribe(Event.POINTERMOVE,this.dragMove.bind(this)),Event.subscribe(Event.DRAGSTART,(function(t,i){i===e&&e.dragStart(t)})),Event.subscribe(Event.DRAGEND,(function(t,i){i===e&&e.dragEnd(t)}))},translatePointerEvent:function(e,t){Event.publish(t,[e,this])},dragStart:function(e){if(!1===this.dragging)return this.dragging=!0,this.grabOffset.set(e.gameX,e.gameY),this.grabOffset.sub(this.pos),!1},dragMove:function(e){!0===this.dragging&&(this.pos.set(e.gameX,e.gameY,this.pos.z),this.pos.sub(this.grabOffset))},dragEnd:function(){if(!0===this.dragging)return this.dragging=!1,!1},destroy:function(){Event.unsubscribe(Event.POINTERMOVE,this.dragMove),Event.unsubscribe(Event.DRAGSTART,this.dragStart),Event.unsubscribe(Event.DRAGEND,this.dragEnd),this.removePointerEvent("pointerdown",this),this.removePointerEvent("pointerup",this)}})),me.DroptargetEntity=function(e,t){return e.extend({init:function(i,n,r){this.CHECKMETHOD_OVERLAP="overlaps",this.CHECKMETHOD_CONTAINS="contains",this.checkMethod=null,this._super(e,"init",[i,n,r]),t.subscribe(t.DRAGEND,this.checkOnMe.bind(this)),this.checkMethod=this[this.CHECKMETHOD_OVERLAP]},setCheckMethod:function(e){void 0!==this[e]&&(this.checkMethod=this[e])},checkOnMe:function(e,t){t&&this.checkMethod(t.getBounds())&&this.drop(t)},drop:function(){},destroy:function(){t.unsubscribe(t.DRAGEND,this.checkOnMe)}})}(me.Entity,me.event),me.CollectableEntity=me.Entity.extend({init:function(e,t,i){this._super(me.Entity,"init",[e,t,i]),this.body.collisionType=me.collision.types.COLLECTABLE_OBJECT}}),me.LevelEntity=me.Entity.extend({init:function(e,t,i){this._super(me.Entity,"init",[e,t,i]),this.nextlevel=i.to,this.fade=i.fade,this.duration=i.duration,this.fading=!1,this.name="levelEntity",this.gotolevel=i.to,this.loadLevelSettings={},["container","onLoaded","flatten","setViewportBounds"].forEach(function(e){void 0!==i[e]&&(this.loadLevelSettings[e]=i[e])}.bind(this)),this.body.collisionType=me.collision.types.ACTION_OBJECT},getlevelSettings:function(){return"string"==typeof this.loadLevelSettings.container&&(this.loadLevelSettings.container=me.game.world.getChildByName(this.loadLevelSettings.container)[0]),this.loadLevelSettings},onFadeComplete:function(){me.levelDirector.loadLevel(this.gotolevel,this.getlevelSettings()),me.game.viewport.fadeOut(this.fade,this.duration)},goTo:function(e){this.gotolevel=e||this.nextlevel,this.fade&&this.duration?this.fading||(this.fading=!0,me.game.viewport.fadeIn(this.fade,this.duration,this.onFadeComplete.bind(this))):me.levelDirector.loadLevel(this.gotolevel,this.getlevelSettings())},onCollision:function(){return"levelEntity"===this.name&&this.goTo.apply(this),!1}}),canvas=me.video.createCanvas(1,1),(context=canvas.getContext("2d")).fillStyle="#fff",context.fillRect(0,0,1,1),pixel=canvas,me.ParticleEmitterSettings={width:0,height:0,image:pixel,totalParticles:50,angle:Math.PI/2,angleVariation:0,minLife:1e3,maxLife:3e3,speed:2,speedVariation:1,minRotation:0,maxRotation:0,minStartScale:1,maxStartScale:1,minEndScale:0,maxEndScale:0,gravity:0,wind:0,followTrajectory:!1,textureAdditive:!1,onlyInViewport:!0,floating:!1,maxParticles:10,frequency:100,duration:1/0,framesToSkip:0},me.ParticleEmitter=me.Rect.extend({init:function(e,t,i){this._stream=!1,this._frequencyTimer=0,this._durationTimer=0,this._enabled=!1,this.isRenderable=!1,this._super(me.Rect,"init",[e,t,1/0,1/0]),this.autoSort=!1,this.container=new me.ParticleContainer(this),Object.defineProperty(this.pos,"z",{get:function(){return this.container.pos.z}.bind(this),set:function(e){this.container.pos.z=e}.bind(this),enumerable:!0,configurable:!0}),Object.defineProperty(this,"floating",{get:function(){return this.container.floating},set:function(e){this.container.floating=e},enumerable:!0,configurable:!0}),this.reset(i)},onActivateEvent:function(){this.ancestor.addChild(this.container),this.container.pos.z=this.pos.z,this.ancestor.autoSort||this.ancestor.sort()},onDeactivateEvent:function(){this.ancestor.hasChild(this.container)&&this.ancestor.removeChildNow(this.container)},destroy:function(){this.reset()},getRandomPointX:function(){return this.pos.x+me.Math.randomFloat(0,this.width)},getRandomPointY:function(){return this.pos.y+me.Math.randomFloat(0,this.height)},reset:function(e){e=e||{};var t=me.ParticleEmitterSettings,i="number"==typeof e.width?e.width:t.width,n="number"==typeof e.height?e.height:t.height;this.resize(i,n),Object.assign(this,t,e),this.container.reset()},addParticles:function(e){for(var t=0;t<~~e;t++){var i=me.pool.pull("me.Particle",this);this.container.addChild(i)}},isRunning:function(){return this._enabled&&this._stream},streamParticles:function(e){this._enabled=!0,this._stream=!0,this.frequency=Math.max(this.frequency,1),this._durationTimer="number"==typeof e?e:this.duration},stopStream:function(){this._enabled=!1},burstParticles:function(e){this._enabled=!0,this._stream=!1,this.addParticles("number"==typeof e?e:this.totalParticles),this._enabled=!1},update:function(e){if(this._enabled&&this._stream){if(this._durationTimer!==1/0&&(this._durationTimer-=e,this._durationTimer<=0))return this.stopStream(),!1;this._frequencyTimer+=e;var t=this.container.children.length;t<this.totalParticles&&this._frequencyTimer>=this.frequency&&(t+this.maxParticles<=this.totalParticles?this.addParticles(this.maxParticles):this.addParticles(this.totalParticles-t),this._frequencyTimer=0)}return!0}}),me.ParticleContainer=me.Container.extend({init:function(e){this._super(me.Container,"init",[me.game.viewport.pos.x,me.game.viewport.pos.y,me.game.viewport.width,me.game.viewport.height]),this.autoSort=!1,this._updateCount=0,this._dt=0,this._emitter=e,this.autoTransform=!1,this.anchorPoint.set(0,0),this.isKinematic=!0},update:function(e){if(++this._updateCount>this._emitter.framesToSkip&&(this._updateCount=0),this._updateCount>0)return this._dt+=e,!1;e+=this._dt,this._dt=0;for(var t=me.game.viewport,i=this.children.length-1;i>=0;--i){var n=this.children[i];n.inViewport=t.isVisible(n,this.floating),n.update(e)||this.removeChildNow(n)}return!0},draw:function(e,t){if(this.children.length>0){var i,n=e.getContext();this._emitter.textureAdditive&&(i=n.globalCompositeOperation,n.globalCompositeOperation="lighter"),this._super(me.Container,"draw",[e,t]),this._emitter.textureAdditive&&(n.globalCompositeOperation=i)}}}),me.Particle=me.Renderable.extend({init:function(e){this._super(me.Renderable,"init",[e.getRandomPointX(),e.getRandomPointY(),e.image.width,e.image.height]),this.alwaysUpdate=!0,this.image=e.image;var t=e.angle+(e.angleVariation>0?(me.Math.randomFloat(0,2)-1)*e.angleVariation:0),i=e.speed+(e.speedVariation>0?(me.Math.randomFloat(0,2)-1)*e.speedVariation:0);this.vel=new me.Vector2d(i*Math.cos(t),-i*Math.sin(t)),this.life=me.Math.randomFloat(e.minLife,e.maxLife),this.startLife=this.life,this.startScale=me.Math.clamp(me.Math.randomFloat(e.minStartScale,e.maxStartScale),e.minStartScale,e.maxStartScale),this.endScale=me.Math.clamp(me.Math.randomFloat(e.minEndScale,e.maxEndScale),e.minEndScale,e.maxEndScale),this.gravity=e.gravity,this.wind=e.wind,this.followTrajectory=e.followTrajectory,this.onlyInViewport=e.onlyInViewport,this.pos.z=e.z,this._deltaInv=me.timer.maxfps/1e3,e.followTrajectory||(this.angle=me.Math.randomFloat(e.minRotation,e.maxRotation))},update:function(e){var t=e*this._deltaInv;this.life=this.life>e?this.life-e:0;var i=this.life/this.startLife,n=this.startScale;this.startScale>this.endScale?n=(n*=i)<this.endScale?this.endScale:n:this.startScale<this.endScale&&(n=(n/=i)>this.endScale?this.endScale:n),this.alpha=i,this.vel.x+=this.wind*t,this.vel.y+=this.gravity*t;var r=this.followTrajectory?Math.atan2(this.vel.y,this.vel.x):this.angle;return this.pos.x+=this.vel.x*t,this.pos.y+=this.vel.y*t,this.currentTransform.setTransform(n,0,0,0,n,0,this.pos.x,this.pos.y,1).rotate(r),(this.inViewport||!this.onlyInViewport)&&this.life>0},preDraw:function(e){e.save(),e.setGlobalAlpha(e.globalAlpha()*this.alpha),e.transform(this.currentTransform)},draw:function(e){var t=this.width,i=this.height;e.drawImage(this.image,0,0,t,i,-t/2,-i/2,t,i)}}),me.device.getPixelRatio=function(){return me.utils.deprecated("me.device.getPixelRatio()","me.device.devicePixelRatio","5.1.0"),me.device.devicePixelRatio},me.Font=me.Text.extend({init:function(e,t,i,n){var r={font:e,size:t,fillStyle:i,textAlign:n};this._super(me.Text,"init",[0,0,r]),me.utils.deprecated("me.Font","me.Text","6.1.0")},setFont:function(e,t,i,n){return void 0!==i&&this.fillStyle.copy(i),void 0!==n&&(this.textAlign=n),this._super(me.Text,"setFont",[e,t])}}),me.BitmapFontData=me.BitmapTextData,me.BitmapFont=me.BitmapText.extend({init:function(e,t,i,n,r){var s={font:t,fontData:e,size:i,textAlign:n,textBaseline:r};this._super(me.BitmapText,"init",[0,0,s]),me.utils.deprecated("me.BitmapFont","me.BitmapText","6.1.0")}}),me.ScreenObject=me.Stage.extend({init:function(e){this._super(me.Stage,"init",e),me.utils.deprecated("me.ScreenObject","me.Stage","6.2.0")}}),me.Renderer.prototype.drawShape=function(){me.utils.deprecated("drawShape()","the stroke() or fill()","6.3.0"),me.Renderer.prototype.stroke.apply(this,arguments)},me.CanvasRenderer.prototype.Texture=me.Renderer.prototype.Texture,me.WebGLRenderer.prototype.Texture=me.Renderer.prototype.Texture,me.video.getPos=function(){return me.utils.deprecated("me.video.getPos()","me.device.getElementBounds(me.video.renderer.getScreenCanvas());","7.0.0"),me.device.getElementBounds(me.video.renderer.getScreenCanvas())},me.Error=me.Object.extend.bind(Error)({init:function(e){this.name="me.Error",this.message=e}}),me.sys.checkVersion=function(e,t){return me.utils.deprecated("me.sys.checkVersion()","me.utils.checkVersion()","7.1.0"),me.utils.checkVersion(e,t)},Object.defineProperty(me.game,"HASH",{get:function(){return me.utils.deprecated("me.game.HASH","me.utils.getUriFragment()","7.1.0"),me.utils.getUriFragment()},configurable:!1}),me.video.updateDisplaySize=function(e,t){return me.utils.deprecated("me.video.updateDisplaySize()","me.video.scale()","7.1.0"),me.video.scale(e,t)},me.Renderer.prototype.scaleCanvas=function(e,t){return me.utils.deprecated("scaleCanvas()","me.video.scale()","7.1.0"),me.video.scale(e,t)},me.Entity.prototype.distanceToPoint=function(e){return me.utils.deprecated("distanceToPoint()","me.Renderable.distanceTo()","7.1.0"),this.distanceTo(e)},me.Entity.prototype.angleToPoint=function(e){return me.utils.deprecated("angleToPoint()","me.Renderable.angleTo()","7.1.0"),this.angleTo(e)},Object.defineProperty(me.sys,"gravity",{get:function(){return me.utils.deprecated("me.sys.gravity","me.game.world.gravity","8.0.0"),me.game.world?me.game.world.gravity.y:void 0},set:function(e){me.utils.deprecated("me.sys.gravity","me.game.world.gravity","8.0.0"),me.game.world&&(me.game.world.gravity.y=e)},configurable:!1}),me.WebGLRenderer.Compositor=me.WebGLCompositor,me.WebGLRenderer.Compositor.prototype.drawTriangle=function(e,t,i){var n=this.gl;this.drawVertices(!0===i?n.TRIANGLE_STRIP:n.TRIANGLES,e,t),me.utils.deprecated("drawTriangle()","drawVertices()","8.0.0")},me.WebGLRenderer.Compositor.prototype.drawLine=function(e,t,i){var n=this.gl;this.drawVertices(!0===i?n.LINE_STRIP:n.LINE_LOOP,e,t),me.utils.deprecated("drawLine()","drawVertices()","8.0.0")},Object.defineProperty(me.sys,"scale",{get:function(){return me.utils.deprecated("me.sys.scale","me.video.scaleRatio","8.0.0"),me.video.scaleRatio},configurable:!1}),me.video.getWrapper=function(){return me.utils.deprecated("me.video.getWrapper()","me.device.getParent()","8.0.0"),me.video.getParent()},Object.defineProperty(me.sys,"fps",{get:function(){return me.utils.deprecated("me.sys.fps","me.timer.maxfps","8.0.0"),me.timer.maxfps},set:function(e){me.utils.deprecated("me.sys.fps","me.timer.maxfps","8.0.0"),me.timer.maxfps=e},configurable:!1}),Object.defineProperty(me.sys,"updatesPerSecond",{get:function(){return me.utils.deprecated("me.sys.updatesPerSecond","me.game.world.fps","8.0.0"),me.game.world.fps},set:function(e){me.utils.deprecated("me.sys.updatesPerSecond","me.game.world.fps","8.0.0"),me.game.world.fps=e},configurable:!1}),Object.defineProperty(me.sys,"interpolation",{get:function(){return me.utils.deprecated("me.sys.interpolation","me.timer.interpolation","8.0.0"),me.timer.interpolation},set:function(e){me.utils.deprecated("me.sys.interpolation","me.timer.interpolation","8.0.0"),me.timer.interpolation=e},configurable:!1}),me.Body.prototype.addShapesFromJSON=function(e,t){return me.utils.deprecated("addShapesFromJSON()","fromJSON()","8.0.0"),this.fromJSON(e,t)}})();